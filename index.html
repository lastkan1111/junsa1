<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<title>ê°€ë¡œí˜• RPG - ìë™ì‚¬ëƒ¥ + í† ë¼ ì „íˆ¬ (v3)</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Gowun+Batang:wght@400;700;800&family=Black+Han+Sans&display=swap');
  html,body{margin:0;padding:0;width:100%;height:100%;background:#000;overflow:hidden;touch-action:none;}
  

/* âœ… í…ìŠ¤íŠ¸ ë“œë˜ê·¸(íŒŒë€ í•˜ì´ë¼ì´íŠ¸) ë°©ì§€: ê²Œì„ UI ì „ì²´ ì„ íƒ ê¸ˆì§€ */
body, canvas, button, .ui, #statPanel, #invPanel, #statHud, #twChatHud, #chatToggleBtn, #titleOverlay{
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}
/* ë“œë˜ê·¸ ì„ íƒ/ë¡±íƒ­ í•˜ì´ë¼ì´íŠ¸(ëª¨ë°”ì¼)ë„ ìµœì†Œí™” */
*{ -webkit-tap-highlight-color: transparent; }
/* ì…ë ¥ì°½ì´ ìƒê¸°ë©´ ê±°ê¸´ ì„ íƒ í—ˆìš© */
input, textarea{
  -webkit-user-select: text;
  -moz-user-select: text;
  -ms-user-select: text;
  user-select: text;
}

  canvas{display:block;width:100vw;height:100vh;image-rendering:pixelated;image-rendering:crisp-edges;}

  /* === TITLE OVERLAY === */
  .titleOverlay{
    position:fixed; inset:0;
    background:rgba(0,0,0,0.92); /* ë¶ˆíˆ¬ëª…ì— ê°€ê¹ê²Œ */
    display:flex; align-items:center; justify-content:center;
    z-index:9999;
  }
  .titleCard{
    width:min(520px, 92vw);
    display:flex; flex-direction:column; align-items:center; gap:18px;
    padding:24px 18px;
  }
  .gameTitle{
    color:#fff;
    font:800 clamp(34px, 6vw, 56px)/1.05 system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
    letter-spacing:-0.02em;
    text-shadow:0 6px 24px rgba(0,0,0,.55);
  }
  .startBtn{
    appearance:none; border:none; cursor:pointer;
    padding:14px 22px;
    width:min(320px, 78vw);
    border-radius:16px;
    color:#fff;
    font:700 18px/1 system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
    background:rgba(255,255,255,0.08);
    outline:2px solid rgba(255,255,255,0.16);
    box-shadow:0 10px 30px rgba(0,0,0,.35);
    transition:transform .08s ease, outline-color .12s ease, background .12s ease;
  }
  .startBtn:hover{
    background:rgba(255,255,255,0.12);
    outline-color:rgba(255,255,255,0.28);
  }
  .startBtn:active{ transform:translateY(1px) scale(0.99); }
  .startBtn:focus-visible{
    outline-color:rgba(120,220,255,0.75);
    box-shadow:0 0 0 4px rgba(120,220,255,0.25), 0 10px 30px rgba(0,0,0,.35);
  }
  .hint{
    color:rgba(255,255,255,0.65);
    font:500 13px/1.35 system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
    text-align:center;
  }

  
/* === TITLE IMAGE (MAX SIZE) === */
.titleImage{
  width: min(92vw, 1100px);   /* ë°ìŠ¤í¬íƒ‘ì—ì„œë„ í¬ê²Œ */
  max-height: 70vh;           /* í™”ë©´ì„ ë„˜ì§€ ì•Šê²Œ */
  height: auto;
  display: block;
  margin-bottom: 14px;
  image-rendering: auto;
  object-fit: contain;        /* ë¹„ìœ¨ ìœ ì§€ */
}
@media (max-width: 520px){
  .titleImage{
    width: 100vw;        /* ëª¨ë°”ì¼ ê°€ë¡œ ê½‰ ì±„ì›€ */
    height: auto;
    max-height: 88vh;    /* ì„¸ë¡œ ê¸°ì¤€ ìµœëŒ€ */
    margin: 0 auto 12px;
    object-fit: contain;
  }
}
.ui{
    position:fixed;left:12px;top:10px;color:#eee;font:14px system-ui,sans-serif;
    background:rgba(0,0,0,.45);padding:8px 10px;border-radius:10px;user-select:none;
  }

    

  /* === TWITCH CHAT HUD (semi-transparent) === */
  #twChatHud{
    position:fixed;
    left:12px;
    bottom:12px;
    width:220px;
    height:360px;
    background:transparent;
    z-index:9000;
    pointer-events:auto;
    border-radius:12px;
    overflow:hidden;
  }
  #twChatHud iframe{
    width:100%;
    height:100%;
    border:0;
    background:transparent;
    opacity:0.85;            /* âœ… ëŒ€í‘œë‹˜ ìš”ì²­: ìµœëŒ€í•œ ë°˜íˆ¬ëª… */
  }
  

  /* âœ… UNUSED legacy twitch iframe (click-block bug fix) */
  .twitchChatIframe{
    display:none !important;
    position:fixed !important;
    left:-9999px !important;
    top:-9999px !important;
    width:0 !important;
    height:0 !important;
    border:0 !important;
    pointer-events:none !important;
  }

@media (max-width: 520px){
    #twChatHud{ left:10px; bottom:10px; width:200px; height:320px; }
  }

  /* âœ… TWITCH CHAT RESIZE HANDLE */
  #twChatHud{ box-sizing:border-box; }
  #twResizeHandle{
    position:absolute;
    right:32px;  top:6px;
    width:18px; height:18px;
    border-radius:6px;
    background:rgba(255,255,255,0.14);
    outline:1px solid rgba(255,255,255,0.22);
    box-shadow:0 6px 16px rgba(0,0,0,0.35);
    cursor:nwse-resize;
    pointer-events:auto;
    touch-action:none;
  }
  #twResizeHandle::before{
    content:"";
    position:absolute;
    right:4px;  top:4px;
    width:10px; height:10px;
    border-right:2px solid rgba(255,255,255,0.45);
    border-top:2px solid rgba(255,255,255,0.45);
    border-radius:2px;
    opacity:0.9;
  }


/* === VIRTUAL JOYSTICK (touch + mouse) === */
#joy{
  position:fixed; left:0; top:0; width:100%; height:100%;
  z-index:9500; pointer-events:none;
}
#joyBase, #joyKnob{
  position:absolute; border-radius:999px;
  transform:translate(-50%,-50%);
  display:none;
}
#joyBase{
  width:120px; height:120px;
  background:rgba(0,0,0,0.30);
  outline:2px solid rgba(255,255,255,0.18);
  backdrop-filter: blur(1px);
}
#joyKnob{
  width:58px; height:58px;
  background:rgba(255,255,255,0.10);
  outline:2px solid rgba(255,255,255,0.22);
}
@media (max-width: 520px){
  #joyBase{ width:108px; height:108px; }
  #joyKnob{ width:52px; height:52px; }
}


/* === CHAT TOGGLE BUTTON (always top-left-bottom over canvas) === */
#chatToggleBtn{
  position:fixed;
  left:12px;
  bottom:12px;
  z-index:9500;
  pointer-events:auto;
  appearance:none;
  border:none;
  cursor:pointer;
  padding:10px 12px;
  border-radius:14px;
  color:rgba(255,255,255,0.92);
  font:700 13px/1 system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
  background:rgba(0,0,0,0.40);
  outline:1px solid rgba(255,255,255,0.18);
  box-shadow:0 10px 24px rgba(0,0,0,0.40);
  backdrop-filter: blur(2px);
  -webkit-tap-highlight-color: transparent;
}
#chatToggleBtn:active{ transform: translateY(1px) scale(0.99); }
@media (max-width: 520px){
  #chatToggleBtn{ left:10px; bottom:10px; padding:9px 11px; font-size:12px; }
}

/* === CHAT COLLAPSE / EXPAND ANIMATION === */
#twChatHud{
  transform-origin: left bottom;
  transition: transform 260ms ease, opacity 260ms ease;
  will-change: transform, opacity;
}
#twChatHud.collapsed{
  opacity:0;
  transform: translate(-14px, 14px) scale(0.08);
  pointer-events:none; /* âœ… ì ‘íˆë©´ í´ë¦­ ì•ˆë¨ */
}
#twChatHud.collapsed #twResizeHandle{ display:none; }


/* === TOP-LEFT HP/MP HUD === */
#statHud{
  position:fixed;
  left:12px;
  top:16px; 
  z-index:9000;
  display:flex;
  flex-direction:column;
  gap:8px;
  pointer-events:none;
  user-select:none;
}
.hudBar{
  width:110px;
  height:11px;
  border-radius:8px;
  background:rgba(0,0,0,0.38);
  
  box-shadow:0 10px 22px rgba(0,0,0,0.35);
  overflow:hidden;backdrop-filter:blur(2px);
}
.hudFill{height:100%;width:100%;border-radius:8px;transform-origin:left center;}
.hudFill.hp{background:linear-gradient(90deg, rgba(255,70,70,0.92), rgba(255,120,120,0.85));}
.hudFill.mp{background:linear-gradient(90deg, rgba(80,150,255,0.92), rgba(130,190,255,0.85));}

.hudFill.exp{background:linear-gradient(90deg, rgba(255,210,80,0.95), rgba(255,235,150,0.9));}
.hudText{
  position:absolute; inset:0;
  color:rgba(255,255,255,0.92);
  font:700 9px/1 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
  letter-spacing:0.02em;
  text-shadow:0 2px 10px rgba(0,0,0,0.45);
}
.hudText .label{
  position:absolute; left:6px; top:50%; transform:translateY(-50%);
  white-space:nowrap;
}
.hudText .value{
  position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
  white-space:nowrap;
  font-variant-numeric: tabular-nums;
}

.hudBar.hp{ border:1px solid rgba(255,90,90,0.95); }
.hudBar.mp{ border:1px solid rgba(90,150,255,0.95); }
.hudBar.exp{ border:1px solid rgba(255,215,90,0.95); }


/* ìŠ¤íƒ¯ ë²„íŠ¼/íŒ¨ë„ CSS (ë³µë¶™) */
#statBtn {
  position: fixed;
  top: 10px;
  right: 12px;
  z-index: 1200;
  /* ìŠ¤ë¥´ë¥µ íš¨ê³¼ */
  transition: transform 0.55s cubic-bezier(.5,2,.4,1), opacity 0.25s;
  background: rgba(34, 36, 40, 0.55);
  color: #fff;
  font-size: 16px;
  font-family: 'Pretendard', 'GmarketSans', Arial, sans-serif;
  font-weight: bold;
  padding: 4px 16px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  box-shadow: 0 2px 8px #1115;
  letter-spacing: 0.5px;
  display: flex;
  align-items: center;
  gap: 7px;
  opacity: 0;
  transform: translateY(-120%); /* â˜…â˜… ìµœì´ˆì— ì™„ì „íˆ ìœ„ì— ìˆ¨ê¸°ê¸° */
}

#statBtn.show {
  opacity: 1;
  transform: translateY(0);     /* â˜…â˜… ì•„ë˜ë¡œ ìŠ¤ë¥´ë¥µ ë‚˜íƒ€ë‚¨ */
}

#statBtn:hover {
  filter: brightness(1.08);
  background: #53ac48;
}
#statBtn:active {
  filter: brightness(0.92);
}
#statBtn .icon {
  font-size: 20px;
  margin-right: 2px;
}
#statBtn .statText {
  color: #fff;
  font-weight: bold;
  font-size: 1em;
  letter-spacing: 0.5px;
}

/* ìŠ¤íƒ¯íŒ¨ë„ ë””ìì¸ */
#statPanel {
  position: fixed;
  top: 14px; 
  left: 14px; 
  transform: none; /* ì¤‘ì•™ì •ë ¬ í•´ì œ */
  width: 340px; height: 420px;
  background: linear-gradient(145deg, #263c25 80%, #1c2a1b 100%);
  border-radius: 18px;
  box-shadow: 0 4px 20px #111a;
  border: 2.5px solid #2a4b22;
  padding: 16px 18px 16px 18px;
  z-index: 10050;
  display: flex; flex-direction: column;
  font-family: 'Pretendard', 'GmarketSans', Arial, sans-serif;
  cursor: default;
  transition: box-shadow 0.15s, background 0.2s;

  /* âœ… ì¤‘ì•™ ê³ ì • + ë“œë˜ê·¸ ë¹„í™œì„± */
/* ì±„íŒ…/ì¡°ì´ìŠ¤í‹±ë³´ë‹¤ ìœ„ */
}

/* #statPanel.dragging {  (drag disabled) */
/*
  cursor: grabbing;
  box-shadow: 0 8px 36px #0a09;
  opacity: 0.97;
*/
#statPanel.hide {
  display: none !important;
}
.statHeader {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 11px;
}
.statPoint {
  color: #3ff8e5;
  font-size: 1.28em;
  font-weight: bold;
  letter-spacing: 1px;
}
.btn {
  font-size: 1em; font-weight: bold;
  padding: 5px 16px; border-radius: 6px; margin-left: 8px; border: none; cursor: pointer;
  box-shadow: 0 2px 8px #1115;
  transition: filter 0.1s;
}
.btn.close { background: #a3413d; color: #fff; }
.btn:active { filter: brightness(0.92); }
.statList {
  flex: 1; overflow-y: auto; background: #2228; border-radius: 10px; padding: 9px 6px 6px 6px;
  scrollbar-width: thin; scrollbar-color: #383 #181d16;
  user-select: none;
  cursor: default;
}
.statList::-webkit-scrollbar { width: 7px; background: #222; }
.statList::-webkit-scrollbar-thumb { background: #2a4b22; border-radius: 8px; }
.statRow {
  display: flex; align-items: center; justify-content: space-between;
  margin: 0 0 8px 0; background: #191f16da;
  border-radius: 7px; padding: 11px 10px 7px 12px;
  box-shadow: 0 1px 7px #2223;
  font-size: 1.18em;
}
.statInfo { flex: 1 1 65%; }
.statName { font-weight: bold; color: #f8ea6b; font-size: 1.13em; }
.statDesc { font-size: 0.93em; color: #7cff66; margin-top: 2px;}
.statCtrl { display: flex; align-items: center; gap: 6px;}
.statCtrl button {
  width: 40px; height: 38px; font-size: 1.22em; font-weight: bold; border-radius: 7px;
  border: none; background: #406d3a; color: #fff; cursor: pointer;
  margin: 0 2px;
  box-shadow: 0 2px 8px #2235;
  transition: filter 0.12s, background 0.16s;
}
.statCtrl button.plus { background: #38a058; }

.statCtrl button:active { filter: brightness(0.88);}

.statValue {
  width: 26px; text-align: center; font-weight: bold; color: #fff;
  background: #1a1f1e; border-radius: 4px; margin: 0 2px; font-size: 1.09em;
  pointer-events: none;
}


/* === ì¸ë²¤ ë²„íŠ¼ (ìŠ¤íƒ¯ ë²„íŠ¼ê³¼ ë™ì¼ ìŠ¤íƒ€ì¼) === */
#invBtn {
  position: fixed;
  top: 52px;              /* âœ… ìŠ¤íƒ¯ë²„íŠ¼ ë°”ë¡œ ì•„ë˜ */
  right: 12px;
  z-index: 1200;
  transition: transform 0.55s cubic-bezier(.5,2,.4,1), opacity 0.25s;
  background: rgba(34, 36, 40, 0.55);
  color: #fff;
  font-size: 16px;
  font-family: 'Pretendard', 'GmarketSans', Arial, sans-serif;
  font-weight: bold;
  padding: 4px 16px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  box-shadow: 0 2px 8px #1115;
  letter-spacing: 0.5px;
  display: flex;
  align-items: center;
  gap: 7px;
  opacity: 1;
  transform: translateY(0);
}
#invBtn:hover { filter: brightness(1.08); background: #53ac48; }
#invBtn:active { filter: brightness(0.92); }
#invBtn .icon { font-size: 20px; margin-right: 2px; }

/* === ì¥ë¹„ìƒíƒœ ë²„íŠ¼ (ì¸ë²¤ ë²„íŠ¼ê³¼ ë™ì¼ ìŠ¤íƒ€ì¼) === */
#equipStatusBtn {
  position: fixed;
  top: 94px;              /* âœ… ì¸ë²¤í† ë¦¬ ë²„íŠ¼ ë°”ë¡œ ì•„ë˜ */
  right: 12px;
  z-index: 1200;
  transition: transform 0.55s cubic-bezier(.5,2,.4,1), opacity 0.25s;
  background: rgba(34, 36, 40, 0.55);
  color: #fff;
  font-size: 16px;
  font-family: 'Pretendard', 'GmarketSans', Arial, sans-serif;
  font-weight: bold;
  padding: 4px 16px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  box-shadow: 0 2px 8px #1115;
  letter-spacing: 0.5px;
  display: flex;
  align-items: center;
  gap: 7px;
  opacity: 1;
  transform: translateY(0);
}
#equipStatusBtn:hover { filter: brightness(1.08); background: #53ac48; }
#equipStatusBtn:active { filter: brightness(0.92); }
#equipStatusBtn .icon { font-size: 20px; margin-right: 2px; }

/* === ì¥ë¹„ ìƒíƒœ íŒ¨ë„ (ì¸ë²¤ íŒ¨ë„ í¬ê¸° ë™ì¼) === */
#equipPanel{
  position: fixed;
  top: 14px;
  left: 14px;
  width: 340px;
  height: 420px;
  background: linear-gradient(145deg, #263c25 80%, #1c2a1b 100%);
  border-radius: 18px;
  box-shadow: 0 4px 20px #111a;
  border: 2.5px solid #2a4b22;
  padding: 16px 18px 16px 18px;
  z-index: 12100 !important; /* âœ… invPanelë³´ë‹¤ ìœ„ */
  display: flex;
  flex-direction: column;
  font-family: 'Pretendard', 'GmarketSans', Arial, sans-serif;
  pointer-events: auto; /* âœ… statHud(pointer-events:none) ì˜í–¥ ì°¨ë‹¨ */
}
#equipPanel.hide{display:none !important;}

.equipGrid{
  flex:1;
  margin-top: 10px;
  background: #2228;
  border-radius: 12px;
  padding: 12px;
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  grid-template-rows: repeat(4, 1fr);
  gap: 10px;
  box-shadow: inset 0 0 0 1px rgba(0,0,0,0.25);
  user-select:none;
}
.equipSlot{
  background: rgba(25,31,22,0.85);
  border-radius: 10px;
  border: 1.5px solid rgba(60,110,58,0.55);
  box-shadow: 0 2px 8px rgba(0,0,0,0.18);
  display:flex;
  align-items:center;
  justify-content:center;
  color: rgba(255,255,255,0.90);
  font-weight: 900;
  letter-spacing: 0.4px;
  font-size: 13px;
  position: relative;
  overflow: hidden;
  text-align:center;
  padding: 0 6px;
}
.equipSlot .sub{
  position:absolute;
  bottom:6px;
  left:6px;
  right:6px;
  font-size: 11px;
  font-weight: 800;
  color: rgba(200,255,200,0.88);
  text-shadow: 0 2px 10px rgba(0,0,0,0.45);
}
.equipSlot .badge{
  position:absolute;
  right:8px;
  top:6px;
  font-size: 12px;
  font-weight: 1000;
  padding: 2px 6px;
  border-radius: 999px;
  background: rgba(60,160,120,0.72);
  border: 1px solid rgba(255,255,255,0.15);
  color: rgba(255,255,255,0.95);
  text-shadow: 0 2px 10px rgba(0,0,0,0.45);
}

/* âœ… EQUIP SLOT ICON (keep slot layout, show only icon) */
.equipSlot.hasIcon .main,
.equipSlot.hasIcon .sub{ display:none !important; }
.equipSlot.hasIcon img.eqIcon{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
  pointer-events:none; /* í´ë¦­ì€ ìŠ¬ë¡¯ì´ ë°›ìŒ */
}

.equipFooter{
  margin-top: 10px;
  background: rgba(25,31,22,0.78);
  border: 1.5px solid rgba(60,110,58,0.45);
  border-radius: 12px;
  padding: 10px 12px;
  box-shadow: inset 0 0 0 1px rgba(0,0,0,0.18);
}
.equipFooter .line{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  font-weight: 900;
  letter-spacing: 0.2px;
  margin: 2px 0;
}
.equipFooter .k{ color: rgba(255,230,140,0.95); }
.equipFooter .v{ color: rgba(255,255,255,0.95); font-variant-numeric: tabular-nums; }


/* === ì¸ë²¤ íŒ¨ë„ (ìŠ¤íƒ¯íŒ¨ë„ ê°ì„± ê·¸ëŒ€ë¡œ) === */
#invPanel {
  position: fixed;
  top: 14px;
  left: 14px;
  width: 340px;
  height: 420px;
  background: linear-gradient(145deg, #263c25 80%, #1c2a1b 100%);
  border-radius: 18px;
  box-shadow: 0 4px 20px #111a;
  border: 2.5px solid #2a4b22;
  padding: 16px 18px 16px 18px;
  z-index: 12000 !important; /* ì±„íŒ…/ì¡°ì´ìŠ¤í‹±ë³´ë‹¤ ìœ„ */
  display: flex;
  flex-direction: column;
  font-family: 'Pretendard', 'GmarketSans', Arial, sans-serif;
}
#invPanel.hide { display:none !important; }

.invGrid{
  flex: 1;
  margin-top: 10px;
  background: #2228;
  border-radius: 12px;
  padding: 12px;
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  grid-template-rows: repeat(5, 1fr);
  gap: 10px;
  box-shadow: inset 0 0 0 1px rgba(0,0,0,0.25);
  user-select:none;
}
.invSlot{
  background: rgba(25,31,22,0.85);
  border-radius: 10px;
  border: 1.5px solid rgba(60,110,58,0.55);
  box-shadow: 0 2px 8px rgba(0,0,0,0.18);
  display:flex;
  align-items:center;
  justify-content:center;
  color: rgba(255,255,255,0.78);
  font-weight: 800;
  letter-spacing: 0.5px;
  font-size: 13px;
  position: relative;
  overflow: visible;
  text-align:center;
  padding: 0px;
}
.invSlot img{width:100%;height:100%;object-fit:cover;display:block;}
.invSlot.empty::after{
  content:"";
  position:absolute; inset:0;
  background: radial-gradient(circle at 30% 25%, rgba(255,255,255,0.08), transparent 55%);
  opacity: 0.85;
  pointer-events:none;
}
.invSlot .qty{
  position:absolute;
  right:8px;
  bottom:6px;
  font-size: 12px;
  font-weight: 900;
  color: rgba(255,255,255,0.92);
  text-shadow: 0 2px 10px rgba(0,0,0,0.55);
}



.invSlot .itemTip{
  position:absolute;
  left:50%;
  top:-8px;
  transform: translate(-50%, -100%);
  min-width: 110px;
  max-width: 180px;
  padding: 8px 10px;
  border-radius: 12px;

  font: 800 12px/1.25 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
  color: rgba(255,255,255,0.95);

  background: rgba(0,0,0,0.72);
  outline: 1px solid rgba(255,255,255,0.14);
  box-shadow: 0 12px 24px rgba(0,0,0,0.45);
  backdrop-filter: blur(3px);

  pointer-events:none;
  z-index: 9999;
  white-space: pre-line;
}
.equipSlot .itemTip{
  position:absolute;
  left:50%;
  top:-8px;
  transform: translate(-50%, -100%);
  min-width: 110px;
  max-width: 180px;
  padding: 8px 10px;
  border-radius: 12px;

  font: 800 12px/1.25 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
  color: rgba(255,255,255,0.95);

  background: rgba(0,0,0,0.72);
  outline: 1px solid rgba(255,255,255,0.14);
  box-shadow: 0 12px 24px rgba(0,0,0,0.45);
  backdrop-filter: blur(3px);

  pointer-events:none;
  z-index: 9999;
  white-space: pre-line;
}
.invPager{
  margin-top: 10px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap: 12px;
  user-select:none;
}
.invArrow{
  width: 34px;
  height: 28px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  background: rgba(255,255,255,0.08);
  outline: 1px solid rgba(255,255,255,0.14);
  box-shadow: 0 2px 10px rgba(0,0,0,0.28);
  color: rgba(255,255,255,0.9);
  font-weight: 900;
}
.invArrow:active{ transform: translateY(1px) scale(0.99); }
.invPageText{
  min-width: 88px;
  text-align:center;
  color: rgba(255,255,255,0.80);
  font-weight: 800;
  letter-spacing: 0.8px;
  font-size: 12px;
}

@media (max-width: 520px){
  #invPanel{ width: min(92vw, 340px); height: min(70vh, 420px); }
#invBtn{ top: 48px; right: 10px; }
}


/* === SKILL SLOTS HUD (3x3, bottom-right) === */
#skillHud{
  position:fixed;
  right:12px;
  bottom:12px;
  z-index:9200;
  display:grid;
  grid-template-columns: repeat(3, 70px);
  grid-template-rows: repeat(3, 70px);
  gap:8px;
  padding:0;               /* âœ… ë°”íƒ• ì œê±° */
  border-radius:0;         /* âœ… ë°”íƒ• ì œê±° */
  background: transparent; /* âœ… ë°”íƒ• ì œê±° */
  outline:none;            /* âœ… ë°”íƒ• ì œê±° */
  box-shadow:none;         /* âœ… ë°”íƒ• ì œê±° */
  backdrop-filter:none;    /* âœ… ë°”íƒ• ì œê±° */
  -webkit-tap-highlight-color: transparent;
  user-select:none;
  pointer-events:auto;
}
.skillSlot{
  width:70px; height:70px;          /* âœ… ì•„ë‹´í•˜ê²Œ */
  border-radius: 18px;              /* âœ… ëª¨ì„œë¦¬ ë‘¥ê·¼ ì •ì‚¬ê°í˜• */
  background: transparent;         /* âœ… ì•Œë§¹ì´ë§Œ (ë°”íƒ• ì œê±°) */
  outline: 3px solid rgba(255,255,255,0.42);
  box-shadow: inset 0 0 0 1px rgba(0,0,0,0.16), inset 0 0 0 2px rgba(255,255,255,0.08), 0 0 0 1px rgba(120,220,255,0.18), 0 10px 22px rgba(0,0,0,0.18);
  position:relative;
  overflow:hidden;
  cursor:pointer;
  transition: transform .08s ease, outline-color .12s ease, filter .12s ease;
}
.skillSlot:hover{ outline-color: rgba(120,220,255,0.70); }
.skillSlot:active{ transform: translateY(1px) scale(0.99); filter: brightness(0.95); }

.skillSlot .icon{
  position:absolute; inset:0;
  display:flex; align-items:center; justify-content:center;
  font:900 22px/1 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
  color: rgba(255,255,255,0.90);
  text-shadow: 0 2px 10px rgba(0,0,0,0.55);
  letter-spacing: 0.02em;
}
.skillSlot .key{
  position:absolute;
  left: 6px;
  top: 6px;
  font:900 9px/1 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
  color: rgba(255,255,255,0.85);
  background: transparent;          /* âœ… í‚¤ ë°”íƒ• ì œê±° */
  padding:0;
  border-radius:0;
  outline:none;
  box-shadow:none;
  text-shadow: 0 2px 10px rgba(0,0,0,0.65);
}
.skillSlot .cd{
  position:absolute; inset:0;
  background: rgba(200, 220, 255, 0.34);
  transform: translateY(100%);
  transition: transform .10s linear;
}
.skillSlot.onCooldown .cd{ transform: translateY(0%); }

.skillSlot .cdText{
  position:absolute;
  right:6px;
  bottom:6px;
  font:900 10px/1 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
  color: rgba(255,255,255,0.92);
  text-shadow: 0 2px 10px rgba(0,0,0,0.65);
}

/* ëª¨ë°”ì¼ì—ì„œ ì•½ê°„ ì‘ê²Œ */
@media (max-width: 520px){
  #skillHud{
    right:10px; bottom:10px;
    grid-template-columns: repeat(3, 64px);
    grid-template-rows: repeat(3, 64px);
    gap:7px;
  }
  .skillSlot{ width:64px; height:64px; border-radius:16px; }
}


/* === EQUIP MARK / BUTTON (dagger) === */
.invSlot .equipMark{
  position:absolute;
  left:6px;
  top:6px;
  width:22px;
  height:22px;
  border-radius:8px;
  display:flex;
  align-items:center;
  justify-content:center;
  font:900 12px/1 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
  color:rgba(255,255,255,0.95);
  background:rgba(80,160,255,0.22);
  outline:1px solid rgba(120,220,255,0.35);
  box-shadow:0 8px 18px rgba(0,0,0,0.30);
  pointer-events:none;
}
.invSlot .equipBtn{
  position:absolute;
  left:50%;
  bottom:6px;
  transform:translateX(-50%);
  appearance:none;
  border:none;
  cursor:pointer;
  padding:6px 10px;
  border-radius:10px;
  font:900 12px/1 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
  color:rgba(255,255,255,0.95);
  background:rgba(83,172,72,0.85);
  outline:1px solid rgba(255,255,255,0.18);
  box-shadow:0 10px 20px rgba(0,0,0,0.35);
}
.invSlot .equipBtn:active{ transform:translateX(-50%) translateY(1px) scale(0.99); filter:brightness(0.95); }


/* === ENHANCE BADGE (+n) === */
.invSlot .enhBadge{
  position:absolute;
  right:6px;
  top:6px;
  min-width:22px;
  height:22px;
  padding:0 6px;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  font:900 11px/1 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
  color:rgba(255,255,255,0.96);
  background:rgba(255,190,70,0.22);
  outline:1px solid rgba(255,220,140,0.42);
  box-shadow:0 8px 18px rgba(0,0,0,0.30);
  pointer-events:none;
}




/* === ENHANCE SLOT BADGE (+n) for Enhance Panel === */
.enhWSlot .enhBadge{
  position:absolute;
  right:6px;
  bottom:6px;               /* âœ… ì•„ë˜ë‹¨ì— í‘œì‹œ */
  min-width:22px;
  height:22px;
  padding:0 6px;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  font:900 11px/1 "Black Han Sans","Noto Sans KR",system-ui,sans-serif;
  color:rgba(255,255,255,0.96);
  background:rgba(0,0,0,0.55);
  outline:1px solid rgba(255,255,255,0.18);
  box-shadow:0 8px 18px rgba(0,0,0,0.30);
  pointer-events:none;
}
/* === /ENHANCE SLOT BADGE === */

/* === WEAPON ENHANCE MODAL (MOBILE OPTIMIZED 2x4) === */
#enhanceModal{
  position:fixed; inset:0;
  display:none;
  align-items:center; justify-content:center;
  z-index: 20050;
  background: rgba(0,0,0,0.50);
  backdrop-filter: blur(2px);
}
#enhanceModal.show{ display:flex; }

#enhanceBox{
  width: min(520px, calc(100vw - 16px));
  max-height: min(64vh, 560px);
  background: rgba(20,24,28,0.94);
  outline:2px solid rgba(255,255,255,0.14);
  border-radius: 18px;
  box-shadow: 0 20px 70px rgba(0,0,0,0.60);
  overflow:hidden;
  display:flex;
  flex-direction:column;
}

#enhanceHead{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding: 14px 16px;
  background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(0,0,0,0));
}
#enhanceTitle{
  font:900 18px/1.1 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
  color: rgba(255,255,255,0.94);
  letter-spacing: .02em;
}
#enhanceClose{
  appearance:none;
  border:none;
  cursor:pointer;
  padding:12px 14px;
  border-radius: 14px;
  font:900 15px/1 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
  color: rgba(255,255,255,0.92);
  background: rgba(255,255,255,0.12);
  outline: 2px solid rgba(255,255,255,0.16);
}
#enhanceClose:active{ transform: translateY(1px) scale(0.99); }

#enhanceBody{
  padding: 14px 14px 16px;
  overflow:auto;
  -webkit-overflow-scrolling: touch;
}

#enhanceGrid{
  display:grid;
  grid-template-columns: repeat(4, minmax(0, 1fr)); /* âœ… 2 x 4 */
  gap: 12px;                                       /* âœ… í„°ì¹˜ ì—¬ìœ  */
}

.enhWSlot{
  position:relative;
  width:100%;
  aspect-ratio: 1 / 1;
  border-radius: 18px;
  overflow:hidden;
  background: rgba(255,255,255,0.08);
  outline: 2px solid rgba(255,255,255,0.14);
  box-shadow: 0 12px 28px rgba(0,0,0,0.40);
  cursor:pointer;
  touch-action: manipulation;
}
.enhWSlot.sel{
  outline: 3px solid rgba(120,220,255,0.75);
  box-shadow: 0 16px 38px rgba(0,0,0,0.50), 0 0 0 3px rgba(120,220,255,0.14);
}
.enhWSlot:active{ transform: translateY(1px) scale(0.99); }

.enhWSlot img{
  width:100%; height:100%;
  object-fit: cover;
  filter: drop-shadow(0 8px 14px rgba(0,0,0,0.35));
}

.enhWSlot .wName{
  position:absolute;
  left:8px; right:8px;
  bottom:8px;
  padding: 6px 8px;
  border-radius: 14px;
  font:900 13px/1.15 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
  color: rgba(255,255,255,0.96);
  background: rgba(0,0,0,0.42);
  text-shadow: 0 2px 10px rgba(0,0,0,0.55);
}

#enhanceConfirm{
  margin-top: 14px;
  padding-top: 14px;
  border-top: 1px solid rgba(255,255,255,0.12);
  display:none;
  flex-direction:column;        /* âœ… ëª¨ë°”ì¼: ì„¸ë¡œë¡œ í¬ê²Œ */
  gap: 12px;
  align-items:stretch;
}
#enhanceConfirm.show{ display:flex; }

#enhanceQuestion{
  font: 900 16px/1.25 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
  color: rgba(255,255,255,0.94);
  letter-spacing: -0.01em;
}

.enhBtn{
  appearance:none;
  border:none;
  cursor:pointer;
  padding: 14px 16px;
  border-radius: 16px;
  font: 900 16px/1 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
  color: rgba(255,255,255,0.96);
  outline: 2px solid rgba(255,255,255,0.18);
  box-shadow: 0 12px 26px rgba(0,0,0,0.40);
  touch-action: manipulation;
}
.enhBtn:active{ transform: translateY(1px) scale(0.99); filter: brightness(0.98); }
#enhYes{ background: rgba(83,172,72,0.92); }
#enhNo{ background: rgba(255,255,255,0.12); }

@media (max-width: 520px){
  #enhanceBox{
    width: calc(100vw - 14px);
    max-height: 70vh;
    border-radius: 18px;
  }
  #enhanceHead{ padding: 14px 14px; }
  #enhanceTitle{ font-size: 18px; }
  #enhanceClose{ padding: 12px 14px; font-size: 15px; }
  #enhanceBody{ padding: 14px 12px 16px; }
  #enhanceGrid{ gap: 12px; }
  .enhWSlot{ border-radius: 18px; }
  .enhWSlot .wName{ font-size: 13px; }
  #enhanceQuestion{ font-size: 16px; }
  .enhBtn{ font-size: 16px; padding: 14px 16px; }
}




/* === BLACKSMITH UI THEME (mobile-first) === */
#enhanceHead{
  gap:10px;
}
#enhanceHead .enhHeadLeft{
  display:flex;
  flex-direction:column;
  gap:3px;
  min-width:0;
}
#enhanceSub{
  font:800 11px/1.15 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
  color: rgba(255,255,255,0.68);
  letter-spacing: .01em;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
#enhanceHint{
  font:900 13px/1.2 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
  color: rgba(255,255,255,0.88);
  margin: 4px 2px 10px;
  letter-spacing:.01em;
}

/* íŒ¨ë„ í†¤: ëŒ€ì¥ì¥ì´(ë”°ëœ»í•œ ê¸ˆì†/í™”ë¡œ ëŠë‚Œ) */
#enhanceBox{
  background: radial-gradient(120% 120% at 30% 20%, rgba(255,190,90,0.10), rgba(20,24,28,0.92) 55%),
              radial-gradient(120% 140% at 70% 80%, rgba(120,220,255,0.06), rgba(20,24,28,0) 60%),
              rgba(20,24,28,0.92);
  outline:1px solid rgba(255,220,160,0.14);
}
#enhanceHead{
  background: linear-gradient(180deg, rgba(255,210,120,0.14), rgba(0,0,0,0));
}
#enhanceClose{
  background: rgba(255,255,255,0.10);
  outline: 1px solid rgba(255,220,160,0.18);
}
#enhanceTitle{
  font: 1000 15px/1.1 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
}

/* 2x4 í¬ê²Œ: ìŠ¬ë¡¯ í¬ê¸° í‚¤ìš°ê³  ê°„ê²© ë„“í˜ */
#enhanceGrid{
  display:grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
}
.enhWSlot{
  border-radius: 16px;
  outline: 2px solid rgba(255,255,255,0.12);
  background: rgba(255,255,255,0.07);
}
.enhWSlot.sel{
  outline: 3px solid rgba(255,210,120,0.55);
  box-shadow: 0 14px 34px rgba(0,0,0,0.42), 0 0 0 2px rgba(255,210,120,0.16);
}
.enhWSlot .wName{
  font:900 11px/1.15 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
  padding: 6px 8px;
  background: rgba(0,0,0,0.42);
}

/* í•˜ë‹¨ ëŒ€ì‚¬/ë²„íŠ¼: ì—„ì§€ì˜ì—­ì— í¬ê²Œ */
#enhanceConfirm{
  margin-top: 14px;
  padding-top: 14px;
  border-top: 1px solid rgba(255,255,255,0.10);
  background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(0,0,0,0));
  border-radius: 14px;
  padding-left: 10px;
  padding-right: 10px;
  padding-bottom: 12px;
}
#enhanceQuestion{
  font: 1000 14px/1.25 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
  color: rgba(255,255,255,0.94);
  margin: 4px 0 12px;
  letter-spacing: .01em;
}
#enhanceConfirm .enhActions{
  display:flex;
  gap: 10px;
  width:100%;
}
#enhYes, #enhNo{
  flex:1 1 0;
  padding: 14px 14px;
  border-radius: 16px;
  font: 1000 14px/1 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
}
#enhYes{
  background: linear-gradient(180deg, rgba(255,180,80,0.95), rgba(255,120,40,0.88));
  outline: 1px solid rgba(255,220,160,0.35);
}
#enhNo{
  background: rgba(255,255,255,0.10);
  outline: 1px solid rgba(255,255,255,0.16);
}

/* ëª¨ë°”ì¼ì—ì„œ ë” í¬ê²Œ */
@media (max-width: 520px){
  #enhanceBox{
    width: min(420px, calc(100vw - 20px));
    max-height: min(56vh, 520px);
  }
  #enhanceGrid{ gap: 12px; }
  #enhanceHint{ font-size: 14px; }
  #enhanceQuestion{ font-size: 15px; }
  #enhYes, #enhNo{ padding: 16px 14px; font-size: 15px; }
}

/* === AUTO HUNT BUTTON (above skill slots) === */
#autoBtn{
  position:fixed;
  right:170px;
  /* skillHud height: 70*3 + gap(8*2)=226. Put button 14px above that */
  bottom: calc(12px + 226px + 14px);
  z-index: 9300;
  pointer-events:auto;
  appearance:none;
  border:none;
  cursor:pointer;

  padding: 10px 14px;
  border-radius: 16px;

  /* ê¸°ë³¸ ìƒíƒœ(OFF): ìœ ë¦¬ ëŠë‚Œ + ì–‡ì€ ì™¸ê³½ì„  */
  background: linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06));
  outline: 2px solid rgba(255,255,255,0.18);
  box-shadow:
    0 14px 32px rgba(0,0,0,0.38),
    0 0 0 2px rgba(120,220,255,0.12),
    inset 0 0 0 1px rgba(0,0,0,0.12);

  backdrop-filter: blur(3px);
  -webkit-tap-highlight-color: transparent;

  display:flex;
  align-items:center;
  justify-content:center;

  transition: outline-color .12s ease, outline-width .12s ease, box-shadow .12s ease, filter .12s ease, transform .08s ease;
}

/* í…ìŠ¤íŠ¸(OFF) */
#autoBtn .autoIcon{
  display:inline-block;
  font: 900 12px/1 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
  letter-spacing: 0.18em;
  text-transform: uppercase;
  color: rgba(255,255,255,0.92);
  text-shadow: 0 2px 10px rgba(0,0,0,0.45);
}

/* âœ… ON: ì™¸ê³½ì„  ê°•ì¡° + ê¸€ì”¨ ìƒ‰ì„ ì™¸ê³½ì„  ìƒ‰ê³¼ ë™ì¼í•˜ê²Œ */
#autoBtn.on{
  outline-width: 3px; /* ì¡°ê¸ˆ ë” êµµê²Œ */
  outline-color: rgba(120,220,255,0.72);
  box-shadow:
    0 14px 34px rgba(0,0,0,0.42),
    0 0 0 2px rgba(120,220,255,0.30),
    0 0 26px rgba(120,220,255,0.22),
    inset 0 0 0 1px rgba(0,0,0,0.10);
}
#autoBtn.on .autoIcon{
  color: rgba(120,220,255,0.92); /* ì™¸ê³½ì„ ê³¼ ë™ì¼ í†¤ */
  text-shadow:
    0 2px 10px rgba(0,0,0,0.45),
    0 0 18px rgba(120,220,255,0.35);
}

/* í´ë¦­ í”¼ë“œë°± */
#autoBtn:active{
  transform: translateY(1px) scale(0.99);
  filter: brightness(0.98);
}
#autoBtn:focus-visible{
  outline-color: rgba(120,220,255,0.85);
  box-shadow: 0 0 0 4px rgba(120,220,255,0.18), 0 14px 34px rgba(0,0,0,0.42);
}


/* ëª¨ë°”ì¼ ìŠ¤í‚¬ ìŠ¬ë¡¯ í¬ê¸°(64px, gap7*2=14) => ë†’ì´ 64*3+14=206 */
@media (max-width: 520px){
  #autoBtn{
    right:10px;
    bottom: calc(10px + 206px + 12px);
    padding: 9px 12px;
    border-radius: 14px;
  }
  #autoBtn .label .t{ font-size:11px; }
  #autoBtn .label .s{ font-size:9px; }
}


/* === MAP NAME FX (particle title) === */
#mapNameFx{
  position:fixed;
  left:0;
  top:6vh;                 /* â¬…ï¸ í™”ë©´ ë§¨ ìœ„ê°€ ì•„ë‹ˆë¼ ì¤‘ì•™-ìƒë‹¨ */
  width:100vw;
  height:220px;            /* â¬…ï¸ ì¤‘ì•™ ì—°ì¶œìš©ìœ¼ë¡œ ì—¬ìœ  */
  z-index:9050;
  pointer-events:none;
}
@media (max-width:520px){
  #mapNameFx{ height:104px; }
}



/* === WEAPON ENHANCE PANEL (WOOD UI like sample) === */
#enhanceModal{
  z-index: 30000;
  background: rgba(0,0,0,0.35);
  backdrop-filter: blur(1px);
}

/* âœ… ëª¨ë°”ì¼ ì„¸ë¡œ ê¸°ì¤€: ì¸ë²¤ íŒ¨ë„/ìŠ¬ë¡¯ê³¼ ë¹„ìŠ·í•œ ë©ì¹˜ë¡œ ì¶•ì†Œ */
#enhanceBox{
  width: min(420px, calc(100vw - 18px));
  max-height: min(74vh, 520px);
  border-radius: 14px;
  overflow:hidden;

  /* wood-ish */
  background:
    radial-gradient(140% 120% at 30% 20%, rgba(255,235,200,0.14), rgba(0,0,0,0) 55%),
    repeating-linear-gradient(90deg,
      rgba(90,55,26,0.92) 0px,
      rgba(90,55,26,0.92) 14px,
      rgba(82,48,22,0.92) 14px,
      rgba(82,48,22,0.92) 28px),
    linear-gradient(180deg, rgba(255,255,255,0.10), rgba(0,0,0,0.10));
  outline: 2px solid rgba(25,12,4,0.75);
  box-shadow: 0 22px 70px rgba(0,0,0,0.65), inset 0 0 0 2px rgba(255,210,150,0.08);
}

#enhanceHead{
  padding: 12px 14px 10px;
  background: linear-gradient(180deg, rgba(0,0,0,0.18), rgba(0,0,0,0));
  border-bottom: 2px solid rgba(0,0,0,0.25);
}
#enhanceTitle{
  font: 1000 15px/1.1 "Black Han Sans","Noto Sans KR",system-ui,sans-serif;
  color: rgba(255,235,210,0.98);
  text-shadow: 0 2px 0 rgba(0,0,0,0.35);
  letter-spacing: -0.01em;
}
#enhanceClose{
  display:none; /* ìƒ˜í”Œ UIì²˜ëŸ¼ í•˜ë‹¨ ë²„íŠ¼ìœ¼ë¡œë§Œ ì¢…ë£Œ */
}

#enhanceBody{
  padding: 10px 10px 12px;
}
#enhanceHint{
  margin: 0 0 8px;
  font: 800 12px/1.2 "Gowun Batang","Noto Sans KR",system-ui,serif;
  color: rgba(255,255,255,0.78);
  text-shadow: 0 1px 0 rgba(0,0,0,0.35);
}

/* 4x3 slot grid (like sample) */
#enhanceGrid{
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;                  /* âœ… ì¸ë²¤ ìŠ¬ë¡¯ ëŠë‚Œìœ¼ë¡œ ê°„ê²© ì¶•ì†Œ */
}
.enhWSlot{
  border-radius: 10px;       /* âœ… ì¸ë²¤ ìŠ¬ë¡¯ì²˜ëŸ¼ */
  background: rgba(25,31,22,0.75);
  outline: 1.5px solid rgba(35,18,6,0.70);
  box-shadow:
    inset 0 2px 0 rgba(255,230,190,0.08),
    inset 0 -8px 18px rgba(0,0,0,0.35),
    0 6px 14px rgba(0,0,0,0.26);
}
.enhWSlot img{
  border-radius: 10px;
  opacity: 0.98;
}
.enhWSlot .wName{
  left:6px; right:6px; bottom:6px;
  border-radius: 10px;
  padding: 6px 8px;

  /* âœ… ê°ì„± í°íŠ¸ */
  font: 800 12px/1.12 "Gowun Batang","Noto Sans KR",system-ui,serif;
  letter-spacing: 0.02em;

  color: rgba(255,245,230,0.96);
  background: rgba(0,0,0,0.44);
  text-shadow: 0 2px 10px rgba(0,0,0,0.55);
}
.enhWSlot.sel{
  outline: 3px solid rgba(255,210,120,0.75);
  box-shadow:
    inset 0 2px 0 rgba(255,230,190,0.10),
    inset 0 -10px 22px rgba(0,0,0,0.40),
    0 10px 22px rgba(0,0,0,0.38),
    0 0 0 2px rgba(255,210,120,0.18);
}

/* bottom confirm bar */
#enhanceConfirm{
  margin-top: 10px;
  padding-top: 10px;
  border-top: 2px solid rgba(0,0,0,0.25);
  background: linear-gradient(180deg, rgba(0,0,0,0.12), rgba(0,0,0,0.00));
  border-radius: 12px;
}
#enhanceQuestion{
  font: 900 13px/1.25 "Gowun Batang","Noto Sans KR",system-ui,serif;
  color: rgba(255,235,210,0.96);
  text-shadow: 0 1px 0 rgba(0,0,0,0.35);
}

#enhYes, #enhNo{
  border-radius: 10px;
  outline: 2px solid rgba(25,12,4,0.55) !important;
  box-shadow: inset 0 2px 0 rgba(255,255,255,0.10), 0 10px 18px rgba(0,0,0,0.30);
  font: 1000 13px/1 "Black Han Sans","Noto Sans KR",system-ui,sans-serif;
  padding: 12px 10px;
}
#enhYes{
  background: linear-gradient(180deg, rgba(255,170,70,0.95), rgba(210,110,38,0.92)) !important;
}
#enhNo{
  background: linear-gradient(180deg, rgba(170,105,48,0.90), rgba(120,70,30,0.90)) !important;
  color: rgba(255,235,210,0.92);
}

/* âœ… ëª¨ë°”ì¼ ì„¸ë¡œ ìµœì í™”: ì¸ë²¤ íŒ¨ë„ í¬ê¸°/ìŠ¬ë¡¯ ì²´ê°ìœ¼ë¡œ ë” ì¶•ì†Œ */
@media (max-width: 520px){
  #enhanceBox{
    width: min(92vw, 340px);          /* ì¸ë²¤ íŒ¨ë„ê³¼ ë™ì¼ ê°ê° */
    max-height: min(78vh, 520px);
  }
  #enhanceHead{ padding: 11px 12px 9px; }
  #enhanceTitle{ font-size: 14px; }
  #enhanceBody{ padding: 9px 9px 11px; }
  #enhanceGrid{ gap: 7px; }
  .enhWSlot{ border-radius: 10px; }
  .enhWSlot .wName{ font-size: 11px; padding: 5px 7px; }
  #enhanceQuestion{ font-size: 12px; }
  #enhYes, #enhNo{ padding: 12px 10px; font-size: 13px; }
}
/* === /WEAPON ENHANCE PANEL (WOOD UI) === */

/* === ENHANCE PANEL: DRAG + 4x3 + ICON SCALE (2026-01-04) === */
#enhanceBox{
  position: fixed;            /* allow drag */
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
}
#enhanceBox.dragging{ transition:none !important; }
#enhanceHead{
  cursor: grab;
  touch-action: none;
}
#enhanceBox.dragging #enhanceHead{ cursor: grabbing; }

/* top question bigger */
#enhanceTitle{
  font-size: 18px !important;
  letter-spacing: -0.02em;
}

/* grid: 4 columns x 3 rows */
#enhanceGrid{
  grid-template-columns: repeat(4, 1fr) !important;
  grid-auto-rows: 1fr;
}

/* slot icon scale down ~30% */
.enhWSlot{
  position: relative;
  display:flex;
  align-items:center;
  justify-content:center;
}
.enhWSlot img{
  width: 70% !important;
  height: 70% !important;
  object-fit: contain !important;
}

/* keep name readable */
.enhWSlot .wName{
  font-size: 11px !important;
}

/* empty placeholder slots */
.enhWSlot.empty{
  cursor: default;
  opacity: 0.55;
}
.enhWSlot.empty::after{
  content:"";
  position:absolute; inset:0;
  background: radial-gradient(circle at 30% 25%, rgba(255,255,255,0.10), transparent 55%);
  pointer-events:none;
}


/* === ENHANCE PANEL OVERRIDES: MATCH INVENTORY SIZE/SLOTS (2026-01-04) === */
#enhanceBox{
  width: 340px !important;
  height: 420px !important;
  max-height: none !important;
}
@media (max-width: 520px){
  #enhanceBox{
    width: min(92vw, 340px) !important;
    height: min(70vh, 420px) !important;
  }
}

/* ì¸ë²¤ ìŠ¬ë¡¯ ê°ê°ìœ¼ë¡œ: ë°”ë””ë¥¼ ì¸ë²¤ ê·¸ë¦¬ë“œ ì»¨í…Œì´ë„ˆì²˜ëŸ¼ */
#enhanceBody{
  flex: 1 1 auto !important;
  margin-top: 10px !important;
  background: rgba(34,34,34,0.50) !important;
  border-radius: 12px !important;
  padding: 12px !important;
  box-shadow: inset 0 0 0 1px rgba(0,0,0,0.25) !important;
}

/* 4x3 ìœ ì§€ */
#enhanceGrid{
  grid-template-columns: repeat(4, 1fr) !important;
  grid-template-rows: repeat(3, 1fr) !important;
  gap: 10px !important; /* ì¸ë²¤ gapê³¼ ë™ì¼ */
}

/* ìŠ¬ë¡¯ í¬ê¸°/ìŠ¤íƒ€ì¼ = ì¸ë²¤ ìŠ¬ë¡¯ */
.enhWSlot{
  border-radius: 10px !important;
  background: rgba(25,31,22,0.85) !important;
  border: 1.5px solid rgba(60,110,58,0.55) !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.18) !important;
  overflow: hidden !important;
  display:flex !important;
  align-items:center !important;
  justify-content:center !important;
  position:relative !important;
}

/* âœ… ë¬´ê¸° ì´ë¯¸ì§€ëŠ” ì¤„ì´ì§€ ë§ê³  ìŠ¬ë¡¯ì— ë”± ë§ê²Œ */
.enhWSlot img{
  width: 100% !important;
  height: 100% !important;
  object-fit: cover !important;
  display:block !important;
  border-radius: 0 !important;
  filter: none !important;
}

/* ì„ íƒ í…Œë‘ë¦¬ */
.enhWSlot.sel{
  outline: 3px solid rgba(120,220,255,0.75) !important;
  box-shadow: 0 10px 22px rgba(0,0,0,0.25), 0 0 0 2px rgba(120,220,255,0.14) !important;
}

/* ìŠ¬ë¡¯ëª… í°íŠ¸ */
.enhWSlot .wName{
  font: 800 12px/1.12 "Gowun Batang","Noto Sans KR",system-ui,serif !important;
  left:6px !important; right:6px !important; bottom:6px !important;
  padding: 6px 8px !important;
  border-radius: 10px !important;
}

/* ì„œë¸Œ íŒë„¬: ì²˜ìŒë¶€í„° ë³´ì´ë˜, ì„ íƒ ì „ì—” ë²„íŠ¼ ìˆ¨ê¹€ */
#enhanceConfirm{
  display:flex !important;
}
#enhanceConfirm .enhActions{
  display:none;
}
#enhanceConfirm.armed .enhActions{
  display:flex;
}
/* === /ENHANCE PANEL OVERRIDES === */


/* âœ… ëŒ€í‘œë‹˜ ìš”ì²­: í•˜ë‹¨ ê¸°ë³¸ ë¬¸êµ¬(ê°•í™”í•  ë¬´ê¸°ë¥¼ ì„ íƒí•˜ì„¸ìš”) ìˆ¨ê¸°ê³ , ì„ íƒ í›„ì—ë§Œ ì§ˆë¬¸ í‘œì‹œ */
#enhanceConfirm:not(.armed) #enhanceQuestion{
  display:none !important;
}
/* âœ… ëŒ€í‘œë‹˜ ìš”ì²­: ê°•í™” ìŠ¬ë¡¯ í•˜ë‹¨ ë¬´ê¸°ëª…(+n í¬í•¨)ì€ êµµê²Œ í•˜ì§€ ì•Šê¸° */
.enhWSlot .wName{
  font-weight:400 !important;
}


/* === OVERRIDE: badges/text only (no panel background) === */
.invSlot .equipMark,
.invSlot .enhBadge,
.enhWSlot .enhBadge{
  background: transparent !important;
  outline: none !important;
  box-shadow: none !important;
  border-radius: 0 !important;
  padding: 0 !important;
  min-width: auto !important;
  width: auto !important;
  height: auto !important;
}
/* keep readable text over icons */
.invSlot .equipMark{
  left:6px !important;
  top:6px !important;
  font: 900 14px/1 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif !important;
  color: rgba(255,255,255,0.98) !important;
  text-shadow: 0 2px 10px rgba(0,0,0,0.65) !important;
}
.invSlot .enhBadge{
  right:6px !important;
  top:6px !important;
  font: 900 13px/1 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif !important;
  color: rgba(255,255,255,0.98) !important;
  text-shadow: 0 2px 10px rgba(0,0,0,0.65) !important;
}
.enhWSlot .enhBadge{
  right:6px !important;
  bottom:6px !important;
  font: 900 13px/1 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif !important;
  color: rgba(255,255,255,0.98) !important;
  text-shadow: 0 2px 10px rgba(0,0,0,0.65) !important;
}
/* === /OVERRIDE === */

/* === OVERRIDE: enhance slot name text only (no panel) === */
.enhWSlot .wName{
  background: transparent !important;
  box-shadow: none !important;
  outline: none !important;
  border-radius: 0 !important;
  padding: 0 !important;

  /* keep it readable */
  font-weight: 500 !important;
  color: rgba(255,245,230,0.96) !important;
  text-shadow: 0 2px 10px rgba(0,0,0,0.65) !important;

  left:6px !important;
  right:6px !important;
  bottom:6px !important;
  text-align: center !important;
}
/* === /OVERRIDE === */



/* === START BUTTON CENTER ON TITLE IMAGE === */
.titleImageWrap{
  position: relative;
  display: inline-block;
}
.startBtn.centerOnTitle{
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  margin: 0;
}





/* === START BUTTON TUNING (EMOTIONAL, THICK) === */
.startBtn.centerOnTitle{
  /* ìœ„ì¹˜: ì¤‘ì•™ë³´ë‹¤ ì‚´ì§ ì•„ë˜ */
  top: 60%;

  /* ê°ì„± í°íŠ¸(ë‘ê»ê²Œ) */
  font-family: "Black Han Sans","Gowun Batang","Noto Sans KR",system-ui,sans-serif;
  font-size: 20px;
  letter-spacing: 0.06em;

  /* ê°ì„± íŒ¨ë„ ë””ìì¸ */
  padding: 16px 26px;
  width: min(240px, 70vw);
  border-radius: 18px;

  background:
    radial-gradient(120% 140% at 30% 20%, rgba(255,240,210,0.35), rgba(0,0,0,0) 55%),
    linear-gradient(180deg, rgba(255,190,90,0.92), rgba(210,110,38,0.90));
  color: rgba(255,255,255,0.96);

  outline: 2px solid rgba(255,235,210,0.35);
  box-shadow:
    0 18px 44px rgba(0,0,0,0.55),
    0 0 22px rgba(255,190,90,0.22),
    inset 0 2px 0 rgba(255,255,255,0.18),
    inset 0 -10px 18px rgba(0,0,0,0.18);

  text-shadow:
    0 2px 0 rgba(0,0,0,0.30),
    0 0 14px rgba(255,220,160,0.22);

  transition: transform .10s ease, filter .12s ease, outline-color .12s ease, box-shadow .12s ease;
}
.startBtn.centerOnTitle:hover{
  filter: brightness(1.06);
  outline-color: rgba(255,245,230,0.55);
  box-shadow:
    0 18px 46px rgba(0,0,0,0.58),
    0 0 28px rgba(255,200,110,0.28),
    inset 0 2px 0 rgba(255,255,255,0.20),
    inset 0 -10px 18px rgba(0,0,0,0.18);
}
.startBtn.centerOnTitle:active{
  transform: translate(-50%, -50%) translateY(2px) scale(0.99);
  filter: brightness(0.98);
}
.startBtn.centerOnTitle:focus-visible{
  outline-color: rgba(120,220,255,0.80);
  box-shadow:
    0 0 0 4px rgba(120,220,255,0.22),
    0 18px 44px rgba(0,0,0,0.55),
    inset 0 2px 0 rgba(255,255,255,0.18),
    inset 0 -10px 18px rgba(0,0,0,0.18);
}


/* === START HINT UNDER BUTTON === */
.startHintUnderBtn{
  margin-top: 10px;
  font-family: "Gowun Batang","Noto Sans KR",system-ui,serif;
  font-size: 13px;
  letter-spacing: 0.02em;
  color: rgba(255,255,255,0.75);
  text-align: center;
  text-shadow: 0 2px 10px rgba(0,0,0,0.45);
}


/* === EQUIP PANEL DRAG HANDLE (match inventory feel) === */
#equipPanel .statHeader{ cursor: grab; touch-action: none; user-select:none; }
#equipPanel.dragging .statHeader{ cursor: grabbing; }

</style>
<meta http-equiv="Content-Security-Policy"
      content="frame-src https://www.twitch.tv https://player.twitch.tv; child-src https://www.twitch.tv https://player.twitch.tv;">
</head>
<body>
  <audio id="applySound" src="bb.ogg"></audio>
  <audio id="statUpSound" src="bb.ogg"></audio>
  <audio id="statBtnSound" src="bb.ogg"></audio>
  <audio id="invBtnSound" src="ch.ogg"></audio>
  <audio id="equipSound" src="jangkuy.ogg"></audio>
  <audio id="statPlusSound" src="coh.ogg"></audio>
  <audio id="enhanceSuccessSound" src="good.ogg"></audio>



    <audio id="enhanceBreakSound" src="silpea.ogg"></audio>
  <audio id="enhanceResetSound" src="dop.ogg"></audio>
<audio id="levelUpSound" src="up.ogg"></audio>
<canvas id="game"></canvas>

  <!-- âœ… MAP NAME FX (top center) -->
  <canvas id="mapNameFx" aria-hidden="true"></canvas>

  <!-- ìŠ¤íƒ¯ë²„íŠ¼ -->
  <button id="statBtn"><span class="icon">ğŸ“Š</span> <span class="statText">ìŠ¤íƒ¯ë¶„ë°°</span></button>
<div id="startHint" class="startHintUnderBtn">ê²Œì„ì‹œì‘ì„ ëˆ„ë¥´ë©´ ê²Œì„ì´ ì‹œì‘ë©ë‹ˆë‹¤.</div>

<div class="startHintUnderBtn">ê²Œì„ì‹œì‘ì„ ëˆ„ë¥´ë©´ ê²Œì„ì´ ì‹œì‘ë©ë‹ˆë‹¤.</div>
  <button id="invBtn"><span class="icon">ğŸ’</span> <span class="statText">ì¸ë²¤í† ë¦¬</span></button>
  <button id="equipStatusBtn"><span class="icon">ğŸ›¡ï¸</span> <span class="statText">ì¥ë¹„ìƒíƒœ</span></button>
  <!-- ìŠ¤íƒ¯ íŒ¨ë„ -->
  <div id="statPanel" class="hide">
    <div class="statHeader">
      <span class="statPoint">ìŠ¤íƒ¯í¬ì¸íŠ¸: <span id="statPoints">0</span></span>
<button class="btn close" type="button">Close</button>
      
    </div>
    
    <div class="statList" id="statList"></div>
  </div>

<!-- ì¸ë²¤í† ë¦¬ íŒ¨ë„ -->
<div id="invPanel" class="hide">
  <div class="statHeader">
    <span class="statPoint">ì¸ë²¤í† ë¦¬</span>
    <button class="btn close" type="button">Close</button>
  </div>

  <div class="invGrid" id="invGrid"></div>

  <div class="invPager">
    <button id="invPrev" class="invArrow" type="button" aria-label="ì´ì „ í˜ì´ì§€">â—€</button>
    <div id="invPageText" class="invPageText">1 / 1</div>
    <button id="invNext" class="invArrow" type="button" aria-label="ë‹¤ìŒ í˜ì´ì§€">â–¶</button>
  </div>

</div>

<!-- ì¥ë¹„ ìƒíƒœ íŒ¨ë„ -->
<div id="equipPanel" class="hide">
  <div class="statHeader">
    <span class="statPoint">ì¥ë¹„ìƒíƒœ</span>
    <button class="btn close" type="button">Close</button>
  </div>

  <div class="equipGrid" id="equipGrid"></div>

  <div class="equipFooter" id="equipFooter">
    <div class="line"><span class="k">ë¬´ê¸°</span><span class="v" id="eq_weapon">-</span></div>
    <div class="line"><span class="k">ë°©ì–´êµ¬</span><span class="v" id="eq_armor">-</span></div>
    <div class="line"><span class="k">Armor Class</span><span class="v" id="eq_ac">0</span></div>
  </div>
</div>



<div id="statApplyAlert" style="
    display:none;
    position:fixed;
    left:50%; top:19%;
    transform:translate(-50%, 0);
    background:rgba(18,29,15,0.95);
    color:#bfff7f;
    font-weight:700;
    font-size:1.35em;
    padding:12px 34px 10px 34px;
    border-radius:18px;
    box-shadow:0 3px 14px rgba(0,0,0,0.35);
    z-index:10000;
    letter-spacing:2px;
    text-align:center;
    user-select:none;
    opacity:0.98;
  ">ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.</div>


<div id="statHud">
  <div class="hudBar hp" style="position:relative;">
    <div id="hpFill" class="hudFill hp"></div>
    <div class="hudText"><span class="label">HP:</span><span id="hpText" class="value">0/0</span></div>
  </div>
  <div class="hudBar mp" style="position:relative;">
    <div id="mpFill" class="hudFill mp"></div>
    <div class="hudText"><span class="label">MP:</span><span id="mpText" class="value">0/0</span></div>
  </div>
  <div class="hudBar exp" style="position:relative;">
    <div id="expFill" class="hudFill exp"></div>
    <div class="hudText"><span class="label">EXP:</span><span id="expText" class="value">0/0</span></div>
  </div>
<!-- === SKILL SLOTS HUD (3x3) === -->
<div id="skillHud" aria-label="skill slots">
  <!-- data-skill: 1~9 -->
  <div class="skillSlot" data-skill="1"><div class="cd"></div><div class="icon">âš¡</div><div class="key">1</div><div class="cdText"></div></div>
  <div class="skillSlot" data-skill="2"><div class="cd"></div><div class="icon">ğŸ”¥</div><div class="key">2</div><div class="cdText"></div></div>
  <div class="skillSlot" data-skill="3"><div class="cd"></div><div class="icon">ğŸ›¡ï¸</div><div class="key">3</div><div class="cdText"></div></div>

  <div class="skillSlot" data-skill="4"><div class="cd"></div><div class="icon">ğŸ’¨</div><div class="key">4</div><div class="cdText"></div></div>
  <div class="skillSlot" data-skill="5"><div class="cd"></div><div class="icon">âœ¨</div><div class="key">5</div><div class="cdText"></div></div>
  <div class="skillSlot" data-skill="6"><div class="cd"></div><div class="icon">â„ï¸</div><div class="key">6</div><div class="cdText"></div></div>

  <div class="skillSlot" data-skill="7"><div class="cd"></div><div class="icon">ğŸ—¡ï¸</div><div class="key">7</div><div class="cdText"></div></div>
  <div class="skillSlot" data-skill="8"><div class="cd"></div><div class="icon">ğŸŒ™</div><div class="key">8</div><div class="cdText"></div></div>
  <div class="skillSlot" data-skill="9"><div class="cd"></div><div class="icon">ğŸ€</div><div class="key">9</div><div class="cdText"></div></div>
</div>

</div>



<!-- === AUTO HUNT BUTTON (above skill slots) === -->
<button id="autoBtn" type="button" aria-label="ìë™ì‚¬ëƒ¥ í† ê¸€">
  <span class="autoIcon">AUTO</span>
</button>

<!-- âœ… ê°€ìƒ ì¡°ì´ìŠ¤í‹± (ëª¨ë°”ì¼/PC ê³µìš©: í„°ì¹˜/ë§ˆìš°ìŠ¤ ëˆ„ë¥´ë©´ ìƒì„±) -->
<div id="joy" aria-hidden="true">
  <div id="joyBase"></div>
  <div id="joyKnob"></div>
</div>

<!-- âœ… ì±„íŒ… ì ‘ê¸°/í¼ì¹˜ê¸° ë²„íŠ¼ (í•­ìƒ ìµœìƒë‹¨) -->
<button id="chatToggleBtn" type="button" aria-label="ì±„íŒ… ì ‘ê¸°/í¼ì¹˜ê¸°" aria-pressed="true">ì±„íŒ… ì ‘ê¸°</button>


<!-- âœ… íŠ¸ìœ„ì¹˜ ì±„íŒ… HUD (ì¢Œì¸¡ í•˜ë‹¨ ê³ ì • / ë°˜íˆ¬ëª…) -->
<div id="twChatHud" aria-label="twitch chat hud">
  <iframe id="twChatFrame" allow="autoplay" loading="lazy"></iframe>
  <div id="twResizeHandle" title="Resize chat" aria-label="resize chat"></div>
</div>


<iframe id="twitchChatIframe" class="twitchChatIframe" allow="autoplay" loading="lazy"></iframe>
<!-- âœ… ìµœì´ˆ ì§„ì… íƒ€ì´í‹€ í™”ë©´ -->
<div id="titleOverlay" class="titleOverlay" aria-label="title screen">
  <div class="titleCard">
    <!-- âœ… íƒ€ì´í‹€ ì´ë¯¸ì§€ -->
    <div class="titleImageWrap">
      <img src="tt.png" alt="ì „ì‚¬í‚¤ìš°ê¸° íƒ€ì´í‹€" class="titleImage">
      <button id="startBtn" class="startBtn centerOnTitle" type="button">ê²Œì„ì‹œì‘</button>
      
    </div>
    
  </div>
</div>

<script>
// === MONSTER DIE SOUNDS ===
const sndRabbitDie = new Audio("rabbit.ogg");
sndRabbitDie.volume = 0.8;
const sndCatDie = new Audio("cat1.ogg");
sndCatDie.volume = 0.8;


/* =========================
   MAP NAME FX (top canvas)
   - fade in (0.55s) -> hold (2.0s) -> fade out (0.75s)
   - light particle drift + shimmer
========================= */
(function(){
  const fx = document.getElementById("mapNameFx");
  if(!fx) return;

  const fctx = fx.getContext("2d");
  let W=0,H=0,DPR=1;

  function resize(){
    DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    W = Math.floor(window.innerWidth * DPR);
    // height is controlled by CSS; use element's css px height
    const cssH = Math.max(80, Math.floor(fx.getBoundingClientRect().height || 120));
    H = Math.floor(cssH * DPR);
    fx.width = W;
    fx.height = H;
  }
  window.addEventListener("resize", resize, {passive:true});
  resize();

  // state
  let active = null; // {text, start, duration, fadeIn, hold, fadeOut, particles[]}
  let raf = 0;

  function makeParticles(text){
    const parts = [];
    const baseY = Math.floor(H*0.5);
    const cx = Math.floor(W*0.5);

    // offscreen measure
    fctx.save();
    fctx.font = `800 ${Math.floor(26*DPR)}px system-ui, -apple-system, Segoe UI, Roboto, sans-serif`;
    const tw = fctx.measureText(text).width;
    fctx.restore();

    const startX = cx - tw/2;

    // create particles per glyph segment
    // sample points along text by drawing into offscreen and scanning alpha
    const off = document.createElement("canvas");
    off.width = Math.floor(tw + 40*DPR);
    off.height = Math.floor(70*DPR);
    const octx = off.getContext("2d");
    octx.clearRect(0,0,off.width,off.height);
    octx.font = `800 ${Math.floor(28*DPR)}px system-ui, -apple-system, Segoe UI, Roboto, sans-serif`;
    octx.textBaseline = "alphabetic";
    octx.textAlign = "left";
    // glow shadow into offscreen
    octx.fillStyle = "rgba(255,255,255,1)";
    octx.shadowColor = "rgba(160,240,200,0.75)";
    octx.shadowBlur = 16*DPR;
    octx.fillText(text, 20*DPR, 48*DPR);

    const img = octx.getImageData(0,0,off.width,off.height);
    const data = img.data;

    // sample with stride for performance
    const stride = Math.max(2, Math.floor(2*DPR));
    for(let y=0;y<off.height;y+=stride){
      for(let x=0;x<off.width;x+=stride){
        const a = data[(y*off.width + x)*4 + 3];
        if(a > 80){
          // only take some points
          if((x+y) % (4*stride) !== 0) continue;
          parts.push({
            x: startX + (x-20*DPR),
            y: baseY - (off.height - y) + 18*DPR,
            vx: (Math.random()*0.6-0.3) * DPR,
            vy: (Math.random()*0.35-0.2) * DPR,
            r: (Math.random()*1.4+0.6) * DPR,
            a0: Math.random()*0.45+0.55,
            tw: Math.random()*Math.PI*2,
            life: Math.random()*0.9 + 0.9
          });
        }
      }
    }

    // a few extra sparkles around
    const sparkleN = 26;
    for(let i=0;i<sparkleN;i++){
      parts.push({
        x: cx + (Math.random()*220-110)*DPR,
        y: baseY + (Math.random()*36-40)*DPR,
        vx: (Math.random()*0.9-0.45) * DPR,
        vy: (Math.random()*0.65-0.5) * DPR,
        r: (Math.random()*2.2+1.1) * DPR,
        a0: Math.random()*0.25+0.12,
        tw: Math.random()*Math.PI*2,
        life: Math.random()*0.9 + 0.7,
        sparkle:true
      });
    }

    return parts;
  }

  function easeOutCubic(t){ return 1 - Math.pow(1-t, 3); }
  function easeInOutSine(t){ return -(Math.cos(Math.PI*t)-1)/2; }

  function clear(){
    fctx.clearRect(0,0,W,H);
  }

  function draw(now){
    if(!active){ raf=0; clear(); return; }
    const t = (now - active.start) / 1000;

    const fi = active.fadeIn;
    const hold = active.hold;
    const fo = active.fadeOut;

    let alpha = 0;
    if(t < 0) alpha = 0;
    else if(t < fi) alpha = easeOutCubic(t/fi);
    else if(t < fi + hold) alpha = 1;
    else if(t < fi + hold + fo) alpha = 1 - easeInOutSine((t - fi - hold)/fo);
    else { active = null; clear(); raf=0; return; }

    // background clear with slight trail for softness
    fctx.save();
    fctx.globalCompositeOperation = "source-over";
    fctx.fillStyle = "rgba(0,0,0,0.0)";
    fctx.clearRect(0,0,W,H);

    // subtle fog band
    const gy = Math.floor(H*0.5);
    const grad = fctx.createRadialGradient(W/2, gy, 10*DPR, W/2, gy, 340*DPR);
    grad.addColorStop(0, `rgba(20,28,24,${0.22*alpha})`);
    grad.addColorStop(0.6, `rgba(10,12,12,${0.08*alpha})`);
    grad.addColorStop(1, "rgba(0,0,0,0)");
    fctx.fillStyle = grad;
    fctx.fillRect(0,0,W,H);

    // particles
    const drift = Math.min(1.6, t*0.6);
    for(const p of active.particles){
      p.tw += 0.05;
      const wob = Math.sin(p.tw) * 0.35 * DPR;
      const px = p.x + p.vx * (t*60) * 0.02 + wob;
      const py = p.y + p.vy * (t*60) * 0.02 - drift*0.6*DPR;

      let pa = alpha * p.a0;
      if(p.sparkle){
        pa *= (0.55 + 0.45*Math.sin(p.tw*2.2 + t*3.2));
      }

      fctx.globalAlpha = Math.max(0, Math.min(1, pa));
      fctx.beginPath();
      fctx.arc(px, py, p.r, 0, Math.PI*2);
      fctx.fillStyle = p.sparkle ? "rgba(180,255,220,1)" : "rgba(210,255,240,1)";
      fctx.shadowColor = p.sparkle ? "rgba(120,255,220,0.9)" : "rgba(120,220,255,0.65)";
      fctx.shadowBlur = (p.sparkle ? 14 : 10) * DPR;
      fctx.fill();
    }

    // text layer (crisp)
    fctx.globalAlpha = alpha;
    fctx.shadowBlur = 18*DPR;
    fctx.shadowColor = "rgba(120,255,210,0.45)";
    fctx.fillStyle = "rgba(245,255,250,0.96)";
    fctx.textAlign = "center";
    fctx.textBaseline = "middle";
    fctx.font = `800 ${Math.floor(28*DPR)}px system-ui, -apple-system, Segoe UI, Roboto, sans-serif`;
    fctx.fillText(active.text, W/2, Math.floor(H*0.5));

    // underline shimmer
    const lineW = Math.min(W*0.56, 520*DPR);
    const lx = W/2 - lineW/2;
    const ly = Math.floor(H*0.5) + Math.floor(18*DPR);
    const lg = fctx.createLinearGradient(lx, ly, lx+lineW, ly);
    const wave = (Math.sin(t*2.3)+1)/2;
    lg.addColorStop(0, "rgba(255,255,255,0)");
    lg.addColorStop(Math.max(0, wave-0.18), `rgba(160,255,220,${0.05*alpha})`);
    lg.addColorStop(wave, `rgba(200,255,245,${0.28*alpha})`);
    lg.addColorStop(Math.min(1, wave+0.18), `rgba(160,255,220,${0.05*alpha})`);
    lg.addColorStop(1, "rgba(255,255,255,0)");
    fctx.globalAlpha = 1;
    fctx.fillStyle = lg;
    fctx.fillRect(lx, ly, lineW, Math.max(1, Math.floor(2*DPR)));

    fctx.restore();

    raf = requestAnimationFrame(draw);
  }

  // expose
  window.showMapName = function(text){
    try{
      resize();
      active = {
        text: String(text || "").trim(),
        start: performance.now(),
        fadeIn: 0.55,
        hold: 2.0,
        fadeOut: 0.75,
        particles: []
      };
      active.particles = makeParticles(active.text);
      if(raf){ cancelAnimationFrame(raf); raf=0; }
      raf = requestAnimationFrame(draw);
      }catch(e){
      console.error("showMapName error:", e);
    }
  };
})();

// (moved) map name is triggered after Start (player spawn)
// setTimeout(()=>{ try{ window.showMapName && window.showMapName(mapTitleFor(window.currentMapId || currentMapId)); }catch(_){ } }, 900);


  // ===== ìŠ¤íƒ¯ ë¶„ë°° íŒ¨ë„ =====
  const statBtn = document.getElementById('statBtn');
const statBtnSound = document.getElementById('statBtnSound');
const invBtnSound = document.getElementById('invBtnSound');
const equipSound = document.getElementById('equipSound');
function playEquipSound(){
  try{
    if(!equipSound) return;
    equipSound.currentTime = 0;
    equipSound.play().catch(()=>{});
  }catch(_){}
}

  const statPanel = document.getElementById('statPanel');
  const statList = document.getElementById('statList');
  const statPointsEl = document.getElementById('statPoints');
  const statApplyAlert = document.getElementById('statApplyAlert');
  const statUpSound = document.getElementById('statUpSound');
  const statPlusSound = document.getElementById('statPlusSound');
  const applySound = document.getElementById('applySound');

  
    const levelUpSound = document.getElementById('levelUpSound');
  // âœ… ê°„ë‹¨ ìƒë‹¨ ì•Œë¦¼(ì¬ì‚¬ìš©: ê°•í™” ì„±ê³µ/ì‹¤íŒ¨ ë“±)
  function showTopNotice(msg, ms=850, color=null){
    try{
      if(!statApplyAlert) return;

      // ê¸°ë³¸ ìƒ‰ìƒ ê¸°ì–µ(ì²˜ìŒ 1íšŒ)
      if(!showTopNotice._baseColor){
        try{ showTopNotice._baseColor = getComputedStyle(statApplyAlert).color; }catch(_){}
      }

      statApplyAlert.textContent = msg;

      // ìƒ‰ìƒ ì ìš©(ì˜µì…˜)
      try{
        statApplyAlert.style.color = (color ? color : (showTopNotice._baseColor || ""));
      }catch(_){}

      statApplyAlert.style.display = "block";
      statApplyAlert.style.opacity = "0.98";
      clearTimeout(showTopNotice._t);
      showTopNotice._t = setTimeout(()=>{
        try{ statApplyAlert.style.display = "none"; }catch(_){}
        // ë‹¤ìŒ ì•Œë¦¼ì„ ìœ„í•´ ê¸°ë³¸ ìƒ‰ìœ¼ë¡œ ë˜ëŒë¦¼
        try{ statApplyAlert.style.color = (showTopNotice._baseColor || ""); }catch(_){}
      }, ms);
    }catch(_){}
  }
  window.showTopNotice = showTopNotice;

// ===== SKILL HUD (3x3) =====
  const skillHud = document.getElementById("skillHud");
  const skillSlots = Array.from(document.querySelectorAll("#skillHud .skillSlot"));
  

// ===== AUTO HUNT BUTTON (UI) =====
  const autoBtn = document.getElementById("autoBtn");

  // ê²Œì„ ì½”ë“œê°€ ì´ë¯¸ player.autoë¥¼ ì‚¬ìš©í•˜ê³  ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ,
  // ì „ì—­ í”Œë˜ê·¸(window.autoHunt)ë„ ê°™ì´ ê´€ë¦¬í•´ì„œ í˜¸í™˜ë˜ê²Œ ë§Œë“­ë‹ˆë‹¤.
  if (typeof window.autoHunt === "undefined") window.autoHunt = false;

  function setAutoHunt(on){
    const v = !!on;
    window.autoHunt = v;
    try{ if (window.player) window.player.auto = v; }catch(_){}
    updateAutoBtn();
  }

  function toggleAutoHunt(){
    const next = !((window.player && !!window.player.auto) || !!window.autoHunt);
    setAutoHunt(next);

    // ë²„íŠ¼ ì‚¬ìš´ë“œ(ìˆìœ¼ë©´) ì‚´ì§ë§Œ
    try{
      const s = document.getElementById("statBtnSound") || document.getElementById("applySound");
      if (s){ s.currentTime = 0; s.play().catch(()=>{}); }
    }catch(_){}
  }

  function updateAutoBtn(){
    if (!autoBtn) return;
    const on = (window.player && !!window.player.auto) || !!window.autoHunt;
    autoBtn.classList.toggle("on", on);
    autoBtn.setAttribute("aria-pressed", on ? "true" : "false");
    const sub = autoBtn.querySelector(".label .s");
    if (sub) sub.textContent = on ? "on" : "off";
  }

  if (autoBtn){
    autoBtn.addEventListener("pointerdown", (e)=>{
      e.preventDefault();
      toggleAutoHunt();
    }, {passive:false});
  }

  // playerê°€ ë‚˜ì¤‘ì— ìƒì„±ë  ìˆ˜ ìˆìœ¼ë‹ˆ ë£¨í”„ ì¤‘ì—ë„ ìƒíƒœ ìœ ì§€
  setInterval(()=>{
    try{
      if (window.player && typeof window.player.auto === "boolean"){
        window.autoHunt = !!window.player.auto;
      } else if (window.player && typeof window.player.auto !== "boolean"){
        // player.autoê°€ ì—†ìœ¼ë©´ ë§Œë“¤ì–´ì¤Œ(ê¸°ì¡´ ë¡œì§ì— ì˜í–¥ ìµœì†Œ)
        window.player.auto = !!window.autoHunt;
      }
    }catch(_){}
    updateAutoBtn();
  }, 250);
// ===== /AUTO HUNT BUTTON =====

// ê°„ë‹¨ ì¿¨ë‹¤ìš´(ë°ëª¨): 1~9 ê°ê° ì¿¨ë‹¤ìš´ ì‹œê°„(ì´ˆ). ì‹¤ì œ ìŠ¤í‚¬ êµ¬í˜„ ì‹œ ì—¬ê¸°ë§Œ ë°”ê¾¸ë©´ ë¨.
  const SKILL_CD = { 1:1.8, 2:2.2, 3:3.0, 4:1.2, 5:4.0, 6:2.6, 7:0.9, 8:5.0, 9:2.0 };
  const skillCooldownUntil = {}; // id -> timeSec(ì ˆëŒ€ì‹œê°„)

  // ê²Œì„ ë£¨í”„ ìª½ì—ì„œ ì“°ëŠ” time(ì´ˆ)ì„ ëª¨ë¥´ë¯€ë¡œ, perf.now ê¸°ë°˜ ìì²´ íƒ€ì´ë¨¸ ì‚¬ìš©
  const nowSec = ()=> performance.now() / 1000;

  function isSkillOnCooldown(id){
    return (skillCooldownUntil[id]||0) > nowSec();
  }
  function setSkillCooldown(id, cdSec){
    const until = nowSec() + Math.max(0, cdSec||0);
    skillCooldownUntil[id] = until;
    const el = skillSlots.find(s=> (s.dataset.skill|0) === (id|0));
    if(!el) return;
    el.classList.add("onCooldown");
  }

  function useSkill(id){
    id = id|0;
    // íŒ¨ë„ ì—´ë¦° ìƒíƒœë©´ ìŠ¤í‚¬ í´ë¦­/í‚¤ ì…ë ¥ ë¬´ì‹œ(ì˜¤ë™ì‘ ë°©ì§€)
    if (!statPanel.classList.contains("hide") || !invPanel.classList.contains("hide") || (typeof equipPanel!=="undefined" && equipPanel && !equipPanel.classList.contains("hide"))) return;

    if (isSkillOnCooldown(id)) return;

    // âœ… ì—¬ê¸°ì—ì„œ ì‹¤ì œ ìŠ¤í‚¬ íš¨ê³¼ë¥¼ êµ¬í˜„í•˜ë©´ ë©ë‹ˆë‹¤.
    // ì§€ê¸ˆì€ "ê°ì„± ì—°ì¶œ" ìš©ë„ë¡œë§Œ: ì•„ì£¼ ì•½í•œ í™”ë©´ í”ë“¤ë¦¼ + ì‚¬ìš´ë“œ(ìˆìœ¼ë©´)
    try{
      // statPlusSoundë¥¼ ì§§ê²Œ ì‚¬ìš©(ì›í•˜ë©´ ë³„ë„ ìŠ¤í‚¬ ì‚¬ìš´ë“œ ì¶”ê°€ ê°€ëŠ¥)
      if (statPlusSound){
        statPlusSound.currentTime = 0;
        statPlusSound.play().catch(()=>{});
      }
    }catch(_){}

    // ì¿¨ë‹¤ìš´ ë¶€ì—¬
    setSkillCooldown(id, SKILL_CD[id] ?? 1.5);
  }

  // í´ë¦­/í„°ì¹˜
  skillSlots.forEach(el=>{
    el.addEventListener("pointerdown", (e)=>{
      e.preventDefault();
      useSkill(el.dataset.skill|0);
    }, {passive:false});
  });

  // í‚¤ë³´ë“œ 1~9
  window.addEventListener("keydown", (e)=>{
    if (e.repeat) return;
    const k = e.key;
    if (k >= "1" && k <= "9"){
      useSkill(parseInt(k,10));
    }
  });

  // ì¿¨ë‹¤ìš´ UI ê°±ì‹  ë£¨í”„(ê°€ë²¼ìš´ requestAnimationFrame)
  (function cooldownLoop(){
    const t = nowSec();
    for (const el of skillSlots){
      const id = el.dataset.skill|0;
      const until = skillCooldownUntil[id]||0;
      const remain = until - t;
      const cdText = el.querySelector(".cdText");
      const cdLayer = el.querySelector(".cd");
      if (remain > 0){
        el.classList.add("onCooldown");
        // ë‚¨ì€ ì‹œê°„ í‘œì‹œ(ì†Œìˆ˜ 1ìë¦¬)
        if (cdText) cdText.textContent = remain.toFixed(1);
        // ê°„ë‹¨í•œ ì±„ì›€(ìœ„ì—ì„œ ì•„ë˜ë¡œ): ë‚¨ì€ ë¹„ìœ¨ì— ë”°ë¼ translateY
        const total = SKILL_CD[id] ?? 1.5;
        const ratio = Math.max(0, Math.min(1, remain / total));
        if (cdLayer) cdLayer.style.transform = `translateY(${(1-ratio)*100}%)`;
      }else{
        el.classList.remove("onCooldown");
        if (cdText) cdText.textContent = "";
        if (cdLayer) cdLayer.style.transform = "translateY(100%)";
      }
    }
    requestAnimationFrame(cooldownLoop);
  })();

// ===== ì¸ë²¤í† ë¦¬ UI =====
const invBtn = document.getElementById("invBtn");
const invPanel = document.getElementById("invPanel");

// ===== ì¥ë¹„ìƒíƒœ UI =====
const equipStatusBtn = document.getElementById("equipStatusBtn");
  // âœ… ë²„íŠ¼ í´ë¦­ì´ ì›”ë“œ ì…ë ¥(ì¡°ì´ìŠ¤í‹±)ìœ¼ë¡œ í˜ëŸ¬ê°€ì§€ ì•Šê²Œ ì°¨ë‹¨
  ["pointerdown","pointerup","click"].forEach(ev=>{
    equipStatusBtn.addEventListener(ev, (e)=>{ e.stopPropagation(); }, {passive:false});
  });

const equipPanel = document.getElementById("equipPanel");
  // âœ… ì¥ë¹„ íŒ¨ë„ ë‚´ë¶€ í´ë¦­ì€ "UI ì…ë ¥"ìœ¼ë¡œ ê³ ì • (ì¡°ì´ìŠ¤í‹±/ì›”ë“œ ì…ë ¥ ì°¨ë‹¨)
  ["pointerdown","click","dblclick","contextmenu"].forEach(ev=>{
    equipPanel.addEventListener(ev, (e)=>{ e.stopPropagation(); }, {passive:false});
  });

const equipGrid = document.getElementById("equipGrid");

// 3x4 ìŠ¬ë¡¯ ë ˆì´ì•„ì›ƒ(ì´ë¯¸ì§€ ëŠë‚ŒëŒ€ë¡œ)
const EQUIP_UI_SLOTS = [
  { key:"ear",    label:"ê·€ê±¸ì´" },
  { key:"helm",   label:"íˆ¬êµ¬"   },
  { key:"neck",   label:"ëª©ê±¸ì´" },

  { key:"tee",    label:"í‹°"     },
  { key:"armor",  label:"ê°‘ì˜·", bind:"armor" },
  { key:"cloak",  label:"ë§í† "   },

  { key:"ring1",  label:"ë°˜ì§€"   },
  { key:"belt",   label:"ë²¨íŠ¸"   },
  { key:"shield", label:"ë°©íŒ¨"   },

  { key:"weapon", label:"ë¬´ê¸°",  bind:"weapon" },
  { key:"glove",  label:"ì¥ê°‘"   },
  { key:"shoe",   label:"ì‹ ë°œ"   },
];

function buildEquipGridOnce(){
  if (!equipGrid) return;
  if (equipGrid.dataset.built === "1") return;
  equipGrid.dataset.built = "1";

  for (const s of EQUIP_UI_SLOTS){
    const d = document.createElement("div");
    d.className = "equipSlot";
    d.dataset.key = s.key;
    d.dataset.bind = (s.bind || s.key);

    const main = document.createElement("div");
    main.className = "main";
    main.textContent = s.label;

    const sub = document.createElement("div");
    sub.className = "sub";
    sub.textContent = "";

    d.appendChild(main);
    d.appendChild(sub);

    // âœ… ì¥ë¹„ ìŠ¬ë¡¯ í´ë¦­: ì¸ë²¤ì²˜ëŸ¼ íˆ´íŒ í† ê¸€
    d.addEventListener("click", (ev)=>{
      try{ ev.preventDefault(); ev.stopPropagation(); }catch(_){ }
      const b = d.dataset.bind || "";
      equipSelectedKey = (equipSelectedKey === b) ? "" : b;
      try{ renderEquipPanel(); }catch(_){ }
    });

    equipGrid.appendChild(d);
  }
}

function renderEquipPanel(){
  try{ buildEquipGridOnce(); }catch(_){}

  const eqW = document.getElementById("eq_weapon");
  const eqA = document.getElementById("eq_armor");
  const eqAC = document.getElementById("eq_ac");

  // equipment / playerëŠ” ê¸°ì¡´ ì½”ë“œì˜ ì „ì—­(ìƒë‹¨ì— constë¡œ ì •ì˜)
  const eq = (typeof equipment !== "undefined" && equipment) ? equipment : null;
  const pl = (typeof player !== "undefined" && player) ? player : null;

  // ìŠ¬ë¡¯ í…ìŠ¤íŠ¸ ê°±ì‹ 
  if (equipGrid){
    equipGrid.querySelectorAll(".equipSlot").forEach(slot=>{
      const key = slot.dataset.key;
      const slotDef = EQUIP_UI_SLOTS.find(x=>x.key===key);
      const bind = slotDef?.bind;

      const main = slot.querySelector(".main");
      const sub = slot.querySelector(".sub");
      let badge = slot.querySelector(".badge");
      if (badge) badge.remove();

      if (bind && eq && eq[bind]){
        const it = eq[bind];
        // âœ… ë¬´ê¸° ìŠ¬ë¡¯: ë‹¨ê²€ ì•„ì´ì½˜ì„ ìŠ¬ë¡¯ì— ê½‰ ì°¨ê²Œ í‘œì‹œ (ìŠ¬ë¡¯ ë ˆì´ì•„ì›ƒì€ ê·¸ëŒ€ë¡œ)
        if (bind === "weapon"){
          let iconSrc = (it && (it.icon || it.iconSrc)) ? (it.icon || it.iconSrc) : "";
          // âœ… ë§¨ì†(fist) ìƒíƒœì—ì„œëŠ” ì•„ì´ì½˜/íˆ´íŒ ì—†ì´ í…ìŠ¤íŠ¸ë§Œ
          const _isBareHand = !!it && (String(it.id||"") === "fist" || String(it.name||"") === "ë§¨ì†");
          if (_isBareHand) iconSrc = "";
          if (!iconSrc && (String(it?.name||"").includes("ë‹¨ê²€"))) iconSrc = "dagger.PNG";
          let img = slot.querySelector("img.eqIcon");
          if (iconSrc){
            slot.classList.add("hasIcon");
            if (!img){
              img = document.createElement("img");
              img.className = "eqIcon";
              slot.insertBefore(img, slot.firstChild);
            }
            img.src = iconSrc;
          }else{
            slot.classList.remove("hasIcon");
            if (img) img.remove();
          }
        }else{
          slot.classList.remove("hasIcon");
          const img = slot.querySelector("img.eqIcon");
          if (img) img.remove();
        }

        const enh = (it.enhance|0) || 0;
        const nm = (it.name || slotDef.label || "ì¥ë¹„");
        if (main) main.textContent = enh>0 ? `${nm}(+${enh})` : nm;

        // í•˜ë‹¨ì— ê°„ë‹¨ ìŠ¤íƒ¯(ë¬´ê¸°ëŠ” ATK, ë°©ì–´êµ¬ëŠ” DEF)
        if (sub){
          if (bind === "weapon"){
            
          }else if (bind === "armor"){
            const _isNoArmor = (String(it?.id||"") === "cloth" && (((it?.def|0)===0) && ((it?.atk|0)===0))) || String(it?.id||"") === "none" || String(it?.name||"") === "ì²œì˜·" || (String(it?.name||"") === "ê°‘ì˜·" && ((it?.def|0)===0));
            sub.textContent = _isNoArmor ? "" : `DEF +${(it.def|0)||0}`;
          }else{
            sub.textContent = "";
          }
        }

        if (enh > 0){
          badge = document.createElement("div");
          badge.className = "badge";
          badge.textContent = `+${enh}`;
          slot.appendChild(badge);
        }

        // âœ… ì¥ë¹„ ìŠ¬ë¡¯ í´ë¦­ì‹œ ì¸ë²¤í† ë¦¬ì²˜ëŸ¼ íˆ´íŒ í‘œì‹œ
        //    (ìš”êµ¬ì‚¬í•­) 'ë§¨ì†' / ë°©ì–´êµ¬ ë¯¸ì°©ìš©(ê¸°ë³¸ê°’) ìƒíƒœì—ì„œëŠ” íˆ´íŒ í‘œì‹œ ì•ˆ í•¨
        //    (ë²„ê·¸ fix) ê¸°ì¡´ íˆ´íŒ ëˆ„ì  ì œê±° + íˆ´íŒ í‘œì‹œ ì‹œ overflowë¥¼ visibleë¡œ
        const isBareHand = (bind === "weapon") && (String(it?.id||"") === "fist" || String(it?.name||"") === "ë§¨ì†");
        const isNoArmor  = (bind === "armor") && (
          (String(it?.id||"") === "cloth" && (((it?.def|0)===0) && ((it?.atk|0)===0))) ||
          String(it?.id||"") === "none" ||
          String(it?.name||"") === "ì²œì˜·" ||
          (String(it?.name||"") === "ê°‘ì˜·" && ((it?.def|0)===0))
        );

        slot.querySelectorAll(".itemTip").forEach(n => n.remove());
        slot.style.overflow = "hidden";
        if (equipSelectedKey === bind && !isBareHand && !isNoArmor){
          const tipText = (typeof getItemTipText === "function") ? getItemTipText(it) : "";
          if (tipText){
            const tip = document.createElement("div");
            tip.className = "itemTip";
            tip.textContent = tipText;
            slot.appendChild(tip);
            slot.style.overflow = "visible";
          }
        }
      }else{
        if (main) main.textContent = slotDef?.label || "-";
        // âœ… ë¹ˆ ìŠ¬ë¡¯ì´ë©´ ì•„ì´ì½˜ ëª¨ë“œ í•´ì œ
        slot.classList.remove("hasIcon");
        const _img = slot.querySelector("img.eqIcon");
        if (_img) _img.remove();

        if (sub) sub.textContent = "";
      }
    });
  }

  // í•˜ë‹¨ ìš”ì•½
  if (eqW && eq?.weapon){
    const w = eq.weapon;
    const enh = (w.enhance|0)||0;
    eqW.textContent = enh>0 ? `${w.name}(+${enh}) / ê³µê²©ë ¥ ${(w.atk|0)||0}` : `${w.name} / ê³µê²©ë ¥ ${(w.atk|0)||0}`;
  } else if (eqW){
    eqW.textContent = "-";
  }

  if (eqA && eq?.armor){
    const a = eq.armor;
    eqA.textContent = `${a.name} / ë°©ì–´ë ¥ ${(a.def|0)||0}`;
  } else if (eqA){
    eqA.textContent = "-";
  }

  // Armor Class: ë³´ê¸°ì¢‹ê²Œ (ê¸°ë³¸ì€ player.defë¥¼ ìŒìˆ˜ë¡œ í‘œê¸°)
  if (eqAC && pl){
    const ac = -((pl.def|0)||0);
    eqAC.textContent = String(ac);
  }
}

function openEquipPanel(){
  if(!equipPanel) return;
  // âœ… í˜¹ì‹œ ë“œë˜ê·¸ ë°”ì¸ë”©ì´ ëˆ„ë½ë˜ì—ˆì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´, ì—´ ë•Œ í•œ ë²ˆ ë” ë³´ì¥
  try{ makeDraggablePanel(equipPanel, { handleSelector: '.statHeader' }); }catch(_){ }

  // âœ… ì—´ë¦´ ë•Œ 'ë§ˆìš°ìŠ¤ì— ë¶™ëŠ”' í˜„ìƒ ë°©ì§€(ì´ì „ ë“œë˜ê·¸ ìƒíƒœ ê°•ì œ í•´ì œ)
  try{ equipPanel.__cancelDrag && equipPanel.__cancelDrag(); }catch(_){}

  // âœ… ì²˜ìŒ ì—´ ë•ŒëŠ” ì¤‘ì•™ìœ¼ë¡œ ë°°ì¹˜(ì´ë¯¸ ìœ„ì¹˜ê°€ ìˆìœ¼ë©´ ìœ ì§€)
  if(!equipPanel.style.left || !equipPanel.style.top){
    equipPanel.classList.remove("hide");
    // ë ˆì´ì•„ì›ƒ í™•ì •(ë„ˆë¹„/ë†’ì´ 0 ë°©ì§€)
    try{ void equipPanel.offsetWidth; }catch(_){}
    try{ centerPanel(equipPanel); }catch(_){}
    equipPanel.classList.add("hide");
  }

  renderEquipPanel();
  equipPanel.classList.remove("hide");
}
function closeEquipPanel(){
  if(!equipPanel) return;
  try{ equipPanel.__cancelDrag && equipPanel.__cancelDrag(); }catch(_){}
  equipPanel.classList.add("hide");
}

// ë²„íŠ¼ ë°”ì¸ë”© + ë‹«ê¸° ë²„íŠ¼
if (equipStatusBtn){
  equipStatusBtn.addEventListener("click", (e)=>{
    e.preventDefault();
    try{
      if (invBtnSound){
        invBtnSound.currentTime = 0;
        invBtnSound.play().catch(()=>{});
      }
    }catch(_){ }
    // âœ… ë‹¤ë¥¸ íŒ¨ë„ì´ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê³  ì¥ë¹„íŒ¨ë„ì„ ìµœìƒë‹¨ìœ¼ë¡œ
    try{
      if (equipPanel && !equipPanel.classList.contains("hide")) closeEquipPanel();
      else openEquipPanel();
    }catch(_){ }
  });
}
if (equipPanel){
  const closeBtn = equipPanel.querySelector(".btn.close");
  if (closeBtn) closeBtn.addEventListener("click", (e)=>{
    e.preventDefault();
    try{
      if (invBtnSound){
        invBtnSound.currentTime = 0;
        invBtnSound.play().catch(()=>{});
      }
    }catch(_){ }
    closeEquipPanel();
  });

  // íŒ¨ë„ ë°°ê²½ í´ë¦­ ì‹œ ì„ íƒíš¨ê³¼ ì—†ìŒ(ë‹¨ìˆœ ì˜¤ë™ì‘ ë°©ì§€)
  equipPanel.addEventListener("pointerdown", (e)=>{
    // ì¸ë²¤/ìŠ¤íƒ¯ì˜ ë²„íŠ¼ í´ë¦­ íë¦„ ë°©í•´ ê¸ˆì§€
    e.stopPropagation();
  }, {passive:false});
}



// âœ… ì¸ë²¤ íŒ¨ë„ 'ë¹ˆ ê³µê°„' í„°ì¹˜/í´ë¦­í•˜ë©´ (ì°©ìš©/í•´ì œ ë²„íŠ¼ í¬í•¨) ì„ íƒ ì·¨ì†Œí•´ì„œ ë²„íŠ¼ ìˆ¨ê¹€
if (invPanel){
  invPanel.addEventListener("pointerdown", (e)=>{
    try{
      if (typeof invSelectedAbsIndex !== "undefined" && invSelectedAbsIndex !== -1){
        // ìŠ¬ë¡¯(ì•„ì´í…œ) í´ë¦­ì€ ê¸°ì¡´ ë¡œì§ëŒ€ë¡œ ì²˜ë¦¬í•˜ê³ , íŒ¨ë„ ë°°ê²½/ì—¬ë°± í´ë¦­ë§Œ ì·¨ì†Œ ì²˜ë¦¬
        if (!e.target.closest(".equipBtn")){
          invSelectedAbsIndex = -1;
          if (typeof renderInventoryPage === "function") renderInventoryPage();
        }
      }
    }catch(_){}
  }, {passive:true});
}
const invGrid = document.getElementById("invGrid");
const invPrev = document.getElementById("invPrev");
const invNext = document.getElementById("invNext");
const invPageText = document.getElementById("invPageText");

// âœ… ì¸ë²¤ ë°ì´í„°(25ì¹¸ 1í˜ì´ì§€ ê¸°ì¤€). ë“œë/íšë“ ì‹œ window.inventoryë§Œ ì—…ë°ì´íŠ¸í•˜ë©´ ë©ë‹ˆë‹¤.
// item: { name, qty }
if (!window.inventory) window.inventory = [];

// ===================== DAGGER / EQUIPMENT INVENTORY HELPERS =====================
// âœ… ì¥ë¹„ë¥˜ëŠ” ì¸ë²¤ì—ì„œ ìŠ¤íƒ ê¸ˆì§€(1ì¹¸=1ì¥ë¹„), ì†Œëª¨í’ˆì€ ìŠ¤íƒ í—ˆìš©
function addItemToInventory(item){
  if(!item) return;
  if(!window.inventory) window.inventory = [];

  const isEquipment =
    !!(item.isEquip || item.equipSlot || item.type === "equip") ||
    ("atk" in item) || ("def" in item) || ("hit" in item) || ("eva" in item) ||
    ("critChance" in item) || ("critMult" in item);

  const id   = item.id || item.name || "item";
  const name = item.name || "ì•„ì´í…œ";
  const icon = item.icon || null;

  if (isEquipment){
    const uid = (crypto && crypto.randomUUID)
      ? crypto.randomUUID()
      : ("eq_" + Date.now() + "_" + Math.floor(Math.random()*1e9));

    window.inventory.push({
      uid,
      id, name, icon,
      qty: 1,
      equipSlot: item.equipSlot || "weapon",
      // âœ… baseAtk / enhance / atk(ìµœì¢…) ë¶„ë¦¬
      baseAtk: (("baseAtk" in item) ? (item.baseAtk|0) : (item.atk|0)) || 0,
      atk: (((("baseAtk" in item) ? (item.baseAtk|0) : (item.atk|0)) || 0) + (item.enhance|0 || 0)),

      def: item.def|0 || 0,
      hit: item.hit|0 || 0,
      eva: item.eva|0 || 0,
      critChance: +item.critChance || 0,
      critMult: +item.critMult || 0,
      enhance: item.enhance|0 || 0,
       fixedAtk: !!item.fixedAtk
    });
  } else {
    // âœ… ì†Œëª¨í’ˆ ìŠ¤íƒ: ê¸°ë³¸ì€ ê¸°ì¡´ì²˜ëŸ¼ ê³„ì† í•©ì‚°
    // âœ… ë‹¨, 'ë¬´ê¸°ê°•í™”ì£¼ë¬¸ì„œ(weapon_enforce_scroll)'ë§Œ 1ìŠ¬ë¡¯ ìµœëŒ€ 100ê°œê¹Œì§€ë§Œ ìŠ¤íƒ
    const qtyAdd = Math.max(1, item.qty|0 || 1);
    const maxStack = (id === "weapon_enforce_scroll") ? 100 : 999999999;

    let remain = qtyAdd;

    // ê°™ì€ ì•„ì´í…œ ìŠ¤íƒì— ë¨¼ì € ì±„ìš°ê¸° (maxStack ë¯¸ë§Œì¸ ìŠ¬ë¡¯)
    while (remain > 0) {
      const exist = window.inventory.find(it => it && !it.uid && ((it.id||it.name) === id) && ((it.qty|0 || 1) < maxStack));
      if (exist){
        const cur = (exist.qty|0 || 1);
        const add = Math.min(remain, maxStack - cur);
        exist.qty = cur + add;

        if (!exist.icon && icon) exist.icon = icon;
        if (!exist.name) exist.name = name;
        if (!exist.id) exist.id = id;

        remain -= add;
      } else {
        const add = Math.min(remain, maxStack);
        window.inventory.push({ id, name, icon, qty: add });
        remain -= add;
      }
    }
  }

  try{
    if (typeof renderInventoryPage === "function" && invPanel && !invPanel.classList.contains("hide")){
      renderInventoryPage();
    }
  }catch(e){}
}

// âœ… ì‹œì‘ ì‹œ ë‹¨ê²€ 1ê°œ ì§€ê¸‰(ì¤‘ë³µ ë°©ì§€)
(function ensureStartDagger(){
  try{
    if(!window.inventory) window.inventory = [];
    const has = window.inventory.some(it => it && ((it.id === "dagger") || (it.name === "ë‹¨ê²€")));
    if(!has){
      addItemToInventory({
        id:"dagger",
        name:"ë‹¨ê²€",
        icon:"dagger.PNG",
        qty:1,
        equipSlot:"weapon",
        baseAtk:5,
        enhance:0,
        atk:5,
        fixedAtk:true
      });
    }
  }catch(e){}
})();



// âœ… ìµœì´ˆ ê²Œì„ ì ‘ì†(ì„¸ì´ë¸Œê°€ ì—†ëŠ” ìƒíƒœ)ì—ì„œë§Œ ë¬´ê¸°ê°•í™”ì£¼ë¬¸ì„œ 10ê°œ ì§€ê¸‰
//    ì´í›„ ì¬ì ‘ì† ì‹œì—ëŠ” ë‚¨ì•„ìˆë˜ ìˆ˜ëŸ‰(ì„¸ì´ë¸Œëœ qty)ì„ ê·¸ëŒ€ë¡œ ìœ ì§€í•©ë‹ˆë‹¤.
function ensureStartWeaponEnhanceScroll(){
  try{
    // âœ… 'ìµœì´ˆ 1íšŒë§Œ' ì§€ê¸‰ì„ ë³´ì¥í•˜ê¸° ìœ„í•œ ì „ìš© í”Œë˜ê·¸
    //    (ì„¸ì´ë¸Œê°€ ë¨¼ì € ìƒì„±ë˜ëŠ” ê²½ìš°ê°€ ìˆì–´ SAVE_KEY ì¡´ì¬ì—¬ë¶€ë§Œìœ¼ë¡œ íŒë‹¨í•˜ë©´ ëˆ„ë½ë  ìˆ˜ ìˆìŒ)
    const GIVEN_KEY = "weapon_enforce_scroll_given_v1";
    let alreadyGiven = false;
    try{ alreadyGiven = (localStorage.getItem(GIVEN_KEY) === "1"); }catch(_){}

    if(!window.inventory) window.inventory = [];

    // í˜„ì¬ ì¸ë²¤ì— ì£¼ë¬¸ì„œê°€ ìˆëŠ”ì§€ í™•ì¸
    const has = window.inventory.some(it => it && !it.uid && ((it.id === "weapon_enforce_scroll") || /ë¬´ê¸°.?ê°•í™”.?ì£¼ë¬¸ì„œ/.test(it.name||"")));

    // âœ… ì•„ì§ í•œ ë²ˆë„ ì§€ê¸‰í•œ ì  ì—†ê³ , ì¸ë²¤ì—ë„ ì—†ìœ¼ë©´ 10ê°œ ì§€ê¸‰
    if(!alreadyGiven && !has){
      addItemToInventory({
        id:"weapon_enforce_scroll",
        name:"ë¬´ê¸°ê°•í™”ì£¼ë¬¸ì„œ",
        icon:"enforce.PNG",
        qty:10,
        type:"consumable",
        useType:"enhanceWeaponOnly",
        desc:"ë¬´ê¸°ë§Œ ê°•í™”í•©ë‹ˆë‹¤.\nì‚¬ìš© ì‹œ ê°•í™”ìˆ˜ì¹˜ +1"
      });

      // í”Œë˜ê·¸ ì €ì¥ + ì¦‰ì‹œ ì €ì¥(ë‚¨ì€ ìˆ˜ëŸ‰ ìœ ì§€ ëª©ì )
      try{ localStorage.setItem(GIVEN_KEY, "1"); }catch(_){}
      try{ if (typeof saveToLocal === "function") saveToLocal(); }catch(_){}
    }
  }catch(e){}
}
window.ensureStartWeaponEnhanceScroll = ensureStartWeaponEnhanceScroll;
window.addItemToInventory = addItemToInventory;

// âœ… ìµœì´ˆ ì ‘ì†(ì„¸ì´ë¸Œ ì—†ìŒ)ì¼ ë•Œë§Œ 10ê°œ ì§€ê¸‰
try{ if (typeof window.ensureStartWeaponEnhanceScroll === 'function') window.ensureStartWeaponEnhanceScroll(); }catch(e){}
// ==============================================================================

 // ì˜ˆ: {name:"í¬ì…˜", qty:3}
let invPage = 0;

function invTotalPages(){
  return Math.max(1, Math.ceil((window.inventory.length || 0) / 25));
}

function isWeaponItem(it){
  if(!it) return false;
  if (it.equipSlot === "weapon") return true;
  if ((it.id||"") === "dagger") return true;
  if (/ë‹¨ê²€/.test(it.name||"")) return true;
  return false;
}

function isEnhanceScrollItem(it){
  if(!it) return false;
  const id = (it.id||"");
  // ê¸°ì¡´ ê°•í™”ì£¼ë¬¸ì„œ + ì‹ ê·œ ë¬´ê¸°ê°•í™”ì£¼ë¬¸ì„œ(enforce.PNG)
  if (id === "enhance_scroll" || id === "weapon_enhance_scroll" || id === "weapon_enforce_scroll") return true;
  const nm = (it.name||"");
  if (/ê°•í™”.?ì£¼ë¬¸ì„œ/.test(nm)) return true;
  if (/ë¬´ê¸°.?ê°•í™”.?ì£¼ë¬¸ì„œ/.test(nm)) return true;
  return (it.useType === "enhanceWeapon" || it.useType === "enhanceWeaponOnly");
}

// âœ… ê°•í™” ì ìš©(ì¸ë²¤ ì•„ì´í…œ + ì¥ì°© ì¥ë¹„ ë™ê¸°í™”)
function applyEnhanceToWeaponByUid(targetUid, add){
  if(!targetUid) return false;
  const amt = (add|0) || 0;
  if(!amt) return false;

  // 1) ì¸ë²¤ ì•„ì´í…œ ì—…ë°ì´íŠ¸
  const inv = window.inventory || [];
  const wItem = inv.find(it => it && it.uid === targetUid);
  if(!wItem) return false;

  const baseAtk = (("baseAtk" in wItem) ? (wItem.baseAtk|0) : (wItem.atk|0)) || 0;
  wItem.baseAtk = baseAtk;
  wItem.enhance = (wItem.enhance|0) + amt;
  // âœ… atkëŠ” 'ê¸°ë³¸ ê³µê²©ë ¥'ë¡œ ìœ ì§€í•˜ê³ , ê°•í™”ëŠ” enhanceì—ë§Œ ëˆ„ì  (í‘œì‹œìš© +nì´ ì „íˆ¬ê³µê²©ë ¥ì— ì¤‘ë³µ ë°˜ì˜ë˜ëŠ” ë²„ê·¸ ë°©ì§€)
  wItem.atk = (wItem.baseAtk|0);

  // 2) ì¥ì°© ì¤‘ì´ë©´ ì¥ë¹„ì—ë„ ë°˜ì˜
  try{
    const eq = window.equipment?.weapon;
    if(eq && eq.uid && eq.uid === targetUid){
      eq.baseAtk = baseAtk;
      eq.enhance = (wItem.enhance|0);
      // âœ… ì¥ì°© ë¬´ê¸°ë„ ë™ì¼í•˜ê²Œ baseAtk ìœ ì§€
      eq.atk = (wItem.baseAtk|0);
      window.recalcCombatStats?.();
    }
  }catch(_){}

  try{ saveToLocal?.(); }catch(_){}
  return true;
}

function ensureEnhanceModal(){
  if (document.getElementById("enhanceModal")) return;
  const modal = document.createElement("div");
  modal.id = "enhanceModal";
  modal.innerHTML = `
    <div id="enhanceBox" role="dialog" aria-modal="true">
      <div id="enhanceHead">
        <div class="enhHeadLeft" style="width:100%; text-align:center;">
          <div id="enhanceTitle">ë¬´ê¸°ë¥¼ ê°•í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
        </div>
        <button id="enhanceClose" type="button" aria-label="ë‹«ê¸°" title="ë‹«ê¸°">Ã—</button>
      </div>

      <div id="enhanceBody">
        <div id="enhanceHint">ê°•í™”í•  ë¬´ê¸°ë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>
        <div id="enhanceGrid"></div>

        <div id="enhanceConfirm" aria-live="polite">
          <div id="enhanceQuestion">ì´ ë¬´ê¸°ë¥¼ ê°•í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
          <div class="enhActions">
            <button id="enhYes" class="enhBtn" type="button">ë¬´ê¸°ë¥¼ ê°•í™”í•˜ë¼</button>
            <button id="enhNo" class="enhBtn" type="button">ë– ë‚œë‹¤</button>
          </div>
        </div>
      </div>
    </div>
`;
  document.body.appendChild(modal);

  // ë°°ê²½ í´ë¦­ ë‹«ê¸°
  modal.addEventListener("pointerdown", (e)=>{
    if (e.target === modal) closeWeaponEnhancePanel();
  });
  modal.querySelector("#enhanceClose").addEventListener("click", closeWeaponEnhancePanel);
    modal.querySelector("#enhNo").addEventListener("click", closeWeaponEnhancePanel);

  // âœ… ë“œë˜ê·¸(ë§ˆìš°ìŠ¤/í„°ì¹˜)ë¡œ ê°•í™”íŒë„¬ ì´ë™
  setupEnhanceDrag(modal);

}

function setupEnhanceDrag(modal){
  try{
    const box = modal.querySelector("#enhanceBox");
    const head = modal.querySelector("#enhanceHead");
    if(!box || !head) return;

    // ì´ˆê¸° ìœ„ì¹˜(ì¤‘ì•™)
    function centerBox(){
      box.style.left = "50%";
      box.style.top = "50%";
      box.style.transform = "translate(-50%, -50%)";
    }
    centerBox();

    let dragging = false;
    let offX = 0, offY = 0;

    const clamp = (v, a, b)=> Math.max(a, Math.min(b, v));

    head.addEventListener("pointerdown", (e)=>{
      // í—¤ë”ì—ì„œë§Œ ë“œë˜ê·¸ ì‹œì‘
      if(e.button !== undefined && e.button !== 0) return; // left click only
      e.preventDefault();
      head.setPointerCapture?.(e.pointerId);

      const r = box.getBoundingClientRect();
      dragging = true;
      box.classList.add("dragging");

      offX = e.clientX - r.left;
      offY = e.clientY - r.top;

      // ë“œë˜ê·¸ ëª¨ë“œë¡œ ì „í™˜ (transform ì œê±°)
      box.style.transform = "none";
      box.style.left = `${r.left}px`;
      box.style.top  = `${r.top}px`;
    });

    head.addEventListener("pointermove", (e)=>{
      if(!dragging) return;
      e.preventDefault();

      const vw = window.innerWidth;
      const vh = window.innerHeight;
      const r = box.getBoundingClientRect();

      let nx = e.clientX - offX;
      let ny = e.clientY - offY;

      // í™”ë©´ ë°–ìœ¼ë¡œ ì•ˆ ë‚˜ê°€ê²Œ í´ë¨í”„(ì•½ê°„ ì—¬ìœ )
      const pad = 6;
      nx = clamp(nx, pad, vw - r.width - pad);
      ny = clamp(ny, pad, vh - r.height - pad);

      box.style.left = `${nx}px`;
      box.style.top  = `${ny}px`;
    });

    const endDrag = (e)=>{
      if(!dragging) return;
      dragging = false;
      box.classList.remove("dragging");
      try{ head.releasePointerCapture?.(e.pointerId); }catch(_){}
    };

    head.addEventListener("pointerup", endDrag);
    head.addEventListener("pointercancel", endDrag);

    // ì°½ ë¦¬ì‚¬ì´ì¦ˆ ì‹œ, ë„ˆë¬´ ë°–ìœ¼ë¡œ ë‚˜ê°€ ìˆìœ¼ë©´ ë‹¤ì‹œ í´ë¨í”„
    window.addEventListener("resize", ()=>{
      if(modal.classList.contains("show")){
        const r = box.getBoundingClientRect();
        const vw = window.innerWidth;
        const vh = window.innerHeight;
        const pad = 6;
        let nx = clamp(r.left, pad, vw - r.width - pad);
        let ny = clamp(r.top,  pad, vh - r.height - pad);
        box.style.transform = "none";
        box.style.left = `${nx}px`;
        box.style.top  = `${ny}px`;
      }
    }, {passive:true});

    // ëª¨ë‹¬ ì—´ë¦´ ë•Œë§ˆë‹¤ ì¤‘ì•™ìœ¼ë¡œ ë¦¬ì…‹í•˜ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ:
    // modal.addEventListener("show", centerBox);

  }catch(err){
    console.error("setupEnhanceDrag error:", err);
  }
}


let _enhState = { scrollAbsIndex:-1, selectedUid:null };

function openWeaponEnhancePanel(scrollAbsIndex){
  const inv = window.inventory || [];
  const scroll = inv[scrollAbsIndex];
  if(!scroll || !isEnhanceScrollItem(scroll)) return;

  ensureEnhanceModal();
  _enhState.scrollAbsIndex = scrollAbsIndex;
  _enhState.selectedUid = null;

  const modal = document.getElementById("enhanceModal");
  const grid  = modal.querySelector("#enhanceGrid");
  const confirm = modal.querySelector("#enhanceConfirm");
  // âœ… ì„œë¸Œ íŒë„¬ì€ ì²˜ìŒë¶€í„° ë³´ì´ë˜, ì„ íƒ ì „ì—ëŠ” ë²„íŠ¼ì„ ìˆ¨ê¹€
  confirm.classList.add("show");
  confirm.classList.remove("armed");
  try{ modal.querySelector("#enhanceQuestion").textContent = ""; }catch(_){ }


  grid.innerHTML = "";

  // ê°•í™” ê°€ëŠ¥í•œ ëŒ€ìƒ: ì¸ë²¤ ë‚´ 'ë¬´ê¸°'ë§Œ
  const weapons = inv.filter(it => it && it.uid && isWeaponItem(it));
  if (!weapons.length){
    showTopNotice?.("ê°•í™”í•  ë¬´ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const maxSlots = 12; // 4 x 3
  const showWeapons = weapons.slice(0, maxSlots);

  showWeapons.forEach((w)=>{
    const slot = document.createElement("div");
    slot.className = "enhWSlot";
    slot.dataset.uid = w.uid;

    if (w.icon){
      const img = document.createElement("img");
      img.src = w.icon;
      img.alt = w.name || "weapon";
      img.draggable = false;
      slot.appendChild(img);
    }

    const nm = document.createElement("div");
    nm.className = "wName";
    const enh = (w.enhance|0);
    nm.textContent = (w.name||"ë¬´ê¸°");
    slot.appendChild(nm);

    // ê¸°ì¡´ ë°°ì§€ ìŠ¤íƒ€ì¼ ì¬ì‚¬ìš©(ìš°ì¸¡ ìƒë‹¨ +n)
    if ((w.enhance|0) > 0){
      const bd = document.createElement("div");
      bd.className = "enhBadge";
      bd.textContent = `+${w.enhance|0}`;
      slot.appendChild(bd);
    }

    slot.addEventListener("click", ()=>{
      // ì„ íƒ í‘œì‹œ
      grid.querySelectorAll(".enhWSlot").forEach(el=>el.classList.remove("sel"));
      slot.classList.add("sel");
      _enhState.selectedUid = w.uid;
      confirm.classList.add("show");
      confirm.classList.add("armed");
      try{ modal.querySelector("#enhanceQuestion").textContent = "ë¬´ê¸°ë¥¼ ê°•í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"; }catch(_){ }

    });

    grid.appendChild(slot);
  });

  // ë¹ˆ ìŠ¬ë¡¯ ì±„ìš°ê¸°(4x3 ìœ ì§€)
  for(let i=showWeapons.length;i<maxSlots;i++){
    const empty = document.createElement("div");
    empty.className = "enhWSlot empty";
    grid.appendChild(empty);
  }


  // ë„¤ ë²„íŠ¼ì€ ë§¤ë²ˆ ìµœì‹  ìƒíƒœë¡œ ë™ì‘í•˜ë„ë¡ ì—¬ê¸°ì„œ ë°”ì¸ë”©
  const yesBtn = modal.querySelector("#enhYes");
  yesBtn.onclick = ()=>{
    try{
      const uid = _enhState.selectedUid;
      if(!uid){
        showTopNotice?.("ê°•í™”í•  ë¬´ê¸°ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }
      const inv2 = window.inventory || [];
      const scroll2 = inv2[_enhState.scrollAbsIndex];
      if(!scroll2 || !isEnhanceScrollItem(scroll2)){
        showTopNotice?.("ì£¼ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.");
        closeWeaponEnhancePanel();
        return;
      }

      const wItem2 = inv2.find(it => it && it.uid === uid);
      if(!wItem2){
        showTopNotice?.("ê°•í™” ì‹¤íŒ¨(ëŒ€ìƒì„ ì°¾ì§€ ëª»í•¨)");
        return;
      }

      const curEnh = (wItem2.enhance|0);
      const nextEnh = curEnh + 1;

      // âœ… ê°•í™” í™•ë¥ : +3ê¹Œì§€ 100%, +4ë¶€í„° 60%
      let success = true;
      if(nextEnh <= 3){
        success = true;
      }else{
        success = (Math.random() < 0.60);
      }

      let resultMsg = "";
      let resultColor = null;
      if(success){
        const ok = applyEnhanceToWeaponByUid(uid, 1);
        if(!ok){
          showTopNotice?.("ê°•í™” ì‹¤íŒ¨(ëŒ€ìƒì„ ì°¾ì§€ ëª»í•¨)");
          return;
        }
        // âœ… ì„±ê³µ: ì‹¤ì œ ê°•í™”ëœ ìˆ˜ì¹˜ë¡œ í‘œì‹œ
        let _newEnh = 0;
        try{
          const _wNow = (inv2 || window.inventory || inventory || []).find(it => it && it.uid === uid);
          _newEnh = (_wNow && (_wNow.enhance|0)) ? (_wNow.enhance|0) : (curEnh + 1);
        }catch(_){
          _newEnh = (curEnh + 1);
        }
        resultMsg = `ê°•í™”ì„±ê³µ +${_newEnh}`;
      }else{
        // âœ… ì‹¤íŒ¨(40%): 'ë¬´ê¸° íŒŒê´´' ë˜ëŠ” 'ê°•í™”ìˆ˜ì¹˜ 0 ì´ˆê¸°í™”' (ê° 50%)
        const breakWeapon = (Math.random() < 0.50);

        if(breakWeapon){
          // ë¬´ê¸° íŒŒê´´(ì¸ë²¤ì—ì„œ ì œê±°)
          const wi = inv2.findIndex(it => it && it.uid === uid);
          if(wi >= 0) inv2.splice(wi, 1);

          // ì¥ì°© ì¤‘ì´ë©´ í•´ì œ
          try{
            const eq = (window.equipment && window.equipment.weapon) ? window.equipment.weapon
                      : (typeof equipment !== "undefined" ? equipment.weapon : null);
            if(eq && eq.uid && eq.uid === uid){
              window.unequipWeapon?.();
            }else{
              window.recalcCombatStats?.();
            }
          }catch(_){}

          resultMsg = "ê°•í™”ì‹¤íŒ¨! (ë¬´ê¸°íŒŒê´´)";
          resultColor = "rgb(255,1,1)";
        }else{
          // ê°•í™”ìˆ˜ì¹˜ ì´ˆê¸°í™”(0)
          const baseAtk2 = (("baseAtk" in wItem2) ? (wItem2.baseAtk|0) : (wItem2.atk|0)) || 0;
          wItem2.baseAtk = baseAtk2;
          wItem2.enhance = 0;
          wItem2.atk = baseAtk2;

          // ì¥ì°© ì¤‘ì´ë©´ ì¥ì°© ë¬´ê¸°ë„ ë™ê¸°í™”
          try{
            const eq = (window.equipment && window.equipment.weapon) ? window.equipment.weapon
                      : (typeof equipment !== "undefined" ? equipment.weapon : null);
            if(eq && eq.uid && eq.uid === uid){
              eq.baseAtk = baseAtk2;
              eq.enhance = 0;
              eq.atk = baseAtk2;
            }
            window.recalcCombatStats?.();
          }catch(_){}

          resultMsg = "ê°•í™”ì‹¤íŒ¨! (ê°•í™”ìˆ˜ì¹˜ ì´ˆê¸°í™”)";
          resultColor = "rgb(255,143,44)";
        }
      }

      // ì£¼ë¬¸ì„œ ì°¨ê°(ìŠ¤íƒ) - ì„±ê³µ/ì‹¤íŒ¨ ëª¨ë‘ ì†Œëª¨
      scroll2.qty = (scroll2.qty|0) - 1;
      if(scroll2.qty <= 0){
        inv2.splice(_enhState.scrollAbsIndex, 1);
      }

      invSelectedAbsIndex = -1;
      try{ saveToLocal?.(); }catch(_){}

      closeWeaponEnhancePanel();
      renderInventoryPage?.();
      showTopNotice?.(resultMsg, 850, resultColor);

      
      // âœ… ê°•í™” ì‹¤íŒ¨ íš¨ê³¼ìŒ
      if(!success){
        try{
          const sid = (String(resultMsg||"").includes("ë¬´ê¸°íŒŒê´´")) ? "enhanceBreakSound" : "enhanceResetSound";
          const a = document.getElementById(sid);
          a && (a.currentTime = 0, a.play());
        }catch(e){}
      }
// âœ… ê°•í™” ì„±ê³µ íš¨ê³¼ìŒ(ì„±ê³µì‹œì—ë§Œ)
      if(success){
        try{
          const s = document.getElementById("enhanceSuccessSound");
          s && (s.currentTime = 0, s.play());
        }catch(e){}
      }

    }catch(_){}
  };

  modal.classList.add("show");
}

function closeWeaponEnhancePanel(){
  const modal = document.getElementById("enhanceModal");
  if(modal) modal.classList.remove("show");
  _enhState.scrollAbsIndex = -1;
  _enhState.selectedUid = null;
}

function useEnhanceScroll(scrollAbsIndex){
  // âœ… ê°•í™”ì£¼ë¬¸ì„œ ì‚¬ìš© ì‹œ: 'ê°•í™”í•  ë¬´ê¸° ì„ íƒ' íŒ¨ë„ ì˜¤í”ˆ
  openWeaponEnhancePanel(scrollAbsIndex);
}

function isSameEquippedWeapon(it){
  try{
    const w = window.equipment?.weapon;
    // âœ… ì¥ë¹„ ì°©ìš© í‘œì‹œëŠ” "uid" ê¸°ì¤€ìœ¼ë¡œë§Œ íŒì • (ê°™ì€ ì´ë¦„/ID ì¥ë¹„ê°€ ì—¬ëŸ¬ ê°œì—¬ë„ 1ê°œë§Œ E)
    if(!w || !w.uid || !it || !it.uid) return false;
    return w.uid === it.uid;
  }catch(e){
    return false;
  }
}
var invSelectedAbsIndex = -1;
var equipSelectedKey = ""; // e.g. 'weapon','armor','ac'


function getItemTipText(it){
  if (!it) return "";
  const baseName = it.name || "ì•„ì´í…œ";

  // âœ… ë¬´ê¸°(ì˜ˆ: ë‹¨ê²€) íˆ´íŒ: ì´ë¦„(+n) + ë¶„ë¦¬ì„  + ê³µê²©ë ¥(ìµœì¢…)
  if (typeof isWeaponItem === "function" && isWeaponItem(it)){
    const baseAtk = (("baseAtk" in it) ? (+it.baseAtk||0) : (+it.atk||0));
    const enh = (+it.enhance || 0);
    const totalAtk = baseAtk + enh;

    const nameLine = (enh > 0) ? `${baseName} +${enh}` : baseName;
    return [
      nameLine,
      "â”€â”€â”€â”€â”€â”€",
      `ê³µê²©ë ¥: ${baseAtk}`,
      "â”€â”€â”€â”€â”€â”€",
    "-ì´ˆë³´ìê²€"
    ].join("\n");
  }


  // âœ… ê°•í™”ì£¼ë¬¸ì„œ íˆ´íŒ(ì „ìš© ë¬¸êµ¬)
if (typeof isEnhanceScrollItem === "function" && isEnhanceScrollItem(it)) {
  return [
    baseName, // 'ë¬´ê¸°ê°•í™”ì£¼ë¬¸ì„œ'
    "â”€â”€â”€â”€â”€â”€",
    "ë¬´ê¸°ê³µê²©ë ¥ +10ê°•í™”",
    "â”€â”€â”€â”€â”€â”€",
    "â€»ì£¼ì˜:+3ê¹Œì§€ ì•ˆì „ê°•í™”"
  ].join("\n");
}


  // âœ… ê·¸ ì™¸ ì•„ì´í…œ: desc/description/tip ìš°ì„ 
  const lines = [baseName];
  const desc = it.desc || it.description || it.tip || "";
  if (desc){
    lines.push("â”€â”€â”€â”€â”€â”€");
    lines.push(String(desc));
  }
  return lines.join("\n");
}



function renderInventoryPage(){
  if (!invGrid) return;
  invGrid.innerHTML = "";
  const total = invTotalPages();
  invPage = Math.max(0, Math.min(total-1, invPage));

  const start = invPage * 25;
  const end = start + 25;
  const pageItems = (window.inventory || []).slice(start, end);

  for (let i=0;i<25;i++){
    const it = pageItems[i] || null;
    const absIndex = start + i;

    const slot = document.createElement("div");
    slot.className = "invSlot " + (it ? "" : "empty");

    if (it){
      slot.title = it.name || "ì•„ì´í…œ";

      if (it.icon){
        const img = document.createElement("img");
        img.src = it.icon;
        img.alt = it.name || "item";
        img.draggable = false;
        img.style.width = "100%";
        img.style.height = "100%";
        img.style.objectFit = "cover";
        img.style.filter = "drop-shadow(0 6px 10px rgba(0,0,0,0.35))";
        slot.appendChild(img);
      } else {
        slot.textContent = it.name || "ì•„ì´í…œ";
      }

      if (typeof it.qty === "number" && it.qty > 1){
        const q = document.createElement("div");
        q.className = "qty";
        q.textContent = it.qty;
        slot.appendChild(q);
      }



      
      // âœ… ê°•í™” ë°°ì§€(+n): ì¥ë¹„(enhance>0)ë©´ ì•„ì´ì½˜ ìš°ì¸¡ ìƒë‹¨ì— í‘œì‹œ
      if (it.uid && ((it.enhance|0) > 0)){
        const bd = document.createElement("div");
        bd.className = "enhBadge";
        bd.textContent = `+${it.enhance|0}`;
        slot.appendChild(bd);
      }

// âœ… ì„ íƒëœ ìŠ¬ë¡¯ì´ë©´ íˆ´íŒ(ì•„ì´í…œ ì„¤ëª…) í‘œì‹œ
      if (invSelectedAbsIndex === absIndex){
        const tipText = getItemTipText(it);
        if (tipText){
          const tip = document.createElement("div");
          tip.className = "itemTip";
          tip.textContent = tipText;
          slot.appendChild(tip);
        }
      }
      slot.addEventListener("click", (ev)=>{
        ev.preventDefault();
        invSelectedAbsIndex = (invSelectedAbsIndex === absIndex) ? -1 : absIndex;
        renderInventoryPage();
      });

      // âœ… E í‘œì‹œ(ì°©ìš©ì¤‘)
      if (isSameEquippedWeapon(it)){
        const em = document.createElement("div");
        em.className = "equipMark";
        em.textContent = "E";
        slot.appendChild(em);
      }

      // âœ… ì„ íƒëœ ìŠ¬ë¡¯ + ë¬´ê¸°ë©´ ì°©ìš©/í•´ì œ ë²„íŠ¼
      if (invSelectedAbsIndex === absIndex && isWeaponItem(it)){
        const equippedNow = isSameEquippedWeapon(it);

        const b = document.createElement("button");
        b.className = "equipBtn";
        b.type = "button";
        b.textContent = equippedNow ? "í•´ì œ" : "ì°©ìš©";

        b.addEventListener("click", (e2)=>{
          e2.preventDefault();
          e2.stopPropagation();

          try{
            if (equippedNow){
              window.unequipWeapon?.();
            } else {
              // ë‹¨ê²€ ìŠ¤í™ ê¸°ë³¸ê°’(ìš”êµ¬ì‚¬í•­) + baseAtk/enhance/atk ë¶„ë¦¬
              it.id = it.id || "dagger";
              it.name = it.name || "ë‹¨ê²€";
              it.equipSlot = "weapon";
              if (!("baseAtk" in it)) it.baseAtk = 5;
              if (!("enhance" in it)) it.enhance = 0;
              it.atk = ((it.baseAtk|0)||0) + ((it.enhance|0)||0);
              it.fixedAtk = true;
              window.equipItem?.("weapon", it);
            }

            invSelectedAbsIndex = -1;
            renderInventoryPage();
            try{ saveToLocal?.(); }catch(_){}
          }catch(err){}
        });

        slot.appendChild(b);
      }
    }

    // âœ… ì„ íƒëœ ìŠ¬ë¡¯ + ê°•í™”ì£¼ë¬¸ì„œë©´ ì‚¬ìš© ë²„íŠ¼
    if (invSelectedAbsIndex === absIndex && isEnhanceScrollItem(it)){
      const ub = document.createElement("button");
      ub.className = "equipBtn";
      ub.type = "button";
      ub.textContent = "ì‚¬ìš©";
      ub.style.background = "rgba(120,220,255,0.78)";
      ub.addEventListener("click", (e2)=>{
        e2.preventDefault();
        e2.stopPropagation();
        try{ useEnhanceScroll(absIndex); }catch(_){ }
      });
      slot.appendChild(ub);
    }

    invGrid.appendChild(slot);
  }

  if (invPageText) invPageText.textContent = `${invPage+1} / ${total}`;
  if (invPrev){
    invPrev.disabled = (invPage <= 0);
    invPrev.style.opacity = invPrev.disabled ? 0.35 : 1;
  }
  if (invNext){
    invNext.disabled = (invPage >= total-1);
    invNext.style.opacity = invNext.disabled ? 0.35 : 1;
  }
}

function openInv(){
  // ì²˜ìŒ ì—´ ë•ŒëŠ” ì¤‘ì•™ìœ¼ë¡œ ë°°ì¹˜(ì´ë¯¸ ìœ„ì¹˜ê°€ ìˆìœ¼ë©´ ìœ ì§€)
  if(!invPanel.style.left || !invPanel.style.top){
    invPanel.classList.remove("hide");
    centerPanel(invPanel);
    invPanel.classList.add("hide");
  }
invPage = 0;
  renderInventoryPage();
  invPanel.classList.remove("hide");
}
function closeInv(){
  invPanel.classList.add("hide");
}


// ===== íŒ¨ë„ ë“œë˜ê·¸ ì´ë™ + í™”ë©´(ìº”ë²„ìŠ¤) ë°–ìœ¼ë¡œ ëª» ë‚˜ê°€ê²Œ í´ë¨í”„ =====
function clampPanelToViewport(el, x, y){
  const margin = 6;
  const vw = window.innerWidth;
  const vh = window.innerHeight;
  const rect = el.getBoundingClientRect();
  const w = rect.width, h = rect.height;
  const cx = Math.max(margin, Math.min(vw - w - margin, x));
  const cy = Math.max(margin, Math.min(vh - h - margin, y));
  return { x: cx, y: cy };
}

function centerPanel(el){
  const rect = el.getBoundingClientRect();
  const x = (window.innerWidth - rect.width) / 2;
  const y = (window.innerHeight - rect.height) / 2;
  const p = clampPanelToViewport(el, x, y);
  el.style.left = p.x + "px";
  el.style.top  = p.y + "px";
  el.style.transform = "none";
}

function makeDraggablePanel(el, opts={}){
  if(!el) return;
  if(el.__draggableBound) return;
  el.__draggableBound = true;
  const handle = opts.handleSelector ? el.querySelector(opts.handleSelector) : el;
  if(!handle) return;

  // ë“œë˜ê·¸ ì¤‘ì—ëŠ” ë¸Œë¼ìš°ì € ê¸°ë³¸ ì œìŠ¤ì²˜(ìŠ¤í¬ë¡¤/ë“œë˜ê·¸ì´ë¯¸ì§€ ë“±) ë°©ì§€
  try{ handle.style.touchAction = "none"; }catch(_){}

  let dragging = false;
  let startX = 0, startY = 0;
  let baseL = 0, baseT = 0;
  let activePointerId = null;

  const shouldIgnore = (target)=>{
    if(!target) return false;
    const tag = (target.tagName||"").toLowerCase();
    if(tag === "button" || tag === "input" || tag === "textarea" || tag === "select") return true;
    if(target.closest(".statList")) return true;
    if(target.closest(".invGrid")) return true;
    if(target.closest(".invPager")) return true;
    if(target.closest(".equipGrid")) return true;
    if(target.closest(".equipFooter")) return true;
    return false;
  };

  const cancelDrag = ()=>{
    if(!dragging) return;
    dragging = false;
    activePointerId = null;
    el.classList.remove("dragging");
  };
  // ì™¸ë¶€ì—ì„œë„ ê°•ì œ ì¢…ë£Œ ê°€ëŠ¥í•˜ë„ë¡
  el.__cancelDrag = cancelDrag;

  const onDown = (e)=>{
    if(el.classList.contains("hide")) return;
    if(e.button != null && e.button !== 0) return; // ì¢Œí´ë¦­ë§Œ
    if(shouldIgnore(e.target)) return;

    dragging = true;
    activePointerId = (typeof e.pointerId === "number") ? e.pointerId : null;

    el.classList.add("dragging");
    const rect = el.getBoundingClientRect();
    baseL = rect.left;
    baseT = rect.top;

    const cx = (e.clientX ?? (e.touches && e.touches[0]?.clientX) ?? 0);
    const cy = (e.clientY ?? (e.touches && e.touches[0]?.clientY) ?? 0);
    startX = cx;
    startY = cy;

    el.style.transform = "none";
    el.style.left = baseL + "px";
    el.style.top  = baseT + "px";

    try{
      if(activePointerId != null) handle.setPointerCapture && handle.setPointerCapture(activePointerId);
    }catch(_){}
    e.preventDefault();
    e.stopPropagation();
  };

  const onMove = (e)=>{
    if(!dragging) return;
    const cx = (e.clientX ?? (e.touches && e.touches[0]?.clientX) ?? 0);
    const cy = (e.clientY ?? (e.touches && e.touches[0]?.clientY) ?? 0);
    const dx = cx - startX;
    const dy = cy - startY;
    const p = clampPanelToViewport(el, baseL + dx, baseT + dy);
    el.style.left = p.x + "px";
    el.style.top  = p.y + "px";
    e.preventDefault();
  };

  const onUp = (e)=>{
    if(!dragging) return;
    cancelDrag();
    try{
      const pid = (typeof e.pointerId === "number") ? e.pointerId : activePointerId;
      if(pid != null) handle.releasePointerCapture && handle.releasePointerCapture(pid);
    }catch(_){}
    e.preventDefault();
  };

  handle.addEventListener("pointerdown", onDown, {passive:false});
  window.addEventListener("pointermove", onMove, {passive:false, capture:true});
  window.addEventListener("pointerup", onUp, {passive:false, capture:true});
  window.addEventListener("pointercancel", onUp, {passive:false, capture:true});
  handle.addEventListener("lostpointercapture", cancelDrag, {passive:true});
  window.addEventListener("blur", cancelDrag, {passive:true});

  window.addEventListener("resize", ()=>{
    if(el.classList.contains("hide")) return;
    const rect = el.getBoundingClientRect();
    const p = clampPanelToViewport(el, rect.left, rect.top);
    el.style.left = p.x + "px";
    el.style.top  = p.y + "px";
    el.style.transform = "none";
  }, {passive:true});
}

// âœ… ë‘ íŒ¨ë„ ëª¨ë‘ í—¤ë”ë¥¼ ì†ì¡ì´ë¡œ ë“œë˜ê·¸ ê°€ëŠ¥
makeDraggablePanel(statPanel, { handleSelector: ".statHeader" });
makeDraggablePanel(invPanel,  { handleSelector: ".statHeader" });
makeDraggablePanel(equipPanel,{ handleSelector: ".statHeader" });
invBtn?.addEventListener("click", (e)=>{
  e.preventDefault();
  try{
    if (invBtnSound){
      invBtnSound.currentTime = 0;
      invBtnSound.play().catch(()=>{});
    }
  }catch(_){}
  if (invPanel.classList.contains("hide")) openInv();
  else closeInv();
});

invPanel?.querySelector(".btn.close")?.addEventListener("click", (e)=>{
  e.preventDefault();
  try{
    if (invBtnSound){
      invBtnSound.currentTime = 0;
      invBtnSound.play().catch(()=>{});
    }
  }catch(_){}
  closeInv();
});

invPrev?.addEventListener("click", (e)=>{
  e.preventDefault();
  invPage = Math.max(0, invPage-1);
  renderInventoryPage();
});
invNext?.addEventListener("click", (e)=>{
  e.preventDefault();
  invPage = Math.min(invTotalPages()-1, invPage+1);
  renderInventoryPage();
});
// ====== SAVE SYSTEM (ë¡œì»¬ ìë™ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°/ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸°/ì´ˆê¸°í™”) ======
  const SAVE_KEY = "warrior_rabbit_save_v1";
  // âœ… ë¶€íŒ…/ë§µ ì´ˆê¸°í™” ì¤‘ì—ëŠ” ì„¸ì´ë¸Œê°€ ê¸°ì¡´ ì§„í–‰ë„ë¥¼ ë®ì–´ì“°ì§€ ì•Šë„ë¡ ì¼ì‹œ ì¤‘ë‹¨ í”Œë˜ê·¸
  window.__SAVE_SUSPENDED = true; // âœ… ì‹œì‘ ì „ì—” ì €ì¥ ê¸ˆì§€(ë®ì–´ì“°ê¸° ë°©ì§€)
  const LAST_MAP_KEY = "warrior_rabbit_last_map_v1";
// âœ… ì¢…ë£Œ/ìƒˆë¡œê³ ì¹¨ ì§ì „ì—ë„ í•œë²ˆ ë” ì €ì¥(ë§ˆì§€ë§‰ ë§µ/ìƒíƒœ ë³´ì¡´)
  window.addEventListener('beforeunload', ()=>{ try{ if (typeof saveToLocal === 'function') saveToLocal(); }catch(_){ } });
  window.addEventListener('pagehide', ()=>{ try{ if (typeof saveToLocal === 'function') saveToLocal(); }catch(_){ } });
  document.addEventListener('visibilitychange', ()=>{ try{ if (document.visibilityState==='hidden' && typeof saveToLocal==='function') saveToLocal(); }catch(_){ } }, {passive:true});

  // âœ… ì„¸ì´ë¸Œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì (ê²Œì„ ë¡œì§ ì´ˆê¸°í™” ì „)ì—ë„ ì•ˆì „í•˜ê²Œ ì“°ê¸° ìœ„í•œ ì „ì—­ ë ˆë²¨ ìƒí•œ
  window.MAX_LEVEL = 100;


// ====== JSON ì¹˜íŠ¸ ë°©ì§€(ì„œëª…/ê²€ì¦) ======
// âš ï¸ í´ë¼(ì‹±ê¸€)ë§Œìœ¼ë¡œëŠ” 100% ë°©ì§€ëŠ” ë¶ˆê°€í•˜ì§€ë§Œ,
// JSON íŒŒì¼ì„ "ìˆ«ìë§Œ ë°”ê¿”ì„œ" ì‰½ê²Œ ì¡°ì‘í•˜ëŠ” ìˆ˜ì¤€ì€ ëŒ€ë¶€ë¶„ ë§‰ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
const SAVE_SIGN_SECRET = "WARRIOR_RABBIT_SAVE_SECRET_v1_2026"; // ì›í•˜ë©´ ë” ê¸¸ê²Œ ë°”ê¿”ë„ ë¨

// ì•ˆì •ì ì¸ ë¬¸ìì—´í™”(í‚¤ ì •ë ¬) - ì„œëª… ìƒì„±/ê²€ì¦ ì‹œ í•­ìƒ ë™ì¼í•œ ê²°ê³¼ê°€ ë‚˜ì˜¤ê²Œ í•¨
function stableStringify(obj){
  if (obj === null) return "null";
  const t = typeof obj;
  if (t === "number" || t === "boolean") return String(obj);
  if (t === "string") return JSON.stringify(obj);
  if (Array.isArray(obj)) {
    return "[" + obj.map(stableStringify).join(",") + "]";
  }
  if (t === "object") {
    const keys = Object.keys(obj).sort();
    return "{" + keys.map(k =>
      JSON.stringify(k) + ":" + stableStringify(obj[k])
    ).join(",") + "}";
  }
  return "";
}

// SHA-256 (sync, pure JS) -> hex
// ì¶œì²˜ì— ì˜ì¡´í•˜ì§€ ì•Šë„ë¡ íŒŒì¼ ì•ˆì— ì§ì ‘ í¬í•¨(ê²½ëŸ‰ ë²„ì „)
function sha256hex(ascii){
  function rightRotate(value, amount){ return (value>>>amount) | (value<<(32-amount)); }

  var mathPow = Math.pow;
  var maxWord = mathPow(2, 32);
  var result = "";

  var words = [];
  var asciiBitLength = ascii.length * 8;

  var hash = sha256hex.h = sha256hex.h || [];
  var k = sha256hex.k = sha256hex.k || [];
  var primeCounter = k.length;

  var isComposite = {};
  for (var candidate = 2; primeCounter < 64; candidate++){
    if (!isComposite[candidate]){
      for (var i = 0; i < 313; i += candidate){ isComposite[i] = candidate; }
      hash[primeCounter] = (mathPow(candidate, .5) * maxWord) | 0;
      k[primeCounter++] = (mathPow(candidate, 1/3) * maxWord) | 0;
    }
  }

  ascii += "\x80";
  while (ascii.length % 64 - 56) ascii += "\x00";

  for (i = 0; i < ascii.length; i++){
    var j = ascii.charCodeAt(i);
    words[i>>2] |= j << ((3 - i) % 4) * 8;
  }
  words[words.length] = ((asciiBitLength / maxWord) | 0);
  words[words.length] = (asciiBitLength);

  for (j = 0; j < words.length;){
    var w = words.slice(j, j += 16);
    var oldHash = hash.slice(0);

    for (i = 0; i < 64; i++){
      var w15 = w[i - 15], w2 = w[i - 2];

      var a = hash[0], e = hash[4];
      var temp1 = hash[7]
        + (rightRotate(e, 6) ^ rightRotate(e, 11) ^ rightRotate(e, 25))
        + ((e & hash[5]) ^ ((~e) & hash[6]))
        + k[i]
        + (w[i] = (i < 16) ? w[i] : (
            w[i - 16]
            + (rightRotate(w15, 7) ^ rightRotate(w15, 18) ^ (w15>>>3))
            + w[i - 7]
            + (rightRotate(w2, 17) ^ rightRotate(w2, 19) ^ (w2>>>10))
          ) | 0
        );

      var temp2 = (rightRotate(a, 2) ^ rightRotate(a, 13) ^ rightRotate(a, 22))
        + ((a & hash[1]) ^ (a & hash[2]) ^ (hash[1] & hash[2]));

      hash = [(temp1 + temp2) | 0].concat(hash);
      hash[4] = (hash[4] + temp1) | 0;
      hash.pop();
    }

    for (i = 0; i < 8; i++){
      hash[i] = (hash[i] + oldHash[i]) | 0;
    }
  }

  for (i = 0; i < 8; i++){
    for (j = 3; j + 1; j--){
      var b = (hash[i] >> (j * 8)) & 255;
      result += ((b < 16) ? 0 : "") + b.toString(16);
    }
  }
  return result;
}

function calcSaveSignature(saveObj){
  try{
    // sig ì œì™¸í•˜ê³  ì„œëª… ìƒì„±
    const clone = JSON.parse(JSON.stringify(saveObj || {}));
    delete clone.sig;
    const payload = stableStringify(clone);
    return sha256hex(SAVE_SIGN_SECRET + "|" + payload);
  }catch(e){
    return "";
  }
}

function verifySaveSignature(saveObj){
  if (!saveObj || typeof saveObj !== "object") return false;
  if (!saveObj.sig || typeof saveObj.sig !== "string") return false;
  const expected = calcSaveSignature(saveObj);
  return expected && saveObj.sig === expected;
}

        
  function buildSaveData(){
    const p = window.player || null;

    // âœ… JSON.stringifyê°€ ê¹¨ì§€ëŠ”(ìˆœí™˜ì°¸ì¡°/DOMê°ì²´/ì´ë¯¸ì§€ê°ì²´ ë“±) ì¼€ì´ìŠ¤ë¥¼ ë§‰ê¸° ìœ„í•´
    //    "ì„¸ì´ë¸Œì— í•„ìš”í•œ í•„ë“œë§Œ" ê³¨ë¼ì„œ ì €ì¥í•©ë‹ˆë‹¤.
    const pickItem = (it)=>{
      if(!it || typeof it !== "object") return null;
      const out = {
        uid: it.uid ?? null,
        id: it.id ?? null,
        name: it.name ?? null,
        qty: (it.qty|0) || 0,
        equipSlot: it.equipSlot ?? null,
        atk: (it.atk|0) || 0,
        baseAtk: (it.baseAtk|0) || 0,
        enhance: (it.enhance|0) || 0,
        fixedAtk: !!it.fixedAtk,
        def: (it.def|0) || 0,
        hit: (it.hit|0) || 0,
        eva: (it.eva|0) || 0,
        fixedAtk: !!it.fixedAtk,
        critChance: (typeof it.critChance==="number") ? it.critChance : undefined,
        critMult: (typeof it.critMult==="number") ? it.critMult : undefined,
        rarity: it.rarity ?? undefined,
        type: it.type ?? undefined,
        desc: it.desc ?? undefined,
      };
      // iconì€ ë¬¸ìì—´ë§Œ ì €ì¥(ì´ë¯¸ì§€ ê°ì²´/ìº”ë²„ìŠ¤ ë“±ì€ ì €ì¥ ê¸ˆì§€)
      if (typeof it.icon === "string") out.icon = it.icon;
      return out;
    };

    const pickEquip = (eq)=>{
      if(!eq || typeof eq !== "object") return null;
      const out = {
        uid: eq.uid ?? null,
        id: eq.id ?? null,
        name: eq.name ?? null,
        atk: (eq.atk|0) || 0,
        baseAtk: (eq.baseAtk|0) || 0,
        enhance: (eq.enhance|0) || 0,
        def: (eq.def|0) || 0,
        hit: (eq.hit|0) || 0,
        eva: (eq.eva|0) || 0,
        fixedAtk: !!eq.fixedAtk,
        critChance: (typeof eq.critChance==="number") ? eq.critChance : 0,
        critMult: (typeof eq.critMult==="number") ? eq.critMult : 0,
      };
      if (typeof eq.icon === "string") out.icon = eq.icon;
      return out;
    };

    const inv = (window.inventory && Array.isArray(window.inventory))
      ? window.inventory.map(pickItem).filter(Boolean)
      : null;

    const eq = (typeof equipment !== "undefined" && equipment) ? {
      weapon: pickEquip(equipment.weapon),
      armor: pickEquip(equipment.armor),
      accessory: pickEquip(equipment.accessory),
    } : null;

    const data = {
      v: 2,
      savedAt: Date.now(),
      mapId: (typeof currentMapId !== "undefined" ? currentMapId : null),
      statPoints: (window.statPoints|0),
      statLevels: window.statLevels ? {...window.statLevels} : null,
      player: p ? {
        level: (p.level|0),
        exp: (p.exp|0),
        hp: (p.hp|0),
        mp: (p.mp|0),
        x: (typeof p.x==="number") ? p.x : undefined,
        y: (typeof p.y==="number") ? p.y : undefined,
      } : null,
      inventory: inv,
      equipment: eq,
    };
    return data;
  }

  function applySaveData(data){
    if (!data || typeof data !== "object") return false;

    if (typeof data.statPoints === "number") window.statPoints = data.statPoints|0;
    if (data.statLevels && typeof data.statLevels === "object") window.statLevels = {...data.statLevels};

    // âœ… ì¥ì°© ì¥ë¹„ ë³µêµ¬(ë¬´ê¸°/ë°©ì–´êµ¬/ì•…ì„¸): ê³µê²©ë ¥/ë°©ì–´ë ¥/Eí‘œì‹œ/ì¥ì°©ìƒíƒœê°€ ì¬ì ‘ì† í›„ì—ë„ ìœ ì§€ë˜ê²Œ
    try{
      if (data.equipment && typeof data.equipment === "object" && typeof equipment !== "undefined" && equipment){
        const applySlot = (slotName)=>{
          const src = data.equipment[slotName];
          const dst = equipment[slotName];
          if (!src || typeof src !== "object" || !dst || typeof dst !== "object") return;
          // dstëŠ” const ê°ì²´ì´ë¯€ë¡œ "ì¬í• ë‹¹"ì´ ì•„ë‹ˆë¼ "í•„ë“œ ë®ì–´ì“°ê¸°"ë¡œ ë³µêµ¬
          dst.uid = (src.uid ?? dst.uid ?? null);
          dst.id  = (src.id  ?? dst.id  ?? null);
          dst.name= (src.name?? dst.name?? null);
          if (typeof src.icon === "string") dst.icon = src.icon;
          if (typeof src.atk === "number") dst.atk = src.atk|0;
          if (typeof src.baseAtk === "number") dst.baseAtk = src.baseAtk|0;
          if (typeof src.enhance === "number") dst.enhance = src.enhance|0;
          if ((src.fixedAtk) || dst.fixedAtk){
            const b = (dst.baseAtk|0) || 0;
            const e = (dst.enhance|0) || 0;
            dst.atk = b + e;
          }
          if (typeof src.def === "number") dst.def = src.def|0;
          if (typeof src.hit === "number") dst.hit = src.hit|0;
          if (typeof src.eva === "number") dst.eva = src.eva|0;
          dst.fixedAtk = !!src.fixedAtk;
          if (typeof src.critChance === "number") dst.critChance = src.critChance;
          if (typeof src.critMult === "number") dst.critMult = src.critMult;
        };
        applySlot("weapon");
        applySlot("armor");
        applySlot("accessory");
      }
    }catch(e){}

    // âœ… ì¸ë²¤í† ë¦¬(ì•„ì´í…œ/ì¥ë¹„) ì €ì¥/ë³µêµ¬: ì¬ì ‘ì† ì‹œ Eí‘œì‹œ/ì¥ì°©ìƒíƒœ ë™ê¸°í™”
    try{
      if (Array.isArray(data.inventory)){
        // ì•ˆì „í•˜ê²Œ ë³µì‚¬
        window.inventory = data.inventory
          .filter(it => it && typeof it === "object")
          .map(it => {
            const o = {...it};
            // âœ… ë¬´ê¸° ê°•í™”(enhance) ì„¸ì´ë¸Œ ë§ˆì´ê·¸ë ˆì´ì…˜/ì •ê·œí™”
            if (o && o.equipSlot === "weapon") {
              if (typeof o.enhance !== "number") o.enhance = (o.enhance|0) || 0;
              if (typeof o.baseAtk !== "number" || !isFinite(o.baseAtk) || o.baseAtk <= 0) {
                // êµ¬ì„¸ì´ë¸Œ: baseAtkê°€ ì—†ìœ¼ë©´ í˜„ì¬ atkì—ì„œ enhanceë¥¼ ëº€ ê°’(ìµœì†Œ 0)
                const a = (o.atk|0) || 0;
                const e = (o.enhance|0) || 0;
                o.baseAtk = Math.max(0, a - e);
              }
              // fixedAtk ë¬´ê¸°ë©´ atkëŠ” í•­ìƒ baseAtk+enhanceë¡œ ì¬ê³„ì‚°
              if (o.fixedAtk) {
                o.atk = ((o.baseAtk|0) || 0) + ((o.enhance|0) || 0);
              }
            }
            return o;
          });
      }
    }catch(e){}

    // âœ… (êµ¬ì„¸ì´ë¸Œ í˜¸í™˜) ì¥ì°© ë¬´ê¸°ê°€ ìˆëŠ”ë° ì¸ë²¤ì— ê°™ì€ uidê°€ ì—†ë‹¤ë©´: ê¸°ì¡´ ë‹¨ê²€/ë¬´ê¸° ì•„ì´í…œê³¼ uidë¥¼ ë§ì¶”ê±°ë‚˜ ì¸ë²¤ì— ìƒì„±
    try{
      if (!window.inventory) window.inventory = [];
      const w = equipment && equipment.weapon ? equipment.weapon : null;
      if (w && w.uid){
        let hasUid = window.inventory.some(it => it && it.uid === w.uid);
        if (!hasUid){
          // 1) ê°™ì€ id/nameì˜ ë¬´ê¸° ì•„ì´í…œì´ ìˆìœ¼ë©´ uidë¥¼ ë§ì¶˜ë‹¤(ì¤‘ë³µ ìƒì„± ë°©ì§€)
          let cand = window.inventory.find(it => it && it.uid && (it.equipSlot === "weapon" || it.id === w.id || it.name === w.name) && ((it.id||"") === (w.id||"") || (it.name||"") === (w.name||"")));
          if (cand){
            cand.uid = w.uid;
            hasUid = true;
          } else {
            // 2) ë‹¨ê²€ ê°™ì€ ì‹œì‘ì¥ë¹„ê°€ ìˆì„ ë•ŒëŠ” ê·¸ê±¸ uid ë§¤ì¹­
            let dagger = window.inventory.find(it => it && it.uid && ((it.id === "dagger") || (it.name === "ë‹¨ê²€")) && (it.equipSlot === "weapon"));
            if (dagger){
              dagger.uid = w.uid;
              hasUid = true;
            }
          }
          // 3) ê·¸ë˜ë„ ì—†ìœ¼ë©´, ì¥ì°© ë¬´ê¸°ë¥¼ ì¸ë²¤ì— 1ê°œ ìƒì„±(êµ¬ì„¸ì´ë¸Œì—ì„œ Eí‘œì‹œ ë³µêµ¬ìš©)
          if (!hasUid){
            window.inventory.push({
              uid: w.uid,
              id: w.id || "weapon",
              name: w.name || "ë¬´ê¸°",
              icon: w.icon || null,
              qty: 1,
              equipSlot: "weapon",
              baseAtk: (w.baseAtk|0) || ((w.atk|0) || 0),
              enhance: (w.enhance|0) || 0,
              fixedAtk: !!w.fixedAtk,
              atk: (w.fixedAtk ? (((w.baseAtk|0) || ((w.atk|0)||0)) + ((w.enhance|0)||0)) : ((w.atk|0)||0)),
              def: w.def|0 || 0,
              hit: w.hit|0 || 0,
              eva: w.eva|0 || 0,
              critChance: +w.critChance || 0,
              critMult: +w.critMult || 0,
                          });
          }
        }
      }
    }catch(e){}

    if (data.equipment && typeof data.equipment === "object" && typeof equipment !== "undefined"){
      try{
        for (const k of ["weapon","armor","accessory"]){
          if (data.equipment[k]) equipment[k] = {...data.equipment[k]};
        }
      }catch(e){}
    }

    // âœ… êµ¬ë²„ì „ ì„¸ì´ë¸Œ(ë¬´ê¸° uid/id ëˆ„ë½) ë§ˆì´ê·¸ë ˆì´ì…˜: Eí‘œì‹œ/ì°©ìš©íŒì • ë²„ê·¸ ë°©ì§€
    try{
      if (equipment && equipment.weapon){
        if (!equipment.weapon.id || (equipment.weapon.id !== "fist" && !equipment.weapon.uid)){
          // êµ¬í˜• ì„¸ì´ë¸Œ(ë¬´ê¸° uid/id ëˆ„ë½) ë³´ì •: ë§¨ì†ì€ uid ì—†ì–´ë„ ìœ ì§€
          equipment.weapon = { uid:null, id:"fist", name:"ë§¨ì†", atk:0, fixedAtk:false, def:0, hit:0, eva:0, critChance:0.00, critMult:1.50 };
        }
      }
    }catch(e){}

    const p = window.player;
    if (p && data.player && typeof data.player === "object"){
      if (typeof data.player.level === "number") p.level = Math.max(1, Math.min((typeof MAX_LEVEL!=='undefined'?MAX_LEVEL:(window.MAX_LEVEL||100)), data.player.level|0));
      if (typeof data.player.exp === "number") p.exp = Math.max(0, data.player.exp|0);
      try{ applyPlayerStatsForLevel(); }catch(e){}
      try{ recalcCombatStats(); }catch(e){}
      if (typeof data.player.hp === "number") p.hp = Math.max(0, Math.min(p.hpMax, data.player.hp|0));
      if (typeof data.player.mp === "number") p.mp = Math.max(0, Math.min(p.mpMax, data.player.mp|0));
    }

    try{ if (typeof syncStatBtn === "function") syncStatBtn(); }catch(e){}
    
    // âœ… ë¡œë“œ ì§í›„ ìŠ¤íƒ¯/ê³µê²©ë ¥ ì¦‰ì‹œ ì¬ê³„ì‚° (ê°•í™” % ì ìš© í¬í•¨)
    try{ recalcCombatStats(); }catch(e){}
    // âœ… ì¸ë²¤ UI/íˆ´íŒ ë°°ì§€ ì¬ë Œë”
    try{ if (typeof renderInventory==="function") renderInventory(); }catch(e){}
// âœ… ë§ˆì§€ë§‰ìœ¼ë¡œ ë¨¸ë¬¼ë €ë˜ ë§µ ë³µì›(ì¬ì ‘ì† ì‹œ ê°™ì€ ë§µì—ì„œ ì‹œì‘)
    try{
      if (data.mapId){
        const mid = (data.mapId === "forest" || data.mapId === "field") ? data.mapId : "forest";
        // setMapì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì ìš©(í”Œë ˆì´ì–´ëŠ” ì¤‘ì•™ ìŠ¤í°)
        if (typeof setMap === "function") setMap(mid, "center");
        else currentMapId = mid; // (í˜¹ì‹œ setMapì´ ì•„ì§ ì—†ìœ¼ë©´) ë³€ìˆ˜ë§Œì´ë¼ë„ ë°˜ì˜
      }
    }catch(e){}

    return true;
  }

  function saveToLocal(){
    try{
      if (window.__SAVE_SUSPENDED) return false;
      // âœ… ê²Œì„ì´ ì™„ì „íˆ ì´ˆê¸°í™”/ë¡œë“œë˜ê¸° ì „ì—ëŠ” ì €ì¥ ê¸ˆì§€(ë¹ˆ ë°ì´í„°ë¡œ ê¸°ì¡´ ì„¸ì´ë¸Œ ë®ì–´ì“°ê¸° ë°©ì§€)
      if (!window.player) return false;
      const data = buildSaveData();
      if (!data || !data.player) return false; // âœ… ì•ˆì „ì¥ì¹˜
      data.sig = calcSaveSignature(data);
      localStorage.setItem(SAVE_KEY, JSON.stringify(data));
      return true;
    }catch(e){
      return false;
    }
  }

  function loadFromLocal(){
  try{
    const raw = localStorage.getItem(SAVE_KEY);
    if (!raw) return false;
    const data = JSON.parse(raw);

    // âœ… ì„œëª… ê²€ì¦: (êµ¬ë²„ì „ ì„¸ì´ë¸Œì—ëŠ” sigê°€ ì—†ì„ ìˆ˜ ìˆìœ¼ë‹ˆ 1íšŒ ë§ˆì´ê·¸ë ˆì´ì…˜ í—ˆìš©)
    if (data && typeof data === "object"){
      if (typeof data.sig === "string"){
        if (!verifySaveSignature(data)){
          console.warn("Save signature mismatch. Possible tampering. (Allowing load and regenerating signature)");
          try{ delete data.sig; }catch(e){}
        }
      } else {
        // êµ¬ì„¸ì´ë¸Œ(ì„œëª… ì—†ìŒ) -> ì¼ë‹¨ í—ˆìš©í•˜ê³ , ì¦‰ì‹œ ì„œëª… ë¶™ì—¬ì„œ ë‹¤ì‹œ ì €ì¥
        try{
          data.sig = calcSaveSignature(data);
          localStorage.setItem(SAVE_KEY, JSON.stringify(data));
        }catch(e){}
      }
    }

    const ok = applySaveData(data);
    // âœ… ë¡œë“œ ì„±ê³µ ì‹œ: í˜„ì¬ ìƒíƒœë¡œ ì¦‰ì‹œ ì¬ì„œëª…/ì¬ì €ì¥(ì„œëª… ë¶ˆì¼ì¹˜/êµ¬ì„¸ì´ë¸Œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì•ˆì •í™”)
    if (ok){
      try{
        const fresh = buildSaveData();
        fresh.sig = calcSaveSignature(fresh);
        localStorage.setItem(SAVE_KEY, JSON.stringify(fresh));
      }catch(e){}
    }
    return ok;
  }catch(e){
    return false;
  }
}

  function exportSave(){
    try{
      const data = buildSaveData();
      data.sig = calcSaveSignature(data);
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const dt = new Date();
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,"0");
      const d = String(dt.getDate()).padStart(2,"0");
      const hh = String(dt.getHours()).padStart(2,"0");
      const mm = String(dt.getMinutes()).padStart(2,"0");
      a.href = url;
      a.download = `save_${y}${m}${d}_${hh}${mm}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }catch(e){}
  }

  function importSaveFromFile(file){
  return new Promise((resolve)=>{
    try{
      const r = new FileReader();
      r.onload = ()=>{
        try{
          let text = String(r.result || "");
          // âœ… BOM(ï»¿) ì œê±° + ì•ë’¤ ê³µë°± ì œê±° (ìœˆë„ìš°/í¸ì§‘ê¸° ì €ì¥ ë°©ì‹ ë•Œë¬¸ì— ì¢…ì¢… ë¼ì–´ìˆìŒ)
          text = text.replace(/^\uFEFF/, "").trim();
          const data = JSON.parse(text);

          // âœ… íŒŒì¼ ê°€ì ¸ì˜¤ê¸°ëŠ” ì„œëª…(sig)ì´ ë°˜ë“œì‹œ ìˆì–´ì•¼ í†µê³¼ (ìˆ˜ì •/ì¡°ì‘ ë°©ì§€)
          if (!verifySaveSignature(data)){
            alert("ì„¸ì´ë¸Œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ì„œëª…(sig) ë¶ˆì¼ì¹˜ (íŒŒì¼ì´ ìˆ˜ì •ë˜ì—ˆê±°ë‚˜, ë‹¤ë¥¸ ë²„ì „ì—ì„œ ë§Œë“  ì„¸ì´ë¸Œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤)");
            resolve(false);
            return;
          }

          const ok = applySaveData(data);
          if (ok) saveToLocal();
          resolve(ok);
        }catch(e){
          console.error("Save import parse/apply error:", e);
          alert("ì„¸ì´ë¸Œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: JSON í˜•ì‹ì´ ê¹¨ì¡Œê±°ë‚˜ í˜¸í™˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n\n" + (e && e.message ? e.message : e));
          resolve(false);
        }
      };
      r.onerror = ()=>{
        alert("ì„¸ì´ë¸Œ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨(íŒŒì¼ ê¶Œí•œ/ì†ìƒ ê°€ëŠ¥)");
        resolve(false);
      };
      r.readAsText(file, "utf-8");
    }catch(e){
      alert("ì„¸ì´ë¸Œ ë¶ˆëŸ¬ì˜¤ê¸° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: " + (e && e.message ? e.message : e));
      resolve(false);
    }
  });
}


  function resetSave(){
    try{ localStorage.removeItem(SAVE_KEY); }catch(e){}
    location.reload();
  }
// (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ ìƒì„±)
    if (typeof window.statLevels === "undefined") window.statLevels = { hp:0, mp:0, str:0, int:0, vit:0, agi:0, luk:0, acc:0, aspd:0, mspd:0 };
  if (typeof window.statPoints === "undefined") window.statPoints = 0;

  const statListData = [
  { id: "hp",   name: "ì²´ë ¥",     desc: "ìµœëŒ€ì²´ë ¥ +3% +5 ì¦ê°€" },
  { id: "mp",   name: "ë§ˆë‚˜",     desc: "ìµœëŒ€ë§ˆë‚˜ +3% +3 ì¦ê°€" },
  { id: "str",  name: "í˜",       desc: "ê³µê²©ë ¥ +1 & +3% ì¦ê°€" },
  { id: "int",  name: "ì§€ëŠ¥",     desc: "íšŒë³µì†ë„ -0.1ì´ˆ ì¦ê°€", max: 60 },
  { id: "vit",  name: "ì¸ë‚´",     desc: "ë°©ì–´ë ¥ +1 & +3% ì¦ê°€" },
  { id: "agi",  name: "ë¯¼ì²©",     desc: "íšŒí”¼í™•ë¥  +0.1% ì¦ê°€" },
  { id: "luk",  name: "ìš´",       desc: "í¬ë¦¬í™•ë¥  +0.1% ì¦ê°€" },
  { id: "acc",  name: "ëª…ì¤‘",     desc: "ëª…ì¤‘ë¥  +0.1% ì¦ê°€" },
  { id: "aspd", name: "ê³µê²©ì†ë„", desc: "ê³µê²©ì†ë„ +0.1% ì¦ê°€" },
  { id: "mspd", name: "ì´ë™ì†ë„", desc: "ì´ë™ì†ë„ +0.1 ì¦ê°€", max: 100 }
];


  let tempStatLevels = {...window.statLevels};
  let tempStatPoints = window.statPoints;
  // âœ… íŒ¨ë„ì—ì„œ + / - ì°ì„ ë•Œ ë°”ë¡œ ê²Œì„ ëŠ¥ë ¥ì¹˜ì— "ë¯¸ë¦¬ë³´ê¸°" ë°˜ì˜
  function previewApplyTempStats(){
    if (window.applyPlayerStatsForLevel) window.applyPlayerStatsForLevel(tempStatLevels);
    if (window.recalcCombatStats) window.recalcCombatStats(tempStatLevels);
  }
  function previewRevertToAppliedStats(){
    if (window.applyPlayerStatsForLevel) window.applyPlayerStatsForLevel();
    if (window.recalcCombatStats) window.recalcCombatStats();
  }


  function playStatUp(){
    try{ if(statUpSound){ statUpSound.currentTime=0; statUpSound.play().catch(()=>{});
} }catch(e){}
  }
  function playStatPlus(){
    try{ if(statPlusSound){ statPlusSound.currentTime=0; statPlusSound.play().catch(()=>{});
} }catch(e){}
  }

  function playApply(){
    try{
      if(applySound){
        applySound.currentTime = 0;
        applySound.play().catch(()=>{});
      }
    }catch(e){}
  }

  // âœ… ë ˆë²¨ì—… ì‚¬ìš´ë“œ (up.ogg)
  function playLevelUpSound(){
    try{
      if(levelUpSound){
        levelUpSound.currentTime = 0;
        levelUpSound.play().catch(()=>{});
      }
    }catch(e){}
  }

  function renderStatRows(){
    if(!statList) return;
    statList.innerHTML = "";
    statPointsEl.textContent = tempStatPoints;

    statListData.forEach(stat=>{
      const row = document.createElement("div");
      row.className = "statRow";
      const max = stat.max ?? Infinity;
      const now = tempStatLevels[stat.id] ?? 0;

      row.innerHTML = `
        <div class="statInfo">
          <div class="statName">${stat.name}</div>
          <div class="statDesc">${stat.desc}${max!==Infinity ? ` (ìµœëŒ€ ${max})` : ""}</div>
        </div>
        <div class="statCtrl">
          <span class="statValue">${now}</span>
          <button class="plus" type="button">+</button>
        </div>
      `;
      const plusBtn  = row.querySelector(".plus");
      const valueSpan = row.querySelector(".statValue");

      plusBtn.onclick = (e)=>{
        e.preventDefault();
        if(tempStatPoints <= 0) return;
        if((tempStatLevels[stat.id]||0) >= max) return;
        tempStatLevels[stat.id] = (tempStatLevels[stat.id]||0)+1;
        tempStatPoints--;
        valueSpan.textContent = tempStatLevels[stat.id];
        statPointsEl.textContent = tempStatPoints;
        playStatPlus();
        previewApplyTempStats();
        // âœ… ì¦‰ì‹œ ê²Œì„ì— í™•ì • ë°˜ì˜
        window.statLevels = {...tempStatLevels};
        window.statPoints = tempStatPoints;
        try{ saveToLocal(); }catch(e){}
      };
      statList.appendChild(row);
    });
  }

  function openStatPanel(){
    // ì²˜ìŒ ì—´ ë•ŒëŠ” ì¤‘ì•™ìœ¼ë¡œ ë°°ì¹˜(ì´ë¯¸ ìœ„ì¹˜ê°€ ìˆìœ¼ë©´ ìœ ì§€)
    if(!statPanel.style.left || !statPanel.style.top){
      statPanel.classList.remove("hide");
      centerPanel(statPanel);
      statPanel.classList.add("hide");
    }
tempStatLevels = {...window.statLevels};
    tempStatPoints = window.statPoints;
    renderStatRows();
    statPanel.classList.remove("hide");
  }
  function closeStatPanel(){
    statPanel.classList.add("hide");
    // âœ… ë¯¸ë¦¬ë³´ê¸°ë¡œ ë°”ë€ ê°’ì´ ìˆë‹¤ë©´, ì‹¤ì œ ì ìš©ëœ ìŠ¤íƒ¯(window.statLevels)ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°
    previewRevertToAppliedStats();
  }

  statBtn?.addEventListener("click", (e)=>{
    e.preventDefault();
    try{
      if (invBtnSound){
        invBtnSound.currentTime = 0;
        invBtnSound.play().catch(()=>{});
      }
    }catch(_){}
    if(statPanel.classList.contains("hide")) openStatPanel();
    else closeStatPanel();
  });

  statPanel?.querySelector(".btn.close")?.addEventListener("click", (e)=>{
    e.preventDefault();
    try{
      if (invBtnSound){
        invBtnSound.currentTime = 0;
        invBtnSound.play().catch(()=>{});
      }
    }catch(_){}
    closeStatPanel();
  });
// StatPointsê°€ ìƒê¸°ë©´ ë²„íŠ¼ ìŠ¬ë¼ì´ë“œ ì¸
  let statBtnShown = false;
function syncStatBtn(){
  if(!statBtn) return;
  const sp = window.statPoints | 0;
  if(sp > 0){
    if(!statBtnShown){
      try{
        statBtnSound.currentTime = 0;
        statBtnSound.play().catch(()=>{});
}catch(e){}
    }
    statBtn.classList.add("show");
    statBtnShown = true;
  }else{
    statBtn.classList.remove("show");
    statBtnShown = false;
  }
}
  // ì´ˆê¸° ë°˜ì˜
  syncStatBtn();
  setInterval(syncStatBtn, 250); // 0.25ì´ˆë§ˆë‹¤ ë°˜ì˜


  (() => {
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');

  let DPR = 1;

  const overlay = document.getElementById('titleOverlay');
  const startBtn = document.getElementById('startBtn');
  const startHint = document.getElementById('startHint');

  let started = false;
  let assetsReady = false;

  function resize(){
    const dpr = Math.min(2, window.devicePixelRatio || 1);
    DPR = dpr;
    canvas.width = Math.floor(innerWidth * dpr);
    canvas.height = Math.floor(innerHeight * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.imageSmoothingEnabled = false;
  }
  addEventListener('resize', resize, {passive:true});
  resize();

  // ====== ASSETS ======

  // ====== BGM ======
  const bgm = new Audio('bgm.ogg');
  bgm.loop = true;
  bgm.volume = 0.5;


  // ====== FOOTSTEP SFX ======

  // ====== ATTACK SFX ======
  const attackSfx = new Audio('kal.ogg');
  attackSfx.volume = 0.6;

// ====== KI-HAP SFX (random shout) ======
  const kihapSfx = new Audio('kihap.wav');
  kihapSfx.volume = 0.7;


  // ====== HIT SFX (monster hit) ======
  const hitSfx = new Audio('hit.ogg');
  hitSfx.volume = 0.6;

  // ====== CRIT SFX ======
  const critSfx = new Audio('crt.wav');
  critSfx.volume = 0.75;

// ====== RABBIT DEATH SFX ======
  const rabbitDeathSfx = new Audio('ttoki4.wav');
  rabbitDeathSfx.volume = 0.7;


  // ====== DEATH SFX (player death) ======
  const deathSfx = new Audio('samang.wav');
  deathSfx.volume = 0.7;

  const footstep = new Audio('balsori.ogg');
  footstep.volume = 0.45;
  let lastStepTime = 0;
  const STEP_INTERVAL = 0.28; // ë°œì†Œë¦¬ ê°„ê²©(ì´ˆ)

  const heroImg = new Image(); heroImg.src = 'hero.png';
  const grassImg = new Image(); grassImg.src = 'grass.png';
  const rabbitImg = new Image(); rabbitImg.src = 'rabbit.png';
  const treeImg = new Image(); treeImg.src = 'tree.png'; // íˆ¬ëª… ë°°ê²½ ë‚˜ë¬´ ì´ë¯¸ì§€

  let loaded = 0;
  const NEED = 4;
  function onLoaded(){
    loaded++;
    if (loaded >= NEED){
      assetsReady = true;
      startBtn.disabled = false;
      startHint.textContent = "Startë¥¼ ëˆ„ë¥´ë©´ ë°”ë¡œ ì‹œì‘ë©ë‹ˆë‹¤.";
    }
  }
  heroImg.onload = onLoaded; grassImg.onload = onLoaded; rabbitImg.onload = onLoaded; treeImg.onload = onLoaded;

  function onAssetError(name){
    return () => alert(name + " íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ htmlê³¼ ê°™ì€ í´ë”ì— ë‘ê³  íŒŒì¼ëª…ì„ ì •í™•íˆ ë§ì¶°ì£¼ì„¸ìš”.");
  }
  heroImg.onerror = onAssetError('hero.png');
  grassImg.onerror = onAssetError('grass.png');
  rabbitImg.onerror = onAssetError('rabbit.png');
  treeImg.onerror = onAssetError('tree.png');

  // ====== UTILS ======
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const rand = (a,b)=>a+Math.random()*(b-a);
  const dist2 = (ax,ay,bx,by)=>{const dx=ax-bx,dy=ay-by;return dx*dx+dy*dy;};


  // ====== LEVEL SYSTEM (Lv1->100, target ~2 months) ======
  const MAX_LEVEL = 100;

  // EXP needed to go from 'level' to 'level+1'
  // âœ… Must satisfy: needExp(1) = 30 (ëŒ€í‘œë‹˜ í™•ì •ê°’)
  function needExp(level){
    level = Math.max(1, Math.min(MAX_LEVEL, level|0));
    if (level <= 30){
      const L = level - 1;
      return Math.floor(30 + 7*L + 1*(L*L));
    } else if (level <= 70){
      const L = level - 30;
      return Math.floor(1200 + 60*L + 6*(L*L));
    } else {
        // âœ… ì ‘ì´‰ì´ í’€ë¦¬ë©´(íŠ¹íˆ ì¹˜ëª…íƒ€ ë„‰ë°± ì´í›„) 'attack' ìƒíƒœë¡œ ë°©í™©í•˜ì§€ ì•Šê²Œ ì¦‰ì‹œ ì¶”ì ìœ¼ë¡œ ë³µê·€
        if (rb.state === 'attack'){
          if (dd <= d2) rb.state = 'chase';
          else { rb.state = 'wander'; pickWander(rb); }
        }
const L = level - 70;
      return Math.floor(15000 + 900*L + 90*(L*L) + 4*(L*L*L));
    }
  }

  // Player stat scaling (Lv1 fixed: HP50 / MP20 / DMG2)
  
  // ====== ìŠ¤íƒ¯ ë¶„ë°°(Stat Panel) -> ì‹¤ì œ ì „íˆ¬/ì´ë™/ìµœëŒ€HP/MP ë°˜ì˜ ======
  // window.statLevels ê¸°ì¤€ìœ¼ë¡œ ìµœì¢… ë³´ë„ˆìŠ¤ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
  function calcStatBonus(levelsOverride){
    const lv = levelsOverride || window.statLevels || {};
    const n = (k)=> (lv[k]|0);

    const hp  = n("hp");
    const mp  = n("mp");
    const str = n("str");
    const intl= n("int");
    const vit = n("vit");
    const agi = n("agi");
    const luk = n("luk");
    const acc = n("acc");
    const aspd= n("aspd");
    const mspd= n("mspd");

    // âœ… ì„¤ëª… ë¬¸êµ¬ ê·¸ëŒ€ë¡œ ë°˜ì˜
    // - hp: +10, mp:+5, str:+3, vit:+1
    // - agi/luk/acc: +0.1% (í™•ë¥  ë‹¨ìœ„) -> ë‚´ë¶€ êµ¬í˜„ì€ hit/evaê°€ 'í¬ì¸íŠ¸'ë¼ì„œ 0.05í¬ì¸íŠ¸(=0.1%*2% ê¸°ì¤€)ë¡œ í™˜ì‚°
    // - aspd: ê³µê²©ì†ë„ +0.1% => atkIntervalì„ (1-0.001*aspd) ë°°
    // - int: íšŒë³µì†ë„ -0.1ì´ˆ => ìë™ì‚¬ëƒ¥ ë”œë ˆì´(autoDelayTime) ê°ì†Œë¡œ ì—°ê²°
    // - mspd: ì´ë™ì†ë„ +0.1 (player.speedì— ê°€ì‚°)
    const bonus = {
      hpMul: 1 + hp * 0.03,
      hpMaxAdd: hp * 5,
      mpMul: 1 + mp * 0.03,
      mpMaxAdd: mp * 3,
      atkMul: 1 + str * 0.03,
      atkAdd: str * 1,
      defMul: 1 + vit * 0.03,
      defAdd: vit * 1,
      hitAdd: acc * 0.05,
      evaAdd: agi * 0.05,
      critChanceAdd: luk * 0.001,
      atkIntervalMul: Math.max(0.10, 1 - aspd * 0.001),
      speedAdd: mspd * 0.1,
      autoDelayTime: Math.max(0.10, 1.0 - intl * 0.1),
    };
    return bonus;
  }
function applyPlayerStatsForLevel(levelsOverride){
    const lv = player.level|0;

    const prevHpMax = player.hpMax || 0;
    const prevMpMax = player.mpMax || 0;

    // âœ… Lv1 fixed: HP50 / MP20 (ë ˆë²¨ ê¸°ë³¸ì¹˜)
    const baseHpMax = 50 + 5*(lv-1);
    const baseMpMax = 20 + 2*(lv-1);

    const b = calcStatBonus(levelsOverride);

    player.hpMax = Math.floor(baseHpMax * (b.hpMul ?? 1)) + (b.hpMaxAdd || 0);
    player.mpMax = Math.floor(baseMpMax * (b.mpMul ?? 1)) + (b.mpMaxAdd || 0);

    // âœ… ì²´ë ¥/ë§ˆë‚˜ ìŠ¤íƒ¯ìœ¼ë¡œ "ìµœëŒ€ì¹˜ê°€ ëŠ˜ì–´ë‚œ ë§Œí¼" í˜„ì¬ì¹˜ë„ ê°™ì´ ì¦ê°€
    const hpDelta = player.hpMax - prevHpMax;
    const mpDelta = player.mpMax - prevMpMax;
    if (hpDelta > 0) player.hp += hpDelta;
    if (mpDelta > 0) player.mp += mpDelta;

    // ìë™ì‚¬ëƒ¥ ë”œë ˆì´(íšŒë³µì†ë„) ë°˜ì˜
    player.autoDelayTime = b.autoDelayTime;

    // âœ… EXP needed for next level (Lv1 => 30)
    player.expMax = needExp(lv);

    // clamp current values
    player.hp = Math.min(player.hp, player.hpMax);
    player.mp = Math.min(player.mp, player.mpMax);
    player.exp = Math.max(0, player.exp|0);
  }

  // ====== EQUIPMENT STATS (item-only combat stats) ======
  // ë ˆë²¨ì—…ìœ¼ë¡œ ë³€í•˜ëŠ” ê²ƒ: HP/MP/EXP(í•„ìš”ì¹˜)ë§Œ
  // ì•„ì´í…œìœ¼ë¡œ ë³€í•˜ëŠ” ê²ƒ: atk/def/hit/eva/critChance/critMult
  const equipment = {
    weapon:    { uid:null, id:"fist", name:"ë§¨ì†", atk:0, fixedAtk:false, def:0, hit:0, eva:0, critChance:0.00, critMult:1.50 },
    armor:     { uid:null, id:"cloth", name:"ê°‘ì˜·", atk:0, def:0, hit:0, eva:0, critChance:0.00, critMult:0.00 },
    accessory: { uid:null, id:"none", name:"ì—†ìŒ", atk:0, def:0, hit:0, eva:0, critChance:0.00, critMult:0.00 },
  };

  function recalcCombatStats(levelsOverride){
    const w = equipment.weapon || {};
    const a = equipment.armor || {};
    const x = equipment.accessory || {};

    const b = calcStatBonus(levelsOverride);

    // âœ… ëŒ€í‘œë‹˜ ìš”ì²­: ìµœì¢… ê³µê²©ë ¥ = (ë‚´ ê³µê²©ë ¥) + (ë¬´ê¸°/ì¥ë¹„ ê³µê²©ë ¥)
    // - "ë‚´ ê³µê²©ë ¥"ì€ ê¸°ë³¸ê³µê²©ë ¥(ê¸°ë³¸ 8) + í˜(í‰íƒ„ +%) ë“±ì˜ ìŠ¤íƒ¯ ë³´ë„ˆìŠ¤ê°€ ì ìš©ëœ ê°’
    // - ë¬´ê¸°/ì¥ë¹„ ê³µê²©ë ¥ì€ ê·¸ ìœ„ì— 'ê·¸ëŒ€ë¡œ' ë”í•´ì§ (êµì²´/ë®ì–´ì“°ê¸° X)
    const BASE_PLAYER_ATK = (player.baseAtkBase != null) ? (player.baseAtkBase|0) : 8;
    player.baseAtkBase = BASE_PLAYER_ATK;

    // âœ… ì¥ë¹„ ê³µê²©ë ¥(ì‹¤ì œ ì ìš©):
    // - ê°•í™” ìˆ˜ì¹˜(+n)ëŠ” "í‘œì‹œìš© ë ˆë²¨"ë§Œ ì˜¬ë¦¬ê³ ,
    // - ì‹¤ì œ ê³µê²©ë ¥ì€ (ê¸°ë³¸ê³µê²©ë ¥ * (1 + 10% * ê°•í™”ë ˆë²¨)) ë°©ì‹ìœ¼ë¡œ ì ìš©
    //   ì˜ˆ) ë‹¨ê²€ baseAtk=5, enhance=1 => 5 * 1.10 = 5.5
    const _atkBase = (obj)=> (("baseAtk" in obj) ? (+obj.baseAtk||0) : (+obj.atk||0));
    const _atkWithEnhPercent = (obj)=>{
  const base = _atkBase(obj);
  const enh = (+obj.enhance || 0);
  if (!base) return 0;
  // âœ… ê°•í™” +1ë‹¹ ê³µê²©ë ¥ +10 (ê³ ì • ìˆ˜ì¹˜)
  return base + (enh * 10);
};


    // âœ… (í˜¸í™˜) ì´ì „ ìˆ˜ì •ì—ì„œ _atkWithEnhFlat ë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆì–´ ë³„ì¹­ ì œê³µ
    const _atkWithEnhFlat = _atkWithEnhPercent;

    // âœ… ë¬´ê¸°/ì¥ë¹„ ê³µê²©ë ¥ì€ ìœ„ ê³µì‹ì„ ê·¸ëŒ€ë¡œ í•©ì‚°
    const wAtk = _atkWithEnhFlat(w);
    const aAtk = _atkWithEnhFlat(a);
    const xAtk = _atkWithEnhFlat(x);

    const eqAtk = wAtk + aAtk + xAtk;
    const eqDef = (w.def||0) + (a.def||0) + (x.def||0);
    const eqHit = (w.hit||0) + (a.hit||0) + (x.hit||0);
    const eqEva = (w.eva||0) + (a.eva||0) + (x.eva||0);

    const myAtk = Math.floor((BASE_PLAYER_ATK + (b.atkAdd||0)) * (b.atkMul ?? 1));
    player.atk = Math.max(0, myAtk + eqAtk);

    player.def = Math.floor((eqDef + (b.defAdd||0)) * (b.defMul ?? 1));
    player.hit = eqHit + b.hitAdd;
    player.eva = eqEva + b.evaAdd;

    // ê³µê²©ì†ë„/ì´ë™ì†ë„(ìŠ¤íƒ¯) ë°˜ì˜
    const baseAtkInterval = 0.55;
    player.atkInterval = Math.max(0.10, baseAtkInterval * b.atkIntervalMul);
    player.speed = R.speedChase + b.speedAdd;

    // í™•ë¥ /ë°°ìˆ˜ëŠ” í•©ì‚° í›„ ì•ˆì „ ë²”ìœ„ë¡œ í´ë¨í”„
    player.critChance = Math.max(0, Math.min(0.95, (w.critChance||0) + (a.critChance||0) + (x.critChance||0) + b.critChanceAdd));
    const baseMult = (w.critMult && w.critMult > 0) ? w.critMult : 1.50;
    const addMult  = (a.critMult||0) + (x.critMult||0);
    player.critMult = Math.max(1.10, Math.min(3.00, baseMult + addMult));

    // ê¸°ì¡´ ì½”ë“œ í˜¸í™˜ìš©
    player.dmg = player.atk;
  }

  function equipItem(slot, item){
    if (!equipment[slot] || !item) return;

    // âœ… ì¥ë¹„ëŠ” ê°œë³„ ì¸ìŠ¤í„´ìŠ¤(uid)ê¹Œì§€ ì €ì¥í•´ì•¼ ì¸ë²¤ì—ì„œ ì •í™•íˆ 1ê°œë§Œ E í‘œì‹œë¨
    equipment[slot] = {
      uid: item.uid || null,
      id: item.id || item.name || "item",
      name: item.name || "ì•„ì´í…œ",
      // âœ… baseAtk / enhance / atk(ìµœì¢…) ë¶„ë¦¬
      baseAtk: (("baseAtk" in item) ? (item.baseAtk|0) : (item.atk|0)) || 0,
      enhance: (item.enhance|0) || 0,
      atk: (((("baseAtk" in item) ? (item.baseAtk|0) : (item.atk|0)) || 0) + ((item.enhance|0)||0)),
      fixedAtk: !!item.fixedAtk,
      def: item.def||0,
      hit: item.hit||0,
      eva: item.eva||0,
      critChance: item.critChance||0,
      critMult: item.critMult||0,
      enhance: item.enhance|0 || 0,
    };

    // uidê°€ ì—†ë‹¤ë©´(êµ¬í˜• ë°ì´í„°/ì˜ˆì™¸) ë¬´ê¸° ì°©ìš© ìƒíƒœë¥¼ ë§¨ì†ìœ¼ë¡œ ë˜ëŒë ¤ ë²„ê·¸ ë°©ì§€
    if (slot === "weapon" && (!equipment.weapon.id || (equipment.weapon.id !== "fist" && !equipment.weapon.uid))){
      // êµ¬í˜•/ì˜ˆì™¸ ë°ì´í„° ë°©ì–´: "ë§¨ì†(fist)"ì€ uidê°€ ì—†ì–´ë„ ì •ìƒ ì¼€ì´ìŠ¤
      equipment.weapon = { uid:null, id:"fist", name:"ë§¨ì†", atk:0, fixedAtk:false, def:0, hit:0, eva:0, critChance:0.00, critMult:1.50 };
    }
    playEquipSound();


    recalcCombatStats();
    try{ saveToLocal(); }catch(e){}
  }


  // âœ… ë¬´ê¸° í•´ì œ(ë§¨ì†ìœ¼ë¡œ ë³µê·€)
  const BASE_FIST_WEAPON = { uid:null, id:"fist", name:"ë§¨ì†", atk:0, def:0, hit:0, eva:0, critChance:0.00, critMult:1.50, enhance:0, fixedAtk:false };

  function unequipWeapon(){
    try{
      equipment.weapon = { ...BASE_FIST_WEAPON };
      playEquipSound();
      window.equipment = equipment;
      recalcCombatStats();
      try{ saveToLocal(); }catch(_){}
    }catch(e){}
  }

  // ì „ì—­ ë…¸ì¶œ(ì¸ë²¤ UIì—ì„œ ì‚¬ìš©)
  window.equipment = equipment;
  window.equipItem = equipItem;
  window.unequipWeapon = unequipWeapon;
  window.recalcCombatStats = recalcCombatStats;

  // ëª…ì¤‘/íšŒí”¼ íŒì •: hit-eva ê¸°ë°˜ (íŠœë‹ ì‰¬ì›€)
  function rollHit(attackerHit, defenderEva){
    // base 85% + (hit-eva)*2% (ìµœì†Œ 10%, ìµœëŒ€ 95%)
    const p = Math.max(0.10, Math.min(0.95, 0.85 + (attackerHit - defenderEva) * 0.02));
    return Math.random() < p;
  }
  function rollCrit(chance){
    return Math.random() < Math.max(0, Math.min(0.95, chance||0));
  }
  function calcDamageWithCrit(atk, def, critChance, critMult){
    let dmg = Math.max(1, (atk||0) - (def||0));
    const isCrit = rollCrit(critChance);
    if (isCrit){
      const mult = (critMult||1.5);
      // âœ… ì²´ê°ìš©: í¬ë¦¬ë©´ ìµœì†Œ +1 ë³´ì • (ë‚®ì€ ë°ë¯¸ì§€ì—ì„œë„ í™•ì‹¤íˆ ë‹¬ë¼ì§)
      dmg = Math.max(dmg + 1, Math.floor(dmg * mult));
    }
    return { dmg, isCrit };
  }

  // ê¸°ì¡´ í˜¸í™˜ìš©: dmgë§Œ í•„ìš”í•œ ê³³ì€ ì´ê±¸ ì¨ë„ ë¨
  function calcDamage(atk, def, critChance, critMult){
    return calcDamageWithCrit(atk, def, critChance, critMult).dmg;
  }


  function levelUpOnce(){
    if ((player.level|0) >= MAX_LEVEL){
      player.level = MAX_LEVEL;
      player.exp = Math.min(player.exp, player.expMax);
      return false;
    }
    player.level += 1;

    // âœ… ë ˆë²¨ì—… ì—°ì¶œ: ë¨¸ë¦¬ ìœ„ 'ë ˆë²¨ì—…' í…ìŠ¤íŠ¸ + íŒŒí‹°í´
    try{ spawnLevelUpBurst(player.x, player.y - 48); }catch(e){}

        // âœ… ë ˆë²¨ì—… ì‚¬ìš´ë“œ
    try{ playLevelUpSound(); }catch(e){}
// ìŠ¤íƒ¯ ë¶„ë°°ìš© í¬ì¸íŠ¸ ì§€ê¸‰ (ë ˆë²¨ì—…ë§ˆë‹¤ 1í¬ì¸íŠ¸)
    window.statPoints = (window.statPoints|0) + 1;
    try{ if(typeof syncStatBtn === "function") syncStatBtn(); }catch(e){}
    applyPlayerStatsForLevel();
    recalcCombatStats();

    // ë ˆë²¨ì—… ë³´ìƒ: í’€íšŒë³µ
    player.hp = player.hpMax;
    player.mp = player.mpMax;
    try{ saveToLocal(); }catch(e){}
    return true;
  }

  // Rabbit stats (âœ… fixed - no scaling by player level)
  // í† ë¼ê°€ í”Œë ˆì´ì–´ ë ˆë²¨ì— ë”°ë¼ ê°•í•´ì§€ì§€ ì•Šë„ë¡ ê³ ì • ìŠ¤íƒ¯ìœ¼ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.
  // ì›í•˜ëŠ” ë‚œì´ë„ë©´ ì—¬ê¸° ìˆ«ìë§Œ ì¡°ì ˆí•˜ë©´ ë©ë‹ˆë‹¤.
  const RABBIT_FIXED_LEVEL = 1;
  const RABBIT_FIXED_HP   = 14; // ê¸°ë³¸ 10ë³´ë‹¤ ì•½ê°„ ì—¬ìœ  (ì›í•˜ë©´ 10~20 ì‚¬ì´ë¡œ ì¡°ì ˆ)
  const RABBIT_FIXED_ATK  = 1;
  const RABBIT_FIXED_DEF  = 0;
  const RABBIT_FIXED_EXP  = 6;

  function makeRabbitStats(mobLevel){
    // mobLevel ì¸ìëŠ” í˜¸í™˜ìš©(ë¬´ì‹œ)
    const level = RABBIT_FIXED_LEVEL;
    const hpMax = RABBIT_FIXED_HP;
    const atk   = RABBIT_FIXED_ATK;
    const def   = RABBIT_FIXED_DEF;
    const expGive = RABBIT_FIXED_EXP;
    return { level, hpMax, atk, def, dmg: atk, expGive };
  }

  function rollRabbitLevel(){
    // âœ… í•­ìƒ ê³ ì • ë ˆë²¨ (í”Œë ˆì´ì–´ ë ˆë²¨ ì—°ë™ ì œê±°)
    return RABBIT_FIXED_LEVEL;
  }
// ====== TREES (ë§µ ë°”ê¹¥ ì¥ì‹ìš©) ======
  const TREES_N = 30;
  const trees = [];
  const TREE_SIZE = 96; // ë‚˜ë¬´ ê·¸ë ¤ì§ˆ í¬ê¸°
  const OUT_MARGIN = 120; // ë§µ ë°”ê¹¥ ì—¬ìœ 

  function resolveCircle(a,b,minDist){
    const dx = b.x-a.x, dy = b.y-a.y;
    const d = Math.hypot(dx,dy);
    if (d === 0 || d >= minDist) return false;
    const nx = dx/d, ny = dy/d;
    const push = (minDist - d)/2;
    a.x -= nx*push; a.y -= ny*push;
    b.x += nx*push; b.y += ny*push;
    return true;
  }

  // âœ… í”Œë ˆì´ì–´ë§Œ ë°€ì–´ë‚´ëŠ” ì›í˜• ì¶©ëŒ(ëª¹ì´ ë„ë§ê°€ëŠ” ê²ƒì²˜ëŸ¼ ë³´ì´ëŠ” í˜„ìƒ ë°©ì§€)
  // mover(í”Œë ˆì´ì–´)ë§Œ ìœ„ì¹˜ë¥¼ ë³´ì •í•˜ê³ , obstacle(ëª¹)ì€ ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤.
  function resolveCircleStatic(mover, obstacle, minDist){
    const dx = mover.x - obstacle.x;
    const dy = mover.y - obstacle.y;
    const d = Math.hypot(dx, dy);
    if (d === 0 || d >= minDist) return false;
    const nx = dx / d, ny = dy / d;
    const push = (minDist - d);
    mover.x += nx * push;
    mover.y += ny * push;
    return true;
  }


  function vecToDir(vx,vy){
    if (Math.abs(vx) > Math.abs(vy)) return vx>0 ? DIR.RIGHT : DIR.LEFT;
    return vy>0 ? DIR.DOWN : DIR.UP;
  }

  function drawHpBar(screenX, screenY, w, h, ratio, fill){
    ctx.fillStyle = "rgba(0,0,0,0.6)";
    ctx.fillRect(screenX, screenY, w, h);
    ctx.fillStyle = fill;
    ctx.fillRect(screenX, screenY, Math.max(0, Math.min(1, ratio))*w, h);
  }

  // ====== MAP ======
  let MAP_W = 700, MAP_H = 700;
  const TILE = 64;

  // ====== SPRITE ======
  const HERO_FW = 50, HERO_FH = 50;
  const WALK_START = 0, WALK_LEN = 4;
  const ATK_START  = 4, ATK_LEN  = 4;
  const DIR = { DOWN:0, LEFT:1, RIGHT:2, UP:3 };

  // ====== RABBITS ======
  let RABBITS_N = 10;
  

/* ===== 2-FRAME PORTAL ANIMATION (1212.png) ===== */
const portalImg = new Image();
portalImg.src = "1212.png"; // âœ… ëŒ€í‘œë‹˜ ì²¨ë¶€ 2í”„ë ˆì„ ì‹œíŠ¸

// âœ… í¬íƒˆ ìŠ¤í”„ë¼ì´íŠ¸ ê¸°ë³¸(2í”„ë ˆì„)
const PORTAL = {
  frameCount: 2,
  fps: 2,          // ì´ˆë‹¹ 2í”„ë ˆì„(ëŠê¸‹í•œ ê¹œë¹¡ì„)
  frame: 0,
  acc: 0,
  fw: 0,
  fh: 0,
  scale: 1
};

// âœ… 2ë§µ ì „í™˜ ì‹œìŠ¤í…œ(ì†ì‚­ì„ ìˆ²ì† â†” ê³ ìš”í•œ ë“¤íŒ)
let currentMapId = "forest";
let grassTint = "forest"; // ë°°ê²½ í†¤ë§Œ ì‚´ì§ ë‹¤ë¥´ê²Œ(ë§µ êµ¬ë¶„ìš©)

// âœ… ë§µë³„ ëª¹ êµ¬ì„±(ëŒ€í‘œë‹˜ ìš”ì²­)
// - forest(ì†ì‚­ì„ ìˆ²ì†): í† ë¼ 10, ê³ ì–‘ì´ 2
// - field (ê³ ìš”í•œ ë“¤íŒ): ê³ ì–‘ì´ 10
const MAP_MOBS = {
  forest: { rabbits: 10, cats: 2 },
  field:  { rabbits: 0,  cats: 10 }
};
// ë§µ í‘œì‹œ ì´ë¦„
function mapTitleFor(id){
  return (id === "field") ? "- ê³ ìš”í•œ ë“¤íŒ -" : "- ì†ì‚­ì„ ìˆ²ì† -";
}


// í˜„ì¬ ë§µ ê¸°ì¤€ìœ¼ë¡œ ëª¹ì„ "ë¦¬ì…‹ + ì •í™•í•œ ìˆ˜ëŸ‰"ìœ¼ë¡œ ë§ì¶¤
function applyMapMobs(){
  const cfg = MAP_MOBS[currentMapId] || {rabbits: 10, cats: 2};

  // í† ë¼
  try{
    RABBITS_N = cfg.rabbits|0;
    if (typeof spawnRabbits === "function") spawnRabbits();
    else rabbits.length = 0;
  }catch(e){
    try{ rabbits.length = 0; }catch(_){}
  }

  // ê³ ì–‘ì´
  try{
    cats.length = 0;
    if (typeof spawnCats === "function") spawnCats(cfg.cats|0, window.player || player);
  }catch(e){
    try{ cats.length = 0; }catch(_){}
  }
}
// í¬íƒˆì€ 'í˜„ì¬ ë§µ'ì—ì„œ 1ê°œë§Œ í™œì„±(ë§µ ì–‘ìª½ ë)
const ACTIVE_PORTAL = {
  x: 0,
  y: 0,
  targetMap: "field",
  spawnSide: "left" // targetMapì—ì„œ ì–´ë””ë¡œ ë–¨ì–´ì§ˆì§€
};

// âœ… ìë™ì‚¬ëƒ¥ ì¤‘ í¬íƒˆ ì´ë™ ê¸ˆì§€ ê²½ê³ (ì¼ë°˜ ë¬¸êµ¬)
let portalBlockMsgT = 0; // seconds
function showPortalBlockMsg(){
  portalBlockMsgT = 1.25; // ì ê¹ ê²½ê³  ë…¸ì¶œ
}


// í¬íƒˆ ìœ„ì¹˜ ê°±ì‹ (í˜„ì¬ ë§µ ê¸°ì¤€)
function syncActivePortal(){
  // í¬íƒˆ ìŠ¤í”„ë¼ì´íŠ¸ê°€ ì•„ì§ ë¡œë”© ì „ì´ì–´ë„ 'ë§µ ìƒíƒœ(íƒ€ê²Ÿ/ì”ë””í†¤/ìŠ¤í°ì‚¬ì´ë“œ)'ëŠ” ë°˜ë“œì‹œ ë°˜ì˜ë˜ê²Œ!
  // (ëª¨ë°”ì¼ì—ì„œ ë¡œë”© íƒ€ì´ë°ì´ ëŠë¦¬ë©´, ì˜ˆì „ ì½”ë“œì²˜ëŸ¼ return ë˜ì–´ ë§µ ë³µêµ¬ê°€ ì•ˆ ëœ ê²ƒì²˜ëŸ¼ ë³´ì¼ ìˆ˜ ìˆìŒ)
  const baseW = (PORTAL.fw > 0 ? PORTAL.fw : 32); // fallback frame width
  const w = baseW * PORTAL.scale;
  const pad = 6;
  ACTIVE_PORTAL.y = MAP_H / 2;

  if(currentMapId === "forest"){
    // âœ… ì†ì‚­ì„ ìˆ²ì†: ìš°ì¸¡ í¬íƒˆ â†’ ê³ ìš”í•œ ë“¤íŒ(ì¢Œì¸¡)
    ACTIVE_PORTAL.x = MAP_W - w/2 - pad;
    ACTIVE_PORTAL.targetMap = "field";
    ACTIVE_PORTAL.spawnSide = "left";
    grassTint = "forest";
  }else{
    // âœ… ê³ ìš”í•œ ë“¤íŒ: ì¢Œì¸¡ í¬íƒˆ â†’ ì†ì‚­ì„ ìˆ²ì†(ìš°ì¸¡)
    ACTIVE_PORTAL.x = w/2 + pad;
    ACTIVE_PORTAL.targetMap = "forest";
    ACTIVE_PORTAL.spawnSide = "right";
    grassTint = "field";
  }
}

// ë§µ ì ìš© + (ì„ íƒ) ìŠ¤í° ìœ„ì¹˜ ì§€ì •
function setMap(nextMapId, spawnSide){
  currentMapId = nextMapId;

  // âœ… ë§ˆì§€ë§‰ ë§µì„ ë³„ë„ í‚¤ë¡œë„ ì¦‰ì‹œ ì €ì¥(ì„¸ì´ë¸Œê°€ ê¹¨ì ¸ë„ ë§µì€ ë³µêµ¬ë˜ê²Œ)
  try{ localStorage.setItem(LAST_MAP_KEY, currentMapId); }catch(_){}

  // âœ… ë§µ ì´ë¦„ ì—°ì¶œ(ì¤‘ì•™ ì—°ì¶œ)
  try{
    if(nextMapId === "forest") window.showMapName && window.showMapName(mapTitleFor(window.currentMapId || currentMapId));
    else window.showMapName && window.showMapName("- ê³ ìš”í•œ ë“¤íŒ -");
  }catch(_){}

  // âœ… ë‚˜ë¬´ëŠ” ë§µë§ˆë‹¤ ë‹¤ë¥´ê²Œ (ë§µ ë°”ë€” ë•Œë§ˆë‹¤ ìƒˆë¡œ ë½‘ê¸°)
  try{ spawnTrees(); }catch(_){}

  // í¬íƒˆ ìœ„ì¹˜ ê°±ì‹ 
  syncActivePortal();

  // âœ… ìŠ¤í°(í¬íƒˆ ë°Ÿìœ¼ë©´ targetMapì˜ ì§€ì • ì‚¬ì´ë“œë¡œ ë¿…!)
//    âš ï¸ ë„ì°© ì§í›„ í¬íƒˆê³¼ ê²¹ì¹˜ë©´ ë‹¤ì‹œ ë˜ëŒì•„ê°€ëŠ” "ì™”ë‹¤ë¦¬ ê°”ë‹¤ë¦¬"ê°€ ìƒê¸¸ ìˆ˜ ìˆì–´ì„œ,
//    í¬íƒˆ ì¶©ëŒ ë²”ìœ„ ë°–(í¬íƒˆ ì•ìª½)ìœ¼ë¡œ ì¶©ë¶„íˆ ë–¨ì–´ëœ¨ë ¤ ìŠ¤í°í•©ë‹ˆë‹¤.
  if (spawnSide){
    const pw = (PORTAL.fw > 0 ? (PORTAL.fw * PORTAL.scale) : 120);
    // í¬íƒˆ íŒì •ì— ì“°ëŠ” ê°’(pw*0.38 + r)ë³´ë‹¤ ë” í¬ê²Œ(ì—¬ìœ  ë§ˆì§„ í¬í•¨)
    const safeInset = (pw * 0.38) + player.r + 18;

    if (spawnSide === "left"){
      // ì¢Œì¸¡ í¬íƒˆ(ë„ì°© ë§µì˜ ì¢Œì¸¡)ì— ë‹¿ì§€ ì•Šê²Œ â†’ í¬íƒˆ ì˜¤ë¥¸ìª½(ë§µ ì•ˆìª½)ìœ¼ë¡œ ìŠ¤í°
      player.x = ACTIVE_PORTAL.x + safeInset;
      player.y = MAP_H/2;
    } else if (spawnSide === "right"){
      // ìš°ì¸¡ í¬íƒˆ(ë„ì°© ë§µì˜ ìš°ì¸¡)ì— ë‹¿ì§€ ì•Šê²Œ â†’ í¬íƒˆ ì™¼ìª½(ë§µ ì•ˆìª½)ìœ¼ë¡œ ìŠ¤í°
      player.x = ACTIVE_PORTAL.x - safeInset;
      player.y = MAP_H/2;
    } else if (spawnSide === "center"){
      player.x = MAP_W/2;
      player.y = MAP_H/2;
    }

    // ì•ˆì „ í´ë¨í”„(ë§µ ë°–ìœ¼ë¡œ ì•ˆ ë‚˜ê°€ê²Œ)
    player.x = Math.max(player.r + 4, Math.min(MAP_W - player.r - 4, player.x));
    player.y = Math.max(player.r + 4, Math.min(MAP_H - player.r - 4, player.y));
  }


  // âœ… ë§µë³„ ëª¹ ë¦¬ì…‹/ìŠ¤í°(í”Œë ˆì´ì–´ ìœ„ì¹˜ ì´ë™ í›„ì— ì‹¤í–‰í•´ì•¼ ë§µ í•œìª½ìœ¼ë¡œ ëª°ë¦¬ì§€ ì•ŠìŒ)
  try{ applyMapMobs(); }catch(_){}

  // í¬íƒˆ ì—°ì† ë°œë™ ë°©ì§€(ì§§ì€ ì¿¨)
  player.portalLock = 0.85;

  // âœ… ë§µ ì´ë™ ì§í›„ ì¦‰ì‹œ ì €ì¥(ì¢…ë£Œ ì§ì „ì— ì €ì¥ ì‹¤íŒ¨í•´ë„ ë§µì€ ë‚¨ë„ë¡)
  try{ if (typeof saveToLocal === "function") saveToLocal(); }catch(_){}
}

portalImg.addEventListener("load", ()=>{
  const w = (portalImg.naturalWidth || portalImg.width);
  const h = (portalImg.naturalHeight || portalImg.height);
  PORTAL.fw = Math.floor(w / PORTAL.frameCount);
  PORTAL.fh = Math.floor(h);

  // ìµœì´ˆ í¬íƒˆ ìœ„ì¹˜ ì„¸íŒ…
  syncActivePortal();
});

/* ===== CAT MONSTER INTEGRATION (SAFE ADD) ===== */
const catImg = new Image();
catImg.src = "cat.png";

const C = {
  cols: 4, rows: 4,
  fw: 0, fh: 0,
  r: 14,

  // ì´ë™/AI (í† ë¼ AI êµ¬ì¡°ì™€ ë™ì¼)
  speedWander: 0.42,
  speedChase:  0.72,
  detectRadius: 130,
  giveUpRadius: 170,
  wanderChangeMin: 0.7,
  wanderChangeMax: 1.8,
  animFPS: 8,

  // ê³µê²©
  dmg: 1,
  atkInterval: 0.95
};


// â± ê³ ì–‘ì´ ë¦¬ìŠ¤í° ì‹œê°„(ì´ˆ) - ì—¬ê¸° ìˆ«ìë§Œ ë°”ê¾¸ë©´ ë¨
const CAT_RESPAWN_SEC = 10;
// âœ… ê³ ì–‘ì´ ìŠ¤í”„ë¼ì´íŠ¸ í”„ë ˆì„ í¬ê¸° ìë™ ê³„ì‚°(4x4)
catImg.addEventListener("load", ()=>{
  try{
    C.fw = Math.floor((catImg.naturalWidth || catImg.width) / C.cols);
    C.fh = Math.floor((catImg.naturalHeight || catImg.height) / C.rows);
  }catch(_){}
});


const cats = [];
function spawnCats(n=2, anchor){
  // âœ… player ì„ ì–¸ ì „ì— í˜¸ì¶œë¼ë„ ì•ˆ í„°ì§€ê²Œ ì•ˆì „ ì²˜ë¦¬
  const pl = anchor || window.player || null;
  const baseX = pl ? pl.x : (MAP_W/2);
  const baseY = pl ? pl.y : (MAP_H/2);

  for(let i=0;i<n;i++){
    // âœ… í† ë¼ ìŠ¤íƒ¯ì˜ 2ë°°(HP/ê³µê²©ë ¥)
    const _rbSt = (typeof makeRabbitStats === 'function') ? makeRabbitStats(1) : {hpMax:14, atk:1, def:0, dmg:1};
    const _catHpMax = (_rbSt.hpMax||10) * 2;
    const _catDmg   = (_rbSt.atk||_rbSt.dmg||1) * 2;
    const _catDef   = (_rbSt.def||0);

    cats.push({
      x: (currentMapId === "field") ? rand(24, MAP_W-24) : clamp(baseX + (Math.random()*260-130), 24, MAP_W-24),
      y: (currentMapId === "field") ? rand(24, MAP_H-24) : clamp(baseY + (Math.random()*260-130), 24, MAP_H-24),

      // (í˜„ì¬ëŠ” í† ë¼ì²˜ëŸ¼ ì£½ìŒ/ë¦¬ìŠ¤í°ê¹Œì§€ ë¶™ì´ì§€ ì•Šê³ , ë°°íšŒ/ì¶”ê²©/ê³µê²©ë§Œ)
      hp: _catHpMax,
      hpMax: _catHpMax,

      vx: 0, vy: 1,
      dir: DIR.DOWN,
      frame: Math.floor(Math.random()*4),
      tAnim: 0,

      state: "wander",
      tWander: rand(C.wanderChangeMin, C.wanderChangeMax),
      atk: _catDmg,
      dmg: _catDmg,
      def: _catDef,
      atkCooldown: rand(0, C.atkInterval),

      alpha: 1,
      respawnT: 0,
      kind: 'cat'
    });

    // ì‹œì‘ ë°°íšŒ ë°©í–¥ ì„¸íŒ…
    pickCatWander(cats[cats.length-1]);
  }
}

// âœ… player ì¤€ë¹„ëœ ë’¤ í•œ ë²ˆë§Œ ìŠ¤í°
function ensureCats(){
  if (cats.length) return;
  spawnCats(2, window.player);
}
function pickCatWander(c){
  const a = Math.random()*Math.PI*2;
  c.vx = Math.cos(a);
  c.vy = Math.sin(a);
  c.tWander = rand(C.wanderChangeMin, C.wanderChangeMax);
}

function animateCatWalk(c, dt){
  c.tAnim += dt;
  if (c.tAnim >= 1/C.animFPS){
    c.tAnim = 0;
    c.frame = (c.frame + 1) % 4;
  }
}

function catAttack(c){
  if (typeof player === "undefined") return;
  if (player.state !== 'alive') return;
  if (c.atkCooldown > 0) return;
  c.atkCooldown = C.atkInterval;

  // ëª…ì¤‘/íšŒí”¼ëŠ” í† ë¼ì™€ ë™ì¼í•œ ë°©ì‹ ì‚¬ìš© (ê³ ì–‘ì´ëŠ” ë³„ë„ hit ìŠ¤íƒ¯ì´ ì—†ìœ¼ë‹ˆ 0ìœ¼ë¡œ)
  if (!rollHit(c.hit||0, player.eva||0)){
    spawnWordText(player.x, player.y - 24, "íšŒí”¼", "rgba(170, 255, 120, 0.98)");
    return;
  }

  const taken = calcDamage((c.atk || c.dmg || C.dmg || 0), (player.def||0), c.critChance||0, c.critMult||1.5);
  player.hp = Math.max(0, player.hp - taken);

  spawnDmgText(player.x, player.y - 22, taken, "rgba(255,70,70,0.98)", false);
  spawnBlood(player.x, player.y - 6);

  if (player.hp <= 0){
    player.hp = 0;
    player.state = 'dead';
try{
      deathSfx.currentTime = 0;
      deathSfx.play().catch(()=>{});
    }catch(e){}
  }
}

function updateCats(dt){
  if (typeof player === "undefined") return;

  const d2 = C.detectRadius*C.detectRadius;
  const g2 = C.giveUpRadius*C.giveUpRadius;
  const contact2 = (player.r + C.r) * (player.r + C.r);

  for(const c of cats){
    // ì´ˆê¸°ê°’ ë³´ì •(êµ¬ë²„ì „ ì €ì¥ ë°ì´í„° ëŒ€ë¹„)
    if (c.vx === undefined){ c.vx = 0; c.vy = 1; }
    if (c.tAnim === undefined) c.tAnim = 0;
    if (c.tWander === undefined) c.tWander = rand(C.wanderChangeMin, C.wanderChangeMax);
    if (!c.state || c.state === "idle") c.state = "wander";
    if (c.atkCooldown === undefined) c.atkCooldown = rand(0, C.atkInterval);

    // âœ… ì£½ì€ ê³ ì–‘ì´: í˜ì´ë“œì•„ì›ƒ + ë¦¬ìŠ¤í° íƒ€ì´ë¨¸ë§Œ ì²˜ë¦¬í•˜ê³  ë¡œì§ ìŠ¤í‚µ
    if (c.state === 'dead'){
      // í˜ì´ë“œì•„ì›ƒ
      c.alpha = Math.max(0, (c.alpha ?? 1) - 1.4 * dt);

      // âš ï¸ respawnTê°€ 0/undefinedë¡œ ë“¤ì–´ì˜¤ë©´ ì¦‰ì‹œ ë¦¬ìŠ¤í°ë˜ëŠ” ë²„ê·¸ ë°©ì§€
      // (ì£½ëŠ” ìˆœê°„ì—ëŠ” ë°˜ë“œì‹œ CAT_RESPAWN_SECë¡œ ì„¸íŒ…ë˜ì–´ì•¼ í•¨)
      if (c.respawnT == null || c.respawnT <= 0){
        c.respawnT = CAT_RESPAWN_SEC;
      }

      // íƒ€ì´ë¨¸ ê°ì†Œ
      c.respawnT -= dt;

      // íƒ€ì´ë¨¸ ëë‚˜ë©´ ëœë¤ ë¦¬ìŠ¤í°
      if (c.respawnT <= 0){
        c.x = rand(C.r, MAP_W - C.r);
        c.y = rand(C.r, MAP_H - C.r);

        c.hp = c.hpMax;
        c.state = 'wander';
        c.alpha = 1;

        // ë¦¬ìŠ¤í° ì§í›„ ê³µê²© ë”œë ˆì´ ì•½ê°„ ëœë¤(ìì—°ìŠ¤ëŸ½ê²Œ)
        c.atkCooldown = rand(0, C.atkInterval);

        // ë°°íšŒ ë°©í–¥/ëª©í‘œ ì¬ì„¤ì •
        pickCatWander(c);

        // ë‹¤ìŒ ì‚¬ë§ ë•Œë¥¼ ìœ„í•´ ì´ˆê¸°í™”
        c.respawnT = 0;
      }
      continue;
    }

    c.atkCooldown = Math.max(0, c.atkCooldown - dt);

    const dd = dist2(c.x, c.y, player.x, player.y);
    const touching = dd <= contact2;

    if (touching){
      // ì´ë™ì€ ë©ˆì¶”ì§€ë§Œ ê±·ê¸° ëª¨ì…˜ì€ ìœ ì§€(í† ë¼ì™€ ë™ì¼)
      c.state = "attack";
      c.vx = 0; c.vy = 0;

      // í”Œë ˆì´ì–´ ë°”ë¼ë³´ê¸°
      c.dir = vecToDir(player.x - c.x, player.y - c.y);

      animateCatWalk(c, dt);
      catAttack(c);
    } else {
      if (c.state === "wander" && dd <= d2) c.state = "chase";
      if (c.state === "chase" && dd >= g2){ c.state = "wander"; pickCatWander(c); }

      let mvx=0, mvy=0, spd=0;

      if (c.state === "chase"){
        const dx = player.x - c.x, dy = player.y - c.y;
        const len = Math.hypot(dx,dy) || 1;
        mvx = dx/len; mvy = dy/len; spd = C.speedChase;
      } else {
        c.tWander -= dt;
        if (c.tWander <= 0) pickCatWander(c);
        mvx = c.vx; mvy = c.vy; spd = C.speedWander;
      }

      c.x += mvx*spd;
      c.y += mvy*spd;

      c.x = clamp(c.x, C.r, MAP_W-C.r);
      c.y = clamp(c.y, C.r, MAP_H-C.r);

      const moving = (Math.abs(mvx)+Math.abs(mvy))>0.01;
      if (moving) c.dir = vecToDir(mvx,mvy);

      if (moving) animateCatWalk(c, dt);
      else c.frame = 0;
    }
  }

  // ê³ ì–‘ì´ë¼ë¦¬ ë¶„ë¦¬
  for (let i=0;i<cats.length;i++){
    const a = cats[i];
    for (let j=i+1;j<cats.length;j++){
      const b = cats[j];
      if (a.state === 'dead' || b.state === 'dead') continue;
      resolveCircle(a,b,C.r*2);
      a.x = clamp(a.x, C.r, MAP_W-C.r); a.y = clamp(a.y, C.r, MAP_H-C.r);
      b.x = clamp(b.x, C.r, MAP_W-C.r); b.y = clamp(b.y, C.r, MAP_H-C.r);
    }
  }

  // í”Œë ˆì´ì–´-ê³ ì–‘ì´ ë¶„ë¦¬
  for (const c of cats){
    if (c.state === 'dead') continue; // âœ… ì£½ìë§ˆì ì¶©ëŒ ì œê±°
    resolveCircleStatic(player, c, player.r + C.r);
    player.x = clamp(player.x, player.r, MAP_W-player.r);
    player.y = clamp(player.y, player.r, MAP_H-player.r);
    c.x = clamp(c.x, C.r, MAP_W-C.r);
    c.y = clamp(c.y, C.r, MAP_H-C.r);
  }
}

function drawCat(c, camX, camY){
  if(!(catImg.complete && (catImg.naturalWidth>0 || catImg.width>0))) return;
  if(!C.fw || !C.fh) return;

  // âœ… í™”ë©´ì— ê·¸ë¦´ í¬ê¸°ë¥¼ í† ë¼/í”Œë ˆì´ì–´ ì‹œíŠ¸(50x50) ê¸°ì¤€ìœ¼ë¡œ í‚¤ì›€
  const dw = HERO_FW;
  const dh = HERO_FH;

  const col = Math.floor(c.frame);
  const row = c.dir;

  const sx = c.x - camX - dw/2;
  const sy = c.y - camY - dh/2;

  ctx.save();
  ctx.globalAlpha = c.alpha;

  ctx.drawImage(
    catImg,
    col*C.fw,
    row*C.fh,
    C.fw, C.fh,
    Math.round(sx), Math.round(sy),
    dw, dh
  );

  // âœ… ê³ ì–‘ì´ ë‹‰ë„¤ì„ + HPë°” (í† ë¼ì™€ ë™ì¼í•œ ìŠ¤íƒ€ì¼)
  ctx.font = "bold 11px system-ui, -apple-system, 'Segoe UI', sans-serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "bottom";

  // ê·¸ë¦¼ì
  ctx.fillStyle = "rgba(0,0,0,0.6)";
  ctx.fillText(
    "ê³ ì–‘ì´",
    Math.round(c.x - camX),
    Math.round(c.y - camY - dh/2 + 28)
  );

  // ë³¸ë¬¸ í…ìŠ¤íŠ¸
  ctx.fillStyle = "#ffffff";
  ctx.fillText(
    "ê³ ì–‘ì´",
    Math.round(c.x - camX),
    Math.round(c.y - camY - dh/2 + 28)
  );

  if ((c.state !== 'respawn') && c.alpha > 0){
    const bw = 22, bh = 4;
    const bx = (c.x - camX) - bw/2;
    const by = (c.y - camY) - dh/2 - bh + 13;
    drawHpBar(bx, by, bw, bh, c.hp/c.hpMax, "rgba(255,120,120,1)");
  }

  ctx.restore();
}

const rabbits = [];

  const R = {
    cols: 4, rows: 4,
    fw: 0, fh: 0,
    speedWander: 0.4,
    speedChase:  0.7,
    detectRadius: 130,
    giveUpRadius: 170,
    wanderChangeMin: 0.7,
    wanderChangeMax: 1.8,
    animFPS: 8,
    r: 14,
    hpMax: 10,
    dmg: 1,
    atkInterval: 0.9,
    fadeSpeed: 0.67,
    respawnDelay: 10,
    expGive: 6
  };

  function pickWander(rb){
    const a = Math.random()*Math.PI*2;
    rb.vx = Math.cos(a);
    rb.vy = Math.sin(a);
    rb.tWander = rand(R.wanderChangeMin, R.wanderChangeMax);
  }

  function newRabbit(){
    const mobLv = rollRabbitLevel();
    const st = makeRabbitStats(mobLv);
    const rb = {
      x: rand(20, MAP_W-20),
      y: rand(20, MAP_H-20),
      vx: 0, vy: 0,
      dir: DIR.DOWN,
      frame: Math.floor(Math.random()*4),
      tAnim: 0,
      state: 'wander',
      tWander: rand(R.wanderChangeMin, R.wanderChangeMax),
      level: st.level,
      hpMax: st.hpMax,
      hp: st.hpMax,
      atk: st.atk,
      def: st.def,
      dmg: st.dmg,
      atkCooldown: rand(0, R.atkInterval),
      alpha: 1,
      expGive: st.expGive,
      respawnT: 0,
      kbVx: 0,
      kbVy: 0,
      kbT: 0
    };
    pickWander(rb);
    return rb;
  }

  function spawnRabbits(){
    rabbits.length = 0;
    for (let i=0;i<RABBITS_N;i++) rabbits.push(newRabbit());
  }

  function rabbitRespawn(rb){
    rb.x = rand(20, MAP_W-20);
    rb.y = rand(20, MAP_H-20);
    const mobLv = rollRabbitLevel();
    const st = makeRabbitStats(mobLv);
    rb.level = st.level;
    rb.hpMax = st.hpMax;
    rb.atk = st.atk;
    rb.def = st.def;
    rb.dmg = st.dmg;
    rb.expGive = st.expGive;
    rb.hp = rb.hpMax;
    rb.alpha = 1;
    rb.state = 'wander';
    rb.atkCooldown = rand(0, R.atkInterval);
    pickWander(rb);
  }

  // ====== PLAYER ======
  const player = {
    x: MAP_W/2, y: MAP_H/2,
    r: 16,
    dir: DIR.DOWN,
    walkFrame: 0,
    atkFrame: 0,
    animT: 0,
    attacking: false,
    level: 1,
    hpMax: 50,
    hp: 50,
    mpMax: 20,
    mp: 20,
    expMax: 30,
    exp: 0,
    // ì „íˆ¬ ìŠ¤íƒ¯(ì•„ì´í…œ í•©ì‚°)
    atk: 2,
    def: 0,
    hit: 0,
    eva: 0,
    critChance: 0,
    critMult: 1.5,
    speed: R.speedChase,
    alpha: 1,
    state: 'alive',
    respawnT: 0,
    respawnDelay: 2,

    atkCooldown: 0,
    atkInterval: 0.55,
    dmg: 2,
    auto: false,
    autoDelay: 0,        // ìë™ì‚¬ëƒ¥ ì§€ì—° íƒ€ì´ë¨¸
    autoDelayTime: 1.0,
  };

  // âœ… ì„¸ì´ë¸Œ/ë¡œë“œ ì‹œìŠ¤í…œì—ì„œ ì°¸ì¡°í•  ìˆ˜ ìˆë„ë¡ ì „ì—­ì— ì—°ê²°
  window.player = player;

  // expose for HUD updater (outside IIFE)
  window.player = player;
    try{ if (typeof ensureCats==='function') ensureCats(); }catch(e){}
// âœ… expose stat appliers for UI code outside this IIFE
  window.applyPlayerStatsForLevel = applyPlayerStatsForLevel;
  window.recalcCombatStats = recalcCombatStats;
  window.calcStatBonus = calcStatBonus;
  // âœ… (ì•ˆì „ì¥ì¹˜) ì„¸ì´ë¸Œ ë¡œë“œë³´ë‹¤ ë¨¼ì € 'ë§ˆì§€ë§‰ ë§µ' í‚¤ê°€ ìˆìœ¼ë©´ ìš°ì„  ë°˜ì˜
  //    - ëª¨ë°”ì¼ì—ì„œ beforeunloadê°€ ì•ˆ ëœ¨ê±°ë‚˜ ì„¸ì´ë¸Œê°€ ê¼¬ì—¬ë„, ë§ˆì§€ë§‰ ë§µì€ ë³µêµ¬ë˜ê²Œ
  try{
    const lm = localStorage.getItem(LAST_MAP_KEY);
    if (lm === "forest" || lm === "field"){ 
      if (typeof setMap === "function") setMap(lm, "center");
      else currentMapId = lm;
    }
  }catch(_){ }






  // âœ… ë¡œì»¬ ìë™ ë¶ˆëŸ¬ì˜¤ê¸°(ìˆìœ¼ë©´ ì§„í–‰ ìƒíƒœ ë³µì›)
  try{ loadFromLocal(); }catch(e){}

  // âœ… ìµœì´ˆ ì ‘ì†(ë¡œë“œ í¬í•¨) ì‹œ ìë™ì‚¬ëƒ¥ì€ ê¸°ë³¸ OFF. Auto ë²„íŠ¼ìœ¼ë¡œë§Œ í† ê¸€.
  try{ player.auto = false; window.autoHunt = false; }catch(_){}


  // âœ… ìë™ ì €ì¥: ë§µ/ë ˆë²¨/ìŠ¤íƒ¯/ì¸ë²¤ ë“± ì§„í–‰ìƒíƒœë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ ë¡œì»¬ì— ì €ì¥
  try{
    const AUTOSAVE_MS = 4000;
    if (!window.__autosaveTimer){
      window.__autosaveTimer = setInterval(()=>{ try{ saveToLocal(); }catch(e){} }, AUTOSAVE_MS);
    }
    // íƒ­ ì „í™˜/ì¢…ë£Œ ì‹œì—ë„ ì €ì¥(ëª¨ë°”ì¼ì—ì„œë„ pagehide/visibilitychangeê°€ ë” ì˜ ì¡í˜)
    if (!window.__autosaveHooks){
      window.__autosaveHooks = true;
      addEventListener("beforeunload", ()=>{ try{ saveToLocal(); }catch(e){} });
      addEventListener("pagehide", ()=>{ try{ saveToLocal(); }catch(e){} });
      document.addEventListener("visibilitychange", ()=>{ if (document.hidden){ try{ saveToLocal(); }catch(e){} }});
    }
  }catch(_){}



  // init stats (Lv1 fixed) + item-only combat stats
  applyPlayerStatsForLevel();
  recalcCombatStats();
  player.hp = player.hpMax;
  player.mp = player.mpMax;

  const keys = Object.create(null);
  let manualMove = false;

  addEventListener('keydown', (e) => {
    if (!started) return; // íƒ€ì´í‹€ í™”ë©´ì—ì„  ì…ë ¥ ë§‰ê¸°
    keys[e.key] = true;
    if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','w','a','s','d','W','A','S','D'].includes(e.key)) manualMove = true;
    if (e.key === ' ') { e.preventDefault(); tryPlayerAttack(); }
  }, {passive:false});
  addEventListener('keyup', (e) => {
    if (!started) return;
    keys[e.key] = false;
    manualMove = (keys['ArrowUp']||keys['ArrowDown']||keys['ArrowLeft']||keys['ArrowRight']||
                  keys['w']||keys['a']||keys['s']||keys['d']||keys['W']||keys['A']||keys['S']||keys['D']) || false;
  }, {passive:true});


// ====== VIRTUAL JOYSTICK (touch + mouse: ì•„ë¬´ ê³³ì´ë‚˜ ëˆ„ë¥´ë©´ ìƒì„±) ======
const joy = {
  active:false,
  pointerId:null,
  baseX:0, baseY:0,
  knobX:0, knobY:0,
  vx:0, vy:0,
  mag:0,
  radius:60,
  deadZone:0.12, // 0~1 (ì‘ì„ìˆ˜ë¡ ë¯¼ê°)
  downT:0,
  moved:false,
};

const joyEl = document.getElementById('joy');
const joyBaseEl = document.getElementById('joyBase');
const joyKnobEl = document.getElementById('joyKnob');

function isUIHit(target){
  // ì±„íŒ… HUD/íƒ€ì´í‹€ ë²„íŠ¼ ë“± UI í´ë¦­ì€ ì¡°ì´ìŠ¤í‹± ë°©í•´í•˜ì§€ ì•Šê²Œ ì˜ˆì™¸ ì²˜ë¦¬
  return !!(target && (target.closest('#chatToggleBtn') || target.closest('#twChatHud') || target.closest('#titleOverlay') || target.closest('.startBtn') || target.closest('#statBtn') || target.closest('#statPanel') || target.closest('#invBtn') || target.closest('#invPanel') || target.closest('#equipStatusBtn') || target.closest('#equipPanel') || target.closest('#enhanceModal') || target.closest('#enhanceBackdrop')));
}

function showJoy(x, y){
  joy.radius = (innerWidth <= 520) ? 54 : 60;
  joy.baseX = x; joy.baseY = y;
  joy.knobX = x; joy.knobY = y;
  joy.vx = 0; joy.vy = 0; joy.mag = 0;
  joy.downT = performance.now();
  joy.moved = false;

  joyBaseEl.style.left = x + 'px';
  joyBaseEl.style.top  = y + 'px';
  joyKnobEl.style.left = x + 'px';
  joyKnobEl.style.top  = y + 'px';
  joyBaseEl.style.display = 'block';
  joyKnobEl.style.display = 'block';
}

function hideJoy(){
  joy.active = false;
  joy.pointerId = null;
  joy.vx = joy.vy = joy.mag = 0;
  joyBaseEl.style.display = 'none';
  joyKnobEl.style.display = 'none';
}

function moveJoy(x, y){
  const dx = x - joy.baseX;
  const dy = y - joy.baseY;
  const d = Math.hypot(dx, dy) || 1;
  const clamped = Math.min(joy.radius, d);
  const nx = dx / d;
  const ny = dy / d;

  joy.knobX = joy.baseX + nx * clamped;
  joy.knobY = joy.baseY + ny * clamped;

  joyKnobEl.style.left = joy.knobX + 'px';
  joyKnobEl.style.top  = joy.knobY + 'px';

  joy.vx = nx;
  joy.vy = ny;
  joy.mag = clamp(clamped / joy.radius, 0, 1);
  if (clamped > 6) joy.moved = true;
}

// í¬ì¸í„° ì´ë²¤íŠ¸(ëª¨ë°”ì¼ í„°ì¹˜ + PC ë§ˆìš°ìŠ¤) í†µí•©
addEventListener('pointerdown', (e) => {
  if (!started) return;              // íƒ€ì´í‹€ í™”ë©´ì—ì„œëŠ” ë¬´ì‹œ(ë²„íŠ¼ í´ë¦­ìš©)
  const _hitEl = document.elementFromPoint(e.clientX, e.clientY) || e.target;
  if (isUIHit(_hitEl)) return;     // UI ìœ„ì—ì„œëŠ” ë¬´ì‹œ (pointer-capture ëŒ€ë¹„)
  if (e.button != null && e.button !== 0) return; // ë§ˆìš°ìŠ¤ ì¢Œí´ë¦­ë§Œ

  joy.active = true;
  joy.pointerId = e.pointerId;
  showJoy(e.clientX, e.clientY);

  // ìº”ë²„ìŠ¤ ë“œë˜ê·¸/í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€
  try { canvas.setPointerCapture(e.pointerId); } catch(_){}
  e.preventDefault();
}, {passive:false});

addEventListener('pointermove', (e) => {
  if (!joy.active) return;
  if (joy.pointerId !== e.pointerId) return;
  moveJoy(e.clientX, e.clientY);
  e.preventDefault();
}, {passive:false});

function joyUpCommon(e){
  if (!joy.active) return;
  if (joy.pointerId !== e.pointerId) return;

  const held = performance.now() - joy.downT;

  // âœ… ì§§ê²Œ íƒ­(ë“œë˜ê·¸ ê±°ì˜ ì—†ìŒ) = ê³µê²©(ê¸°ì¡´ touchstart ê³µê²©ì„ ëŒ€ì²´)
  if (!joy.moved && held < 220){
    tryPlayerAttack();
  }

  hideJoy();
  e.preventDefault();
}

addEventListener('pointerup', joyUpCommon, {passive:false});
addEventListener('pointercancel', joyUpCommon, {passive:false});

// ====== CAMERA ======
  function camera(){
    const vw = innerWidth, vh = innerHeight;
    let camX = player.x - vw/2, camY = player.y - vh/2;
    camX = (MAP_W <= vw) ? (MAP_W - vw)/2 : Math.max(0, Math.min(MAP_W - vw, camX));
    camY = (MAP_H <= vh) ? (MAP_H - vh)/2 : Math.max(0, Math.min(MAP_H - vh, camY));
    return {camX, camY, vw, vh};
  }

  // ====== PARTICLES (í”¼ íŠ) ======
  const particles = [];
  function spawnBlood(px, py, boost=1){
    const count = Math.max(1, Math.round(14 * (boost||1)));
    for (let i=0;i<count;i++){
      const a = Math.random()*Math.PI*2;
      const sp = rand(40, 130);
      particles.push({
        x: px, y: py,
        vx: Math.cos(a)*sp,
        vy: Math.sin(a)*sp,
        life: rand(0.25, 0.55),
        t: 0,
        r: rand(1.5, 3.2)
      });
    }
  }
  function updateParticles(dt){
    for (let i=particles.length-1;i>=0;i--){
      const p = particles[i];
      p.t += dt;
      p.vy += 220*dt;
      p.x += p.vx*dt;
      p.y += p.vy*dt;
      if (p.t >= p.life) particles.splice(i,1);
    }
  }
  function drawParticles(camX, camY){
    ctx.save();
    for (const p of particles){
      const a = 1 - (p.t / p.life);
      ctx.globalAlpha = Math.max(0, a);
      ctx.fillStyle = "rgba(255,70,70,1)";
      ctx.beginPath();
      ctx.arc(p.x - camX, p.y - camY, p.r, 0, Math.PI*2);
      ctx.fill();
    }
    ctx.restore();
  }

  // ====== DAMAGE TEXT PARTICLES (ë– ì˜¤ë¥´ëŠ” ìˆ˜ì¹˜) ======
  const dmgTexts = [];
  function spawnDmgText(wx, wy, value, color, isCrit=false){
    const v = Math.max(0, value|0);
    dmgTexts.push({
      x: wx,
      y: wy,
      vy: -rand(42, 78),          // ìœ„ë¡œ
      vx: rand(-10, 10),          // ì‚´ì§ í”ë“¤
      t: 0,
      life: isCrit ? 0.55 : 0.75, // âœ… í¬ë¦¬ëŠ” ë” ë¹¨ë¦¬ ì‚¬ë¼ì§
      value: v,
      color,
      isCrit,
      // âœ… í¬ë¦¬ ìˆ˜ì¹˜: ì²˜ìŒì— í¬ê²Œ 'íŒ' â†’ ë¹ ë¥´ê²Œ ì¤„ì–´ë“¤ë„ë¡ ì‹œì‘ ìŠ¤ì¼€ì¼ì„ í¬ê²Œ
      scale: isCrit ? 2.15 : 1.0,
    });
  }

function updateDmgTexts(dt){
    for (let i=dmgTexts.length-1;i>=0;i--){
      const d = dmgTexts[i];
      d.t += dt;

      // âœ… í¬ë¦¬ ìˆ˜ì¹˜: ë¹ ë¥´ê²Œ ì¤„ì–´ë“¤ë©° ì•ˆì •
      if (d.isCrit){
        const target = 0.88;
        d.scale += (target - d.scale) * (1 - Math.pow(0.00001, dt));
      } else {
        d.scale += (1.0 - d.scale) * (1 - Math.pow(0.00001, dt)); // pop->settle
      }

      d.x += d.vx * dt;
      d.y += d.vy * dt;
      d.vy += 55 * dt;
      d.vx *= (1 - 3.2*dt);
      if (d.t >= d.life) dmgTexts.splice(i,1);
    }
  }

function drawDmgTexts(camX, camY){
    ctx.save();
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    for (const d of dmgTexts){
      const p = d.t / d.life;
      const a = 1 - p;

      const sx = d.x - camX;
      const sy = d.y - camY;

      // ì‚´ì§ "íŒ¡" íŠ€ëŠ” ëŠë‚Œ
      const pop = d.isCrit ? ((p < 0.10) ? (1.0 + (0.10 - p) * 6.8) : 1.0)
                        : ((p < 0.12) ? (1.0 + (0.12 - p) * 3.4) : 1.0);

      ctx.globalAlpha = Math.max(0, a);

      const base = d.isCrit ? 18 : 15;
      const size = Math.round(base * d.scale * pop);
      ctx.font = `800 ${size}px system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif`;

      const text = String(d.value);

      // outline
      ctx.lineWidth = d.isCrit ? 6 : 5;
      ctx.strokeStyle = "rgba(0,0,0,0.60)";
      ctx.strokeText(text, sx, sy);

      // fill
      ctx.fillStyle = d.isCrit ? "rgba(255, 70, 70, 0.98)" : (d.color || "rgba(255,230,120,0.98)");
      ctx.fillText(text, sx, sy);
    }

    ctx.restore();
  }


  // ====== FLOAT WORD PARTICLES (MISS/íšŒí”¼) ======
  const wordTexts = [];
  function spawnWordText(wx, wy, text, color){
    wordTexts.push({
      x: wx,
      y: wy,
      text: String(text || ""),
      t: 0,
      life: 0.55,
      color: color || "rgba(200,200,200,0.95)",
      scale: 0.75,      // ì‹œì‘ ì‘ê²Œ
      grow: 2.2,        // ì ì  ì»¤ì§
      vy: -12,          // ê±°ì˜ ì œìë¦¬(ì‚´ì§ ìœ„)
      vx: rand(-6, 6),
    });
  }
  function updateWordTexts(dt){
    for (let i=wordTexts.length-1;i>=0;i--){
      const w = wordTexts[i];
      w.t += dt;
      w.x += w.vx * dt;
      w.y += w.vy * dt;
      w.vx *= (1 - 3.0*dt);
      w.scale += w.grow * dt; // ì ì  ì»¤ì§
      if (w.t >= w.life) wordTexts.splice(i,1);
    }
  }
  function drawWordTexts(camX, camY){
    ctx.save();
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    for (const w of wordTexts){
      const p = w.t / w.life;
      const a = 1 - p;
      const sx = w.x - camX;
      const sy = w.y - camY;

      ctx.globalAlpha = Math.max(0, a);
      ctx.font = `900 ${Math.round(16 * w.scale)}px system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif`;

      // outline
      ctx.lineWidth = 5;
      ctx.strokeStyle = "rgba(0,0,0,0.60)";
      ctx.strokeText(w.text, sx, sy);

      // fill
      ctx.fillStyle = w.color;
      ctx.fillText(w.text, sx, sy);
    }
    ctx.restore();
  }
  // ====== ë ˆë²¨ì—… í…ìŠ¤íŠ¸/íŒŒí‹°í´ (ë¨¸ë¦¬ ìœ„ì—ì„œ 'ë ˆë²¨ì—…' íŒ¡! í©ì–´ì§) ======
  const levelUpBursts = [];   // í° í…ìŠ¤íŠ¸ 1ê°œ(íŒ¡)
  const levelUpSparks = [];   // ì£¼ë³€ ìŠ¤íŒŒí¬(í©ì–´ì§)

  function spawnLevelUpBurst(wx, wy){
    // ë©”ì¸ í…ìŠ¤íŠ¸
    levelUpBursts.push({
      x: wx,
      y: wy,
      t: 0,
      life: 0.75,
      vx: rand(-8, 8),
      vy: rand(-32, -22),
      rot: rand(-0.12, 0.12),
      wobble: rand(8, 14), // ì‚´ì§ í”ë“¤ë¦¼(ë„)
    });

    // ìŠ¤íŒŒí¬ íŒŒí‹°í´
    const n = 26;
    for(let i=0;i<n;i++){
      const ang = rand(0, Math.PI*2);
      const sp  = rand(70, 190);
      levelUpSparks.push({
        x: wx,
        y: wy,
        vx: Math.cos(ang)*sp,
        vy: Math.sin(ang)*sp - rand(40, 120),
        t: 0,
        life: rand(0.55, 0.95),
        g: rand(220, 360),
        size: rand(1.6, 3.6),
        rot: rand(-3.14, 3.14),
        vr: rand(-6, 6),
        // ë°ì€ ìŠ¤íŒŒí¬ í†¤(ëœë¤)
        col: (Math.random()<0.5)
          ? `rgba(${(220+rand(0,35))|0}, ${(180+rand(0,55))|0}, ${(60+rand(0,80))|0}, 1)`
          : `rgba(${(120+rand(0,80))|0}, ${(200+rand(0,55))|0}, ${(255)|0}, 1)`
      });
    }
  }

  function updateLevelUpFx(dt){
    // bursts
    for(let i=levelUpBursts.length-1;i>=0;i--){
      const b = levelUpBursts[i];
      b.t += dt;
      b.x += b.vx * dt;
      b.y += b.vy * dt;
      b.vy += 60 * dt; // ì‚´ì§ ì¤‘ë ¥
      if (b.t >= b.life) levelUpBursts.splice(i,1);
    }
    // sparks
    for(let i=levelUpSparks.length-1;i>=0;i--){
      const s = levelUpSparks[i];
      s.t += dt;
      s.x += s.vx * dt;
      s.y += s.vy * dt;
      s.vy += s.g * dt;
      s.rot += s.vr * dt;
      // ê³µê¸° ì €í•­(ì‚´ì§)
      s.vx *= Math.pow(0.18, dt);
      s.vy *= Math.pow(0.65, dt);
      if (s.t >= s.life) levelUpSparks.splice(i,1);
    }
  }

  function drawLevelUpFx(camX, camY){
    // sparks ë¨¼ì €
    ctx.save();
    for(const s of levelUpSparks){
      const p = s.t / s.life;
      const a = Math.max(0, 1 - p);
      const sx = s.x - camX;
      const sy = s.y - camY;

      ctx.globalAlpha = a;
      ctx.translate(sx, sy);
      ctx.rotate(s.rot);

      ctx.fillStyle = s.col;
      // ì‘ì€ ë‹¤ì´ì•„/ë§‰ëŒ€ ëŠë‚Œ
      const w = s.size * 2.0;
      const h = s.size * 0.9;
      ctx.fillRect(-w*0.5, -h*0.5, w, h);

      ctx.setTransform(1,0,0,1,0,0);
    }
    ctx.restore();

    // í° í…ìŠ¤íŠ¸
    ctx.save();
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    for(const b of levelUpBursts){
      const p = b.t / b.life;                // 0..1
      const a = Math.max(0, 1 - p);

      // íŒ¡! ì»¤ì¡Œë‹¤ê°€ ì‚´ì§ ì¤„ì–´ë“œëŠ” ì´ì§•
      const pop = (p < 0.22)
        ? (p/0.22)                 // 0->1
        : (1 - (p-0.22)/0.78)*0.18; // 1->0.82ì¯¤
      const scale = 0.55 + 1.55 * pop;

      const sx = b.x - camX;
      const sy = b.y - camY;

      ctx.save();
      ctx.translate(sx, sy);

      // í”ë“¤ë¦¼
      const wob = Math.sin(b.t * 18) * (b.wobble * (1 - p));
      ctx.rotate(b.rot + wob * Math.PI/180);

      ctx.globalAlpha = a;

      const fontPx = Math.round(46 * scale);
      ctx.font = `900 ${fontPx}px system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif`;

      // ì•„ì›ƒë¼ì¸ + ê¸€ë¡œìš° ëŠë‚Œ
      ctx.lineWidth = Math.max(3, fontPx * 0.10);
      ctx.strokeStyle = "rgba(0,0,0,0.70)";
      ctx.fillStyle = "rgba(255,235,120,0.98)";
      ctx.shadowColor = "rgba(255,230,120,0.55)";
      ctx.shadowBlur = 18;

      ctx.strokeText("ë ˆë²¨ì—…", 0, 0);
      ctx.fillText("ë ˆë²¨ì—…", 0, 0);

      ctx.restore();
    }
    ctx.restore();
  }


  // ====== CRIT TEXT POP (ì¹˜ëª…íƒ€) ======
  const critTexts = [];
  function spawnCritText(wx, wy, text="ì¹˜ëª…íƒ€"){
    critTexts.push({
      x: wx,
      y: wy,
      text: String(text||"ì¹˜ëª…íƒ€"),
      t: 0,
      life: 0.35,     // âœ… ë” ì§§ê²Œ(ë¹ ë¥´ê²Œ íŒ!)
      scale: 0.22,    // âœ… ë” ì‘ê²Œ ì‹œì‘í–ˆë‹¤ê°€ íŒ!
      vx: rand(-8, 8),
      vy: -14
    });
  }
  function updateCritTexts(dt){
    for (let i=critTexts.length-1;i>=0;i--){
      const c = critTexts[i];
      c.t += dt;
      c.x += c.vx * dt;
      c.y += c.vy * dt;
      c.vx *= (1 - 3.6*dt);
      // ë¹ ë¥´ê²Œ ì»¤ì¡Œë‹¤ê°€ ì‚´ì§ ì•ˆì •
      const p = c.t / c.life;
      const target = (p < 0.10) ? 1.60 : 0.85;
      c.scale += (target - c.scale) * (1 - Math.pow(0.00001, dt));
      if (c.t >= c.life) critTexts.splice(i,1);
    }
  }
  function drawCritTexts(camX, camY){
    ctx.save();
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    for (const c of critTexts){
      const p = c.t / c.life;
      const a = 1 - p;
      const sx = c.x - camX;
      const sy = c.y - camY;

      // ì´ˆë°˜ íŒ! í™•ëŒ€
      const pop = (p < 0.08) ? (1.0 + (0.08 - p) * 11.0) : 1.0;

      ctx.globalAlpha = Math.max(0, a);
      const size = Math.round(22 * c.scale * pop); // ì—¬ê¸° ìˆ«ì ì¤„ì´ë©´ ì „ì²´ ê¸€ì í¬ê¸° ì‘ì•„ì§
      ctx.font = `900 ${size}px system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif`;

      // outline
      ctx.lineWidth = 7;
      ctx.strokeStyle = "rgba(0,0,0,0.65)";
      ctx.strokeText(c.text, sx, sy);

      // fill (ì§„í•œ ë¹¨ê°„ìƒ‰)
      ctx.fillStyle = "rgba(255, 90, 210, 0.98)"; // âœ… ë¶„í™ìƒ‰ í†¤
      ctx.fillText(c.text, sx, sy);
    }
    ctx.restore();
  }


  // ====== COMBAT HELPERS ======
  function nearestAliveRabbit(){
    // âœ… í† ë¼ + ê³ ì–‘ì´ ì¤‘ì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ 'ì‚´ì•„ìˆëŠ” ëª¹'ì„ ì°¾ëŠ”ë‹¤
    let best = null;
    let bestD = Infinity;
    for (const m of [...rabbits, ...cats]){
      if (!m) continue;
      if (m.hp <= 0) continue;
      if (m.state === 'dead' || m.state === 'respawn') continue;
      const d = dist2(player.x, player.y, m.x, m.y);
      if (d < bestD){ bestD = d; best = m; }
    }
    return best;
  }

  const CONTACT = player.r + R.r + 1;
  const CONTACT2 = CONTACT * CONTACT;


  // ====== TWITCH CHAT: ì „íˆ¬ ì¤‘ ìë™ íˆ¬ëª… (ê¹œë¹¡ì„ ë°©ì§€ ë²„ì „) ======
  const twitchChatWrapEl = document.getElementById('twitchChatWrap');

  // âœ… íˆìŠ¤í…Œë¦¬ì‹œìŠ¤(ì§€ì—°) íŒŒë¼ë¯¸í„°
  const CHAT_FADE_IN_DELAY   = 0.12; // ì „íˆ¬ ì‹œì‘ íŒì •ì´ ì—°ì†ìœ¼ë¡œ ìœ ì§€ë˜ë©´ ON
  const CHAT_FADE_OUT_HOLD   = 0.60; // ì „íˆ¬ê°€ ëë‚˜ë„ ì ê¹ ìœ ì§€ í›„ OFF
  const CHAT_TOGGLE_COOLDOWN = 0.12; // í† ê¸€ ìµœì†Œ ê°„ê²©

  let _chatCombatOn = false;
  let _combatSeenT = 0;         // ì „íˆ¬ê°€ "ì—°ì†ìœ¼ë¡œ" ê°ì§€ëœ ì‹œê°„
  let _noCombatT = 0;           // ì „íˆ¬ê°€ "ì—°ì†ìœ¼ë¡œ" ê°ì§€ë˜ì§€ ì•Šì€ ì‹œê°„
  let _toggleCooldownT = 0;     // í† ê¸€ ì¿¨ë‹¤ìš´

  function applyChatCombatFade(on){
    if (!twitchChatWrapEl) return;
    // âœ… ì–´ë–¤ ê²½ìš°ì—ë„ combatFadeëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
    twitchChatWrapEl.classList.remove('combatFade');
  }

  // ë§¤ í”„ë ˆì„ í˜¸ì¶œ: inCombat ì‹ í˜¸ë¥¼ ë¶€ë“œëŸ½ê²Œ(ì§€ì—°/ìœ ì§€) ì²˜ë¦¬
  function updateChatCombatFade(inCombat, dt){ /* disabled */ }

  function tryPlayerAttack(){
    if (player.state !== 'alive') return;
    if (player.atkCooldown > 0) return;

    for (const rb of [...rabbits, ...cats]){
      if (rb.hp <= 0 || rb.state === 'dead' || rb.state === 'respawn') continue;
      const d = dist2(player.x, player.y, rb.x, rb.y);
      const rr = (rb.kind === 'cat') ? C.r : R.r;
      const contact2 = (player.r + rr + 1) * (player.r + rr + 1);
      if (d <= contact2){
        // âœ… ê³µê²© ëŒ€ìƒ(ëª¹) ë°©í–¥ì„ ë°”ë¼ë³´ê³  ê³µê²© ëª¨ì…˜ ì‹œì‘
        player.dir = vecToDir(rb.x - player.x, rb.y - player.y);

        player.attacking = true;
        player.atkFrame = 0;
        player.animT = 0;
        player.atkCooldown = player.atkInterval;

        if (!rollHit(player.hit||0, rb.eva||0)){
          // âœ… MISS íŒŒí‹°í´(ëª¬ìŠ¤í„° ëª¸ì—ì„œ ì ì  ì»¤ì§€ë©° ì‚¬ë¼ì§)
          spawnWordText(rb.x, rb.y - 18, "MISS", "rgba(180, 235, 255, 0.98)");
          return;
        }
        const res = calcDamageWithCrit(player.atk||0, rb.def||0, player.critChance||0, player.critMult||1.5);
        const dealt = res.dmg;
        const isCrit = !!res.isCrit;
        rb.hp -= dealt;

        // âœ… ëª¹ í”¼ê²© ìˆ˜ì¹˜ íŒŒí‹°í´(íŒ + ìœ„ë¡œ)
        spawnDmgText(
          rb.x, rb.y - 18,
          dealt,
          isCrit ? "rgba(255, 70, 70, 0.98)" : "rgba(255,235,120,0.98)",
          isCrit
        );

        // âœ… í¬ë¦¬ ì—°ì¶œ: ì¹˜ëª…íƒ€ í…ìŠ¤íŠ¸ + í”¼ ë” ë§ì´ + ìˆœê°„ ë„‰ë°± + í¬ë¦¬ ì‚¬ìš´ë“œ
        if (isCrit){
          spawnCritText(rb.x, rb.y - 34, "ì¹˜ëª…íƒ€");

          // âœ… íˆíŠ¸ìŠ¤í†±(0.05ì´ˆ)
          hitStopT = Math.max(hitStopT, 0.05);

          // âœ… í”¼ ë” ë§ì´(ì¹˜ëª…íƒ€)
          spawnBlood(rb.x, rb.y, 3.2);

          // âœ… ë„‰ë°± ì œê±°: ì‚¬ëƒ¥ íë¦„ ë°©í•´ ë°©ì§€ (ì¹˜ëª…íƒ€ëŠ” í…ìŠ¤íŠ¸/í”¼/ì‚¬ìš´ë“œë§Œ)

          try{
            critSfx.currentTime = 0;
            critSfx.play().catch(()=>{});
}catch(e){}
        } else {
          spawnBlood(rb.x, rb.y, 1.0);
        }

        // âœ… ëª¹ í”¼ê²© íš¨ê³¼ìŒ
        try{
          hitSfx.currentTime = 0;
          hitSfx.play().catch(()=>{});
}catch(e){}

        // âœ… ê³µê²© íš¨ê³¼ìŒ ì¬ìƒ
        try{
          attackSfx.currentTime = 0;
          attackSfx.play().catch(()=>{});
}catch(e){}

        // âœ… 1/10 í™•ë¥  ê¸°í•©ìŒ
        if (Math.random() < 0.1){
          try{
            kihapSfx.currentTime = 0;
            kihapSfx.play().catch(()=>{});
}catch(e){}
        }

        if (rb.hp <= 0){
          rb.hp = 0;
          if (rb.state !== 'dead'){
            rb.state = 'dead';
            // âœ… ëª¹ ì‚¬ë§ ì‚¬ìš´ë“œ (í† ë¼ / ê³ ì–‘ì´ ë¶„ë¦¬)
            if (rb.kind === 'cat'){
              try{ sndCatDie.currentTime = 0; sndCatDie.play().catch(()=>{}); }catch(e){}
            } else {
              try{ sndRabbitDie.currentTime = 0; sndRabbitDie.play().catch(()=>{}); }catch(e){}
            }
          }

          // âœ… EXP íšë“ (ëª¹ë§ˆë‹¤ expGive ë§Œí¼)
          player.exp += (rb.expGive || R.expGive || 0);

          // âœ… ë ˆë²¨ì—…: EXPê°€ ìµœëŒ€ì¹˜ë¥¼ ë„˜ìœ¼ë©´ ë ˆë²¨ ì¦ê°€ (ì´ˆê³¼ë¶„ ì´ì›”) (ìµœëŒ€ Lv100)
          while (player.expMax > 0 && player.exp >= player.expMax){
            player.exp -= player.expMax;
            if (!levelUpOnce()){
              break;
            }
          }


          // âœ… í† ë¼ ì‚¬ë§ íš¨ê³¼ìŒ
          try{
            rabbitDeathSfx.currentTime = 0;
            rabbitDeathSfx.play().catch(()=>{});
}catch(e){}


        } else {
          rb.state = 'attack';
        }
        return;
      }
    }

    // âœ… ê³ ì–‘ì´ë„ ëª¹ìœ¼ë¡œ ì¸ì‹í•´ì„œ ê³µê²© ëŒ€ìƒì— í¬í•¨
    const CAT_CONTACT = player.r + C.r + 1;
    const CAT_CONTACT2 = CAT_CONTACT * CAT_CONTACT;

    for (const c of cats){
      if (c.hp <= 0) continue;
      if (c.state === 'dead' || c.state === 'respawn') continue;
      const d = dist2(player.x, player.y, c.x, c.y);
      if (d <= CAT_CONTACT2){
        player.dir = vecToDir(c.x - player.x, c.y - player.y);

        player.attacking = true;
        player.atkFrame = 0;
        player.animT = 0;
        player.atkCooldown = player.atkInterval;

        if (!rollHit(player.hit||0, c.eva||0)){
          spawnWordText(c.x, c.y - 18, "MISS", "rgba(180, 235, 255, 0.98)");
          return;
        }

        const res = calcDamageWithCrit(player.atk||0, c.def||0, player.critChance||0, player.critMult||1.5);
        const dealt = res.dmg;
        const isCrit = !!res.isCrit;
        c.hp -= dealt;

        spawnDmgText(
          c.x, c.y - 18,
          dealt,
          isCrit ? "rgba(255, 70, 70, 0.98)" : "rgba(255,235,120,0.98)",
          isCrit
        );

        if (isCrit){
          spawnCritText(c.x, c.y - 34, "ì¹˜ëª…íƒ€");
          hitStopT = Math.max(hitStopT, 0.05);
          spawnBlood(c.x, c.y, 3.2);
          try{ critSfx.currentTime = 0; critSfx.play().catch(()=>{}); }catch(e){}
        } else {
          spawnBlood(c.x, c.y, 1.0);
        }

        try{ hitSfx.currentTime = 0; hitSfx.play().catch(()=>{}); }catch(e){}
        try{ attackSfx.currentTime = 0; attackSfx.play().catch(()=>{}); }catch(e){}

        if (Math.random() < 0.1){
          try{ kihapSfx.currentTime = 0; kihapSfx.play().catch(()=>{}); }catch(e){}
        }

        // âœ… ê³ ì–‘ì´ ì‚¬ë§ ì²˜ë¦¬(í˜ì´ë“œì•„ì›ƒ + â±ë¦¬ìŠ¤í° íƒ€ì´ë¨¸ ì‹œì‘)
        if (c.hp <= 0){
          c.hp = 0;

          // ì´ë¯¸ deadë©´ ì¤‘ë³µ ì„¸íŒ… ë°©ì§€
          if (c.state !== 'dead'){
            c.state = 'dead';
    sndCatDie.currentTime = 0;
    sndCatDie.play().catch(()=>{});
            c.alpha = 1;                 // ì£½ëŠ” ìˆœê°„ 1ì—ì„œ ì‹œì‘ â†’ updateCatsì—ì„œ í˜ì´ë“œì•„ì›ƒ
            c.respawnT = CAT_RESPAWN_SEC; // â± ë¦¬ìŠ¤í° ì‹œê°„(ì´ˆ)
            c.vx = 0; c.vy = 0;           // ì£½ì€ ë™ì•ˆ ì´ë™ ì •ì§€(ì—†ì–´ë„ ë˜ì§€ë§Œ ì•ˆì „)
            c.atkCooldown = 9999;         // ì£½ì€ ë™ì•ˆ ê³µê²© ê¸ˆì§€(ì•ˆì „)
          }
        } else {
          c.state = 'attack';
        }

return;
      }
    }
  }

  function rabbitAttack(rb){
    if (player.state !== 'alive') return;
    if (rb.atkCooldown > 0) return;
    rb.atkCooldown = R.atkInterval;
    if (!rollHit(rb.hit||0, player.eva||0)){
    // âœ… íšŒí”¼ íŒŒí‹°í´(í”Œë ˆì´ì–´ ëª¸ì—ì„œ ì ì  ì»¤ì§€ë©° ì‚¬ë¼ì§)
    spawnWordText(player.x, player.y - 24, "íšŒí”¼", "rgba(170, 255, 120, 0.98)");
    return;
  }
  const taken = calcDamage((rb.atk || rb.dmg || R.dmg || 0), (player.def||0), rb.critChance||0, rb.critMult||1.5);
  player.hp = Math.max(0, player.hp - taken);

    // âœ… í”Œë ˆì´ì–´ í”¼ê²© ìˆ˜ì¹˜ íŒŒí‹°í´(íŒ + ìœ„ë¡œ)
    spawnDmgText(player.x, player.y - 22, taken, "rgba(255,70,70,0.98)", false);
    spawnBlood(player.x, player.y - 6);

    if (player.hp <= 0){
      player.hp = 0;
      player.state = 'dead';
      // âœ… í”Œë ˆì´ì–´ ì‚¬ë§ íš¨ê³¼ìŒ
      try{
        deathSfx.currentTime = 0;
        deathSfx.play().catch(()=>{});
}catch(e){}
    }
  }

  // ====== UPDATE ======
  function updatePlayer(dt){
    if (player.state === 'dead'){
      player.alpha = Math.max(0, player.alpha - R.fadeSpeed * dt);
      if (player.alpha <= 0){
        player.state = 'respawn';
        player.respawnT = player.respawnDelay;
      }
      return;
    }
    if (player.state === 'respawn'){
      player.respawnT -= dt;

      if (player.respawnT <= 0){
        player.state = 'alive';
        applyPlayerStatsForLevel();
        recalcCombatStats();
        player.alpha = 1;
        player.hp = player.hpMax;
        player.mp = player.mpMax;
        player.x = MAP_W/2;
        player.y = MAP_H/2;

        player.dir = DIR.DOWN;   // í•­ìƒ ì•„ë˜ ë°©í–¥ìœ¼ë¡œ ìŠ¤í°

        player.attacking = false;
        player.atkCooldown = 0;

        player.auto = false;                 // ì¦‰ì‹œ ìë™ì‚¬ëƒ¥ OFF
        player.autoDelay = player.autoDelayTime; // 1ì´ˆ ì¹´ìš´íŠ¸ ì‹œì‘
      }
      return;
    }

    player.atkCooldown = Math.max(0, player.atkCooldown - dt);

    
let mvx = 0, mvy = 0;
let moving = false;

// 1) í‚¤ë³´ë“œ ì´ë™ (ê¸°ì¡´)
if (manualMove){
  if (keys['ArrowUp'] || keys['w'] || keys['W'])    { mvy -= 1; moving = true; }
  if (keys['ArrowDown'] || keys['s'] || keys['S']) { mvy += 1; moving = true; }
  if (keys['ArrowLeft'] || keys['a'] || keys['A']) { mvx -= 1; moving = true; }
  if (keys['ArrowRight'] || keys['d'] || keys['D']){ mvx += 1; moving = true; }
  const len = Math.hypot(mvx,mvy) || 1;
  mvx /= len; mvy /= len;
  if (moving && !player.attacking) player.dir = vecToDir(mvx,mvy);

// 2) ê°€ìƒ ì¡°ì´ìŠ¤í‹± ì´ë™ (ëª¨ë°”ì¼/PC ê³µìš©)
} else if (joy.active && joy.mag > joy.deadZone){
  mvx = joy.vx * joy.mag;
  mvy = joy.vy * joy.mag;
  moving = true;
  if (!player.attacking) player.dir = vecToDir(mvx,mvy);

// 3) ìë™ì‚¬ëƒ¥ ì´ë™
} else if (player.auto){
      const target = nearestAliveRabbit();
      if (target){
        const dx = target.x - player.x, dy = target.y - player.y;
        const d = Math.hypot(dx,dy) || 1;
        const nx = dx/d, ny = dy/d;

        // âœ… íƒ€ê²Ÿì´ í† ë¼/ê³ ì–‘ì´ì¸ì§€ì— ë”°ë¼ ì ‘ì´‰ íŒì • ê±°ë¦¬ ì¡°ì •
        const tr = (target.kind === 'cat') ? C.r : R.r;
        const contact2 = (player.r + tr + 1) * (player.r + tr + 1);

        if (d*d <= contact2 * 1.05){
          mvx = 0; mvy = 0;
          moving = false;
          tryPlayerAttack();
        } else {
          mvx = nx; mvy = ny;
          moving = true;
          if (!player.attacking) player.dir = vecToDir(mvx,mvy);
        }
      }
    }

    const spd = player.attacking ? player.speed * 0.35 : player.speed;
    player.x += mvx * spd;
    player.y += mvy * spd;

    player.x = clamp(player.x, player.r, MAP_W - player.r);
    player.y = clamp(player.y, player.r, MAP_H - player.r);


    // ====== PORTAL TOUCH â†’ MAP TRANSITION ======
    // í¬íƒˆ ì—°ì† ì§„ì… ë°©ì§€ ì¿¨íƒ€ì„
    if (player.portalLock == null) player.portalLock = 0;
    if (player.portalLock > 0) player.portalLock = Math.max(0, player.portalLock - dt);

    // í¬íƒˆ ë‹¿ìœ¼ë©´ ë§µ ì´ë™
    if (player.portalLock <= 0 && PORTAL.fw > 0){
      const pw = PORTAL.fw * PORTAL.scale;
      const ph = PORTAL.fh * PORTAL.scale;

      // í”Œë ˆì´ì–´(ì›) vs í¬íƒˆ(ì‚¬ê°) ê°„ë‹¨ ê²¹ì¹¨ íŒì •
      const dx = Math.abs(player.x - ACTIVE_PORTAL.x);
      const dy = Math.abs(player.y - ACTIVE_PORTAL.y);

      const hitX = dx <= (pw*0.38 + player.r);
      const hitY = dy <= (ph*0.38 + player.r);

      if (hitX && hitY){
        // âœ… ìë™ì‚¬ëƒ¥ ì¤‘ì—ëŠ” í¬íƒˆ ì´ë™ ê¸ˆì§€ + ê²½ê³  ë¬¸êµ¬
        const autoOn = (!!player.auto) || (!!window.autoHunt);
        if (autoOn){
          showPortalBlockMsg();
        } else {
          // âœ… í˜„ì¬ ë§µì— ë”°ë¼ ëª©í‘œ ë§µ/ìŠ¤í° ì‚¬ì´ë“œê°€ ê²°ì •ë¨
          setMap(ACTIVE_PORTAL.targetMap, ACTIVE_PORTAL.spawnSide);
        }
      }
    }

    player.animT += dt;

    if (player.attacking){
      if (player.animT >= 1/14){
        player.animT = 0;
        player.atkFrame++;
        if (player.atkFrame >= ATK_LEN){
          player.attacking = false;
          player.atkFrame = 0;
        }
      }
    } else if (moving){
      if (player.animT >= 1/10){
        player.animT = 0;
        player.walkFrame = (player.walkFrame + 1) % WALK_LEN;
      }

      // âœ… ë°œì†Œë¦¬ ì¬ìƒ (ì´ë™ ì¤‘ ì¼ì • ê°„ê²©)
      const now = performance.now() / 1000;
      if (now - lastStepTime > STEP_INTERVAL){
        try{
          footstep.currentTime = 0;
          footstep.play().catch(()=>{});
}catch(e){}
        lastStepTime = now;
      }

    } else {
      player.walkFrame = 0;
    }
  }

  function animateRabbitWalk(rb, dt){
    rb.tAnim += dt;
    if (rb.tAnim >= 1/R.animFPS){
      rb.tAnim = 0;
      rb.frame = (rb.frame + 1) % 4;
    }
  }

  function updateRabbits(dt){
  updateCats(dt);
    const d2 = R.detectRadius*R.detectRadius;
    const g2 = R.giveUpRadius*R.giveUpRadius;

    for (const rb of rabbits){
      if (rb.state === 'respawn'){
        rb.respawnT -= dt;
        if (rb.respawnT <= 0) rabbitRespawn(rb);
        continue;
      }

      if (rb.state === 'dead'){
        rb.alpha = Math.max(0, rb.alpha - R.fadeSpeed * dt);
        if (rb.alpha <= 0){
          rb.state = 'respawn';
          rb.respawnT = R.respawnDelay;
        }
        continue;
      }

      rb.atkCooldown = Math.max(0, rb.atkCooldown - dt);

      const dd = dist2(rb.x, rb.y, player.x, player.y);
      const touching = dd <= CONTACT2;

      if (touching){
        // ì´ë™ì€ ë©ˆì¶”ì§€ë§Œ ìŠ¤í”„ë¼ì´íŠ¸ ê±·ê¸° ëª¨ì…˜ì€ ê³„ì†
        rb.state = 'attack';
        rb.vx = 0; rb.vy = 0;

        // ë°©í–¥ì€ í”Œë ˆì´ì–´ë¥¼ ë°”ë¼ë³´ê²Œ
        rb.dir = vecToDir(player.x - rb.x, player.y - rb.y);

        // ëª¨ì…˜ ê³„ì†
        animateRabbitWalk(rb, dt);

        rabbitAttack(rb);
      } else {
        if (rb.state === 'wander' && dd <= d2) rb.state = 'chase';
        if (rb.state === 'chase' && dd >= g2) { rb.state = 'wander'; pickWander(rb); }

        let mvx=0, mvy=0, spd=0;

        if (rb.state === 'chase'){
          const dx = player.x - rb.x, dy = player.y - rb.y;
          const len = Math.hypot(dx,dy) || 1;
          mvx = dx/len; mvy = dy/len; spd = R.speedChase;
        } else {
          rb.tWander -= dt;
          if (rb.tWander <= 0) pickWander(rb);
          mvx = rb.vx; mvy = rb.vy; spd = R.speedWander;
        }

        rb.x += mvx*spd;
        rb.y += mvy*spd;

        rb.x = clamp(rb.x, R.r, MAP_W-R.r);
        rb.y = clamp(rb.y, R.r, MAP_H-R.r);

        const moving = (Math.abs(mvx)+Math.abs(mvy))>0.01;
        if (moving) rb.dir = vecToDir(mvx,mvy);

        if (moving) animateRabbitWalk(rb, dt);
        else rb.frame = 0;
      }
    }

    // í† ë¼ë¼ë¦¬ ë¶„ë¦¬
    for (let i=0;i<rabbits.length;i++){
      const a = rabbits[i];
      if (a.state === 'dead' || a.state === 'respawn') continue;
      for (let j=i+1;j<rabbits.length;j++){
        const b = rabbits[j];
        if (b.state === 'dead' || b.state === 'respawn') continue;
        resolveCircle(a,b,R.r*2);
        a.x = clamp(a.x, R.r, MAP_W-R.r); a.y = clamp(a.y, R.r, MAP_H-R.r);
        b.x = clamp(b.x, R.r, MAP_W-R.r); b.y = clamp(b.y, R.r, MAP_H-R.r);
      }
    }

    // í”Œë ˆì´ì–´-í† ë¼ ë¶„ë¦¬
    for (const rb of rabbits){
      if (rb.state === 'dead' || rb.state === 'respawn') continue;
      resolveCircleStatic(player, rb, player.r + R.r);
      player.x = clamp(player.x, player.r, MAP_W-player.r);
      player.y = clamp(player.y, player.r, MAP_H-player.r);
      rb.x = clamp(rb.x, R.r, MAP_W-R.r);
      rb.y = clamp(rb.y, R.r, MAP_H-R.r);
    }
  }

  // ====== DRAW ======

  function drawPortal(portal, camX, camY){
    if (!(portalImg.complete && portalImg.naturalWidth>0 && PORTAL.fw>0)) return;

    // ì›”ë“œ -> ìŠ¤í¬ë¦°
    const w = PORTAL.fw * PORTAL.scale;
    const h = PORTAL.fh * PORTAL.scale;
    const sx = (portal.x - camX) - w/2;
    const sy = (portal.y - camY) - h/2;

    ctx.save();
    ctx.imageSmoothingEnabled = false; // í”½ì…€ ëŠë‚Œ ìœ ì§€
    ctx.drawImage(
      portalImg,
      PORTAL.frame * PORTAL.fw, 0, PORTAL.fw, PORTAL.fh,
      Math.round(sx), Math.round(sy), Math.round(w), Math.round(h)
    );
    ctx.restore();
  }

  function drawGrass(camX, camY, vw, vh){
    const startTX = Math.floor(camX / TILE);
    const startTY = Math.floor(camY / TILE);
    const endTX = Math.ceil((camX + vw) / TILE);
    const endTY = Math.ceil((camY + vh) / TILE);

    for (let ty = startTY; ty < endTY; ty++){
      for (let tx = startTX; tx < endTX; tx++){
        const wx = tx*TILE, wy = ty*TILE;
        ctx.drawImage(grassImg, 0, 0, grassImg.width, grassImg.height,
                      wx - camX, wy - camY, TILE, TILE);
      }
    }
  }

  function drawRabbit(rb, camX, camY){
    if (!(rabbitImg.complete && rabbitImg.naturalWidth>0)) return;

    const col = rb.frame;
    const row = rb.dir;
    const sx = rb.x - camX - R.fw/2;
    const sy = rb.y - camY - R.fh/2;

    ctx.save();
    ctx.globalAlpha = rb.alpha;

    ctx.drawImage(rabbitImg, col*R.fw, row*R.fh, R.fw, R.fh,
                  Math.round(sx), Math.round(sy), R.fw, R.fh);

    
    // âœ… í† ë¼ ë‹‰ë„¤ì„ í‘œì‹œ (ë¨¸ë¦¬ ìœ„)
    ctx.font = "bold 11px system-ui, -apple-system, 'Segoe UI', sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "bottom";

    // ê·¸ë¦¼ì
    ctx.fillStyle = "rgba(0,0,0,0.6)";
    ctx.fillText(
      "í† ë¼",
      Math.round(rb.x - camX),
    Math.round(rb.y - camY - R.fh/2 + 28)
    );

    // ë³¸ë¬¸ í…ìŠ¤íŠ¸
    ctx.fillStyle = "#ffffff";
    ctx.fillText(
      "í† ë¼",
      Math.round(rb.x - camX),
     Math.round(rb.y - camY - R.fh/2 + 28)
    );
// HPë°” ë”± ë¶™ê²Œ
    if (rb.state !== 'respawn' && rb.alpha > 0){
    ctx.fillStyle = "#ffffff";
      

      const bw = 22, bh = 4;
      const bx = (rb.x - camX) - bw/2;
      const by = (rb.y - camY) - R.fh/2 - bh + 13;
      drawHpBar(bx, by, bw, bh, rb.hp/rb.hpMax, "rgba(255,120,120,1)");
    }

    ctx.restore();
  }

  function drawPlayer(camX, camY){
    if (!(heroImg.complete && heroImg.naturalWidth>0)) return;

    const col = player.attacking ? (ATK_START + player.atkFrame) : (WALK_START + player.walkFrame);
    const sx = player.x - camX - HERO_FW/2;
    const sy = player.y - camY - HERO_FH/2;

    ctx.save();
    ctx.globalAlpha = player.alpha;

    ctx.drawImage(heroImg, col*HERO_FW, player.dir*HERO_FH, HERO_FW, HERO_FH,
                  Math.round(sx), Math.round(sy), HERO_FW, HERO_FH);

    if (player.state !== 'respawn' && player.alpha > 0){
      const bw = 28, bh = 5;
      const bx = (player.x - camX) - bw/2;
      const by = (player.y - camY) - HERO_FH/2 - bh - 1;

      // â–¶ Level text above HP bar
      ctx.font = "bold 11px system-ui, -apple-system, 'Segoe UI', sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "bottom";
      ctx.fillStyle = "rgba(0,0,0,0.6)";
      ctx.fillText(`Lv: ${player.level}`, Math.round(player.x - camX), Math.round(by - 4));
      ctx.fillStyle = "#ffffff";
      ctx.fillText(`Lv: ${player.level}`, Math.round(player.x - camX), Math.round(by - 5));

      drawHpBar(bx, by, bw, bh, player.hp/player.hpMax, "rgba(150,255,150,1)");
    }

    ctx.restore();
  }

  function drawTrees(camX, camY){
    if (!(treeImg.complete && treeImg.naturalWidth > 0)) return;
    for (const t of trees){
      ctx.drawImage(
        treeImg,
        t.x - camX - TREE_SIZE/2,
        t.y - camY - TREE_SIZE,
        TREE_SIZE,
        TREE_SIZE
      );
    }
  }

  // ====== LOOP ======
  let last = performance.now();


  let hitStopT = 0; // âœ… íˆíŠ¸ìŠ¤í†± íƒ€ì´ë¨¸(ì´ˆ)
  function startGame(){
    if (started) return;
    started = true;

    R.fw = Math.floor(rabbitImg.naturalWidth / R.cols);
    R.fh = Math.floor(rabbitImg.naturalHeight / R.rows);
    // âœ… ìµœì´ˆ ì‹œì‘ ì‹œì—ë„ 'í˜„ì¬ ë§µ' ëª¹ êµ¬ì„±ì„ ì •í™•íˆ ë°˜ì˜
    try{ applyMapMobs(); }catch(_){ spawnRabbits(); }
    spawnTrees();

    last = performance.now();
    requestAnimationFrame(loop);
  }

  function loop(t){
    const rawDt = Math.min(0.05, (t-last)/1000);
    last = t;

    
    // ====== PORTAL ANIM UPDATE ======
    // íˆíŠ¸ìŠ¤í†±/ì „íˆ¬ ì—¬ë¶€ì™€ ìƒê´€ì—†ì´ ìì—°ìŠ¤ëŸ½ê²Œ ê¹œë¹¡ì´ê²Œ rawDtë¡œ ì—…ë°ì´íŠ¸
    if (PORTAL.fw > 0){
      PORTAL.acc += rawDt;
      const step = 1 / (PORTAL.fps || 2);
      while (PORTAL.acc >= step){
        PORTAL.acc -= step;
        PORTAL.frame = (PORTAL.frame + 1) % PORTAL.frameCount;
      }
    }
// âœ… íˆíŠ¸ìŠ¤í†±: ì ê¹(0.05ì´ˆ) ì‹œê°„ ì •ì§€(ì—…ë°ì´íŠ¸ 0ìœ¼ë¡œ)
    if (hitStopT > 0){
      hitStopT = Math.max(0, hitStopT - rawDt);
    }
    const dt = (hitStopT > 0) ? 0 : rawDt;

    // âœ… ê²½ê³  ë¬¸êµ¬ëŠ” íˆíŠ¸ìŠ¤í†±ê³¼ ë¬´ê´€í•˜ê²Œ ìì—°ìŠ¤ëŸ½ê²Œ ê°ì†Œ
    if (portalBlockMsgT > 0) portalBlockMsgT = Math.max(0, portalBlockMsgT - rawDt);

    updatePlayer(dt);

    // ìë™ì‚¬ëƒ¥ ì§€ì—° ì²˜ë¦¬
    if (player.autoDelay > 0){
      player.autoDelay -= dt;
      if (player.autoDelay <= 0){
        player.auto = true; // 1ì´ˆ í›„ ìë™ì‚¬ëƒ¥ ON
      }
    }


    updateRabbits(dt);
    updateParticles(dt);
    updateDmgTexts(dt);
    updateWordTexts(dt);
    updateCritTexts(dt);
    updateLevelUpFx(dt);

    // ì „íˆ¬ íŒì •: í”Œë ˆì´ì–´ê°€ ì‚´ì•„ìˆê³ , ì ‘ì´‰ ê±°ë¦¬ ë‚´ ì‚´ì•„ìˆëŠ” í† ë¼ê°€ ìˆê±°ë‚˜ í”Œë ˆì´ì–´ê°€ ê³µê²© ëª¨ì…˜ì´ë©´ ì „íˆ¬ë¡œ ê°„ì£¼
    let inCombat = false;
    if (player.state === 'alive'){
      if (player.attacking) {
        inCombat = true;
      } else {
        for (const rb of rabbits){
          if (rb.state === 'dead' || rb.state === 'respawn' || rb.hp <= 0) continue;
          const dx = rb.x - player.x, dy = rb.y - player.y;
          if (dx*dx + dy*dy <= CONTACT2 * 1.05){ inCombat = true; break; }
        }
      }
    }
    applyChatCombatFade(false);

    updateHud();

    draw();
    requestAnimationFrame(loop);
  }

  function spawnTrees(){
    trees.length = 0;

    const MIN_TREE_DIST = TREE_SIZE * 0.75;
    const MAX_TRIES_PER_TREE = 80;

    function pickPosOutside(){
      let x, y;
      const side = Math.floor(Math.random()*4); // 0~3

      if (side === 0) { // ìœ„
        x = rand(-OUT_MARGIN, MAP_W + OUT_MARGIN);
        y = rand(-OUT_MARGIN, -20);
      } else if (side === 1) { // ì•„ë˜
        x = rand(-OUT_MARGIN, MAP_W + OUT_MARGIN);
        y = rand(MAP_H + 20, MAP_H + OUT_MARGIN);
      } else if (side === 2) { // ì™¼ìª½
        x = rand(-OUT_MARGIN, -20);
        y = rand(-OUT_MARGIN, MAP_H + OUT_MARGIN);
      } else { // ì˜¤ë¥¸ìª½
        x = rand(MAP_W + 20, MAP_W + OUT_MARGIN);
        y = rand(-OUT_MARGIN, MAP_H + OUT_MARGIN);
      }
      return {x, y};
    }

    function isFarEnough(x, y){
      for (const t of trees){
        const dx = x - t.x, dy = y - t.y;
        if (dx*dx + dy*dy < MIN_TREE_DIST*MIN_TREE_DIST) return false;
      }
      return true;
    }

    for (let i=0;i<TREES_N;i++){
      let placed = false;

      for (let tries=0; tries<MAX_TRIES_PER_TREE; tries++){
        const p = pickPosOutside();
        if (isFarEnough(p.x, p.y)){
          trees.push(p);
          placed = true;
          break;
        }
      }
      if (!placed) trees.push(pickPosOutside());
    }
  }

  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const {camX, camY, vw, vh} = camera();

    drawGrass(camX, camY, vw, vh);

    // âœ… ë§µ êµ¬ë¶„ìš© ì‚´ì§ í†¤(ì†ì‚­ì„ ìˆ²ì†=ì¡°ê¸ˆ ì–´ë‘¡ê²Œ / ê³ ìš”í•œ ë“¤íŒ=ì¡°ê¸ˆ ë°ê²Œ)
    ctx.save();
    if (grassTint === "forest"){
      ctx.globalAlpha = 0.10;
      ctx.fillStyle = "rgba(0,0,0,1)";
      ctx.fillRect(0,0,canvas.width,canvas.height);
    }else{
      ctx.globalAlpha = 0.08;
      ctx.fillStyle = "rgba(255,255,255,1)";
      ctx.fillRect(0,0,canvas.width,canvas.height);
    }
    ctx.restore();
    drawPortal(ACTIVE_PORTAL, camX, camY);

    ctx.save();
    ctx.globalAlpha = 0.5;
    ctx.lineWidth = 2;
    ctx.strokeStyle = "#7CFC00";
    const radius = 24; // ëª¨ì„œë¦¬ ë‘¥ê¸€ê¸°
    ctx.beginPath();
    ctx.roundRect(-camX, -camY, MAP_W, MAP_H, radius);
    ctx.stroke();
    ctx.restore();

    const drawList = [];
    for (const rb of rabbits) drawList.push({y: rb.y, type:'rb', ref: rb});
        for (const c of cats) drawList.push({y: c.y, type:'cat', ref: c});
drawList.push({y: player.y, type:'pl', ref: player});
    drawList.sort((a,b)=>a.y-b.y);

    for (const it of drawList){
      if (it.type === 'rb') drawRabbit(it.ref, camX, camY);
      else if (it.type === 'cat') drawCat(it.ref, camX, camY);
      else drawPlayer(camX, camY);
    }

    drawParticles(camX, camY);
    drawDmgTexts(camX, camY);
    drawCritTexts(camX, camY);
    drawWordTexts(camX, camY);
    drawTrees(camX, camY);
    drawLevelUpFx(camX, camY);

    // âœ… ìë™ì‚¬ëƒ¥ ì¤‘ í¬íƒˆ ë°Ÿì„ ë•Œ ê²½ê³  ë¬¸êµ¬(ì¼ë°˜ ë¬¸êµ¬ - íš¨ê³¼ ì—†ìŒ, í™”ë©´ ìƒë‹¨ 'ë§µ ì•ˆìª½' ê³ ì •)
    if (portalBlockMsgT > 0){
      // âœ… í™”ë©´(=í˜„ì¬ ì¹´ë©”ë¼ ë·°) ìƒë‹¨ì—ì„œ 'ì¡°ê¸ˆ ì•„ë˜'ì— ê³ ì • í‘œì‹œ (í”Œë ˆì´ì–´ ë”°ë¼ë‹¤ë‹ˆì§€ ì•ŠìŒ)
      // ì´ ê²Œì„ì€ ì›”ë“œ ë Œë”ë§ì„ (x-camX) ë°©ì‹ìœ¼ë¡œ ê·¸ë¦¬ê¸° ë•Œë¬¸ì—,
      // UI í…ìŠ¤íŠ¸ëŠ” 'í™”ë©´ ì¢Œí‘œ'ë¡œ ì°ì–´ì•¼ ì‹¤ì œë¡œ ë³´ì…ë‹ˆë‹¤.
      const viewW = canvas.width / DPR;
      const viewH = canvas.height / DPR;
      const msgX = viewW/2;
      const msgY = Math.max(70, Math.min(130, viewH*0.14));
ctx.save();
      ctx.font = "700 18px system-ui, -apple-system, Segoe UI, Roboto, sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "top";
      ctx.fillStyle = "rgb(255, 60, 60)";
      ctx.shadowColor = "rgba(0,0,0,0.55)";
      ctx.shadowBlur = 6;
      ctx.fillText("ìë™ì‚¬ëƒ¥ì‹œ í¬íƒˆ ì´ë™ ê¸ˆì§€", msgX, msgY);
      ctx.restore();
    }

  }

  // ====== START BUTTON: overlay hide + fullscreen + game start ======
  async function goFullscreen(){
    try{
      // ëª¨ë°”ì¼/ë°ìŠ¤í¬íƒ‘ ëª¨ë‘ ëŒ€ì‘
      if (!document.fullscreenElement){
        await document.documentElement.requestFullscreen({ navigationUI: "hide" }).catch(()=>{});
      }
    }catch(e){}
  }

  startBtn.disabled = true;
  startHint.textContent = "ë¦¬ì†ŒìŠ¤ ë¡œë”© ì¤‘... (hero/grass/rabbit/tree)";

  startBtn.addEventListener('click', async () => {
    // âœ… ëŒ€í‘œë‹˜ ìš”ì²­: ì‹œì‘ ì‹œ "ë§ˆì§€ë§‰ ë§µ"ì€ startGame ì „ì— ë¯¸ë¦¬ ê²°ì •í•˜ê³ ,
// ë ˆë²¨/ìŠ¤íƒ¯/ì•„ì´í…œ ë“± "í”Œë ˆì´ì–´ ì§„í–‰ë„"ëŠ” startGame(í”Œë ˆì´ì–´ ìƒì„±) ì´í›„ì— ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
// (ì´ë ‡ê²Œ í•´ì•¼ startGame ë‚´ë¶€ì˜ ê¸°ë³¸ê°’(ë ˆë²¨1 ë“±)ì´ ë¡œë“œê°’ì„ ë‹¤ì‹œ ë®ì–´ì“°ì§€ ì•ŠìŠµë‹ˆë‹¤)
let __savedMapId = null;
try{
  const __raw = localStorage.getItem(SAVE_KEY);
  if (__raw){
    const __data = JSON.parse(__raw);
    // ì„œëª…(sig) ê²€ì¦(ìˆìœ¼ë©´) â€” ì¡°ì‘/í˜¸í™˜ ë¬¸ì œ ë°©ì§€
    if (__data && typeof __data === "object" && typeof __data.sig === "string"){
      if (typeof verifySaveSignature === "function" && !verifySaveSignature(__data)){
        console.warn("Save signature mismatch. Possible tampering.");
      } else {
        __savedMapId = (__data.mapId === "forest" || __data.mapId === "field") ? __data.mapId : null;
      }
    } else {
      // êµ¬ì„¸ì´ë¸Œ(ì„œëª… ì—†ìŒ) â€” ë§µë§Œì€ ì¼ë‹¨ ì ìš©
      __savedMapId = (__data && (__data.mapId === "forest" || __data.mapId === "field")) ? __data.mapId : null;
    }
  }
}catch(e){}

if (__savedMapId){
  try{
    // startGameì´ ì°¸ì¡°í•˜ëŠ” ë§µ ë³€ìˆ˜/ì „ì—­ì„ ë¯¸ë¦¬ ë§ì¶°ë‘ 
    if (typeof currentMapId !== "undefined") currentMapId = __savedMapId;
    window.currentMapId = __savedMapId;
    if (typeof window.currentMap !== "undefined") window.currentMap = __savedMapId;
  }catch(e){}
}

    
    // âœ… SFX ì–¸ë½(ëª¨ë°”ì¼ì—ì„œ ë ˆë²¨ì—…/ê¸°í•© ë“±ì´ ë¬´ìŒìœ¼ë¡œ ë§‰íˆëŠ” ê²½ìš° ë°©ì§€)
    // - ì‚¬ìš©ì í´ë¦­ ì´ë²¤íŠ¸(ì§€ê¸ˆ ì´ ìˆœê°„) ì•ˆì—ì„œ ì•„ì£¼ ì§§ê²Œ playâ†’pause í•´ì„œ ì˜¤ë””ì˜¤ë¥¼ "í™œì„±í™”"í•©ë‹ˆë‹¤.
    function __unlockAudio(a){
      try{
        if(!a) return;
        const wasMuted = a.muted;
        a.muted = true;
        const p = a.play();
        if(p && typeof p.then === "function"){
          p.then(()=>{ try{ a.pause(); a.currentTime = 0; }catch(_){ } a.muted = wasMuted; })
           .catch(()=>{ a.muted = wasMuted; });
        }else{
          try{ a.pause(); a.currentTime = 0; }catch(_){}
          a.muted = wasMuted;
        }
      }catch(_){}
    }
    try{
      __unlockAudio(attackSfx);
      __unlockAudio(kihapSfx);
      __unlockAudio(hitSfx);
      __unlockAudio(critSfx);
      __unlockAudio(rabbitDeathSfx);
      __unlockAudio(deathSfx);
      __unlockAudio(footstep);
      __unlockAudio(levelUpSound);
    }catch(_){}
// âœ… BGM ì‹œì‘ (ëª¨ë°”ì¼/PC ì‚¬ìš©ì í´ë¦­ ì´ë²¤íŠ¸ ë‚´)
    try{
      bgm.currentTime = 0;
      bgm.play().catch(()=>{});
}catch(e){}

    // 1) ì „ì²´í™”ë©´ ì‹œë„
    await goFullscreen();

    // 2) ë°”ë¡œ ë¦¬ì‚¬ì´ì¦ˆ (ì£¼ì†Œì°½/ì•ˆì „ì˜ì—­ ë³€í™” ëŒ€ì‘)
    setTimeout(resize, 50);
    setTimeout(resize, 250);

    // 3) íƒ€ì´í‹€ í™”ë©´ ì œê±°
    overlay.style.display = "none";
    applyChatCombatFade(false);

    // 4) ë¡œë”©ì´ ëë‚¬ìœ¼ë©´ ì‹œì‘, ì•„ë‹ˆë©´ ë¡œë”© ì™„ë£Œ ì¦‰ì‹œ ì‹œì‘
    if (assetsReady){
      window.__SAVE_SUSPENDED = true;
      startGame();
      // âœ… startGameì´ ê¸°ë³¸ê°’ì„ ì„¸íŒ…í•œ ë’¤, ë¡œì»¬ ì„¸ì´ë¸Œë¥¼ ì ìš© (ë ˆë²¨/ìŠ¤íƒ¯/ì•„ì´í…œ/ë§ˆì§€ë§‰ ë§µ)
      try{
        if (typeof loadFromLocal === "function") loadFromLocal();
        try{ if (typeof window.ensureStartWeaponEnhanceScroll === 'function') window.ensureStartWeaponEnhanceScroll(); }catch(e){}
if (typeof applyPlayerStatsForLevel === "function") applyPlayerStatsForLevel();
        if (typeof recalcCombatStats === "function") recalcCombatStats();
      }catch(e){
                console.warn("Auto-load after startGame failed:", e);
      }
      // âœ… ë¡œë“œê°€ ëë‚˜ë©´ ì„¸ì´ë¸Œë¥¼ ë‹¤ì‹œ í™œì„±í™”(ì´ˆê¸°í™” ë®ì–´ì“°ê¸° ë°©ì§€)
      window.__SAVE_SUSPENDED = false;
      try{ if (typeof saveToLocal === "function") saveToLocal(); }catch(_){ }
          try{ if(!window.__mapNameShown){ window.__mapNameShown=true; setTimeout(()=>{ try{ window.showMapName && window.showMapName(mapTitleFor(window.currentMapId || currentMapId)); }catch(e){} }, 180); } }catch(e){}} else {
      startHint.textContent = "ë¡œë”©ì´ ëë‚˜ë©´ ìë™ìœ¼ë¡œ ì‹œì‘ë©ë‹ˆë‹¤...";
      const wait = setInterval(() => {
        if (assetsReady){
          clearInterval(wait);
          window.__SAVE_SUSPENDED = true;
          startGame();
      // âœ… startGameì´ ê¸°ë³¸ê°’ì„ ì„¸íŒ…í•œ ë’¤, ë¡œì»¬ ì„¸ì´ë¸Œë¥¼ ì ìš© (ë ˆë²¨/ìŠ¤íƒ¯/ì•„ì´í…œ/ë§ˆì§€ë§‰ ë§µ)
      try{
        if (typeof loadFromLocal === "function") loadFromLocal();
        try{ if (typeof window.ensureStartWeaponEnhanceScroll === 'function') window.ensureStartWeaponEnhanceScroll(); }catch(e){}
if (typeof applyPlayerStatsForLevel === "function") applyPlayerStatsForLevel();
        if (typeof recalcCombatStats === "function") recalcCombatStats();
      }catch(e){
                console.warn("Auto-load after startGame failed:", e);
      }
      // âœ… ë¡œë“œê°€ ëë‚˜ë©´ ì„¸ì´ë¸Œë¥¼ ë‹¤ì‹œ í™œì„±í™”(ì´ˆê¸°í™” ë®ì–´ì“°ê¸° ë°©ì§€)
      window.__SAVE_SUSPENDED = false;
      try{ if (typeof saveToLocal === "function") saveToLocal(); }catch(_){ }
          try{ if(!window.__mapNameShown){ window.__mapNameShown=true; setTimeout(()=>{ try{ window.showMapName && window.showMapName(mapTitleFor(window.currentMapId || currentMapId)); }catch(e){} }, 180); } }catch(e){}}
      }, 60);
    }
  }, {passive:true});

  // ESCë¡œ ì „ì²´í™”ë©´ì´ í’€ë ¤ë„ ê²Œì„ì€ ê³„ì† (ì›í•˜ë©´ ì—¬ê¸°ì„œ ì²˜ë¦¬ ê°€ëŠ¥)
})();

  
  // ====== TWITCH CHAT HUD ======
  // â€» file:// ë¡œ ì§ì ‘ ì—´ë©´ Twitchê°€ parent íŒŒë¼ë¯¸í„° ë•Œë¬¸ì— ì°¨ë‹¨ë  ìˆ˜ ìˆì–´ìš”.
  //    GitHub Pages/ì„œë²„ì—ì„œ ì—´ë©´ ì •ìƒ ë™ì‘í•©ë‹ˆë‹¤.
  const TWITCH_CHANNEL = "lastkan1111"; // âœ… ì—¬ê¸° ì±„ë„ëª…ë§Œ ë°”ê¾¸ë©´ ë©ë‹ˆë‹¤.

  function initTwitchChat(){
    const frame = document.getElementById('twChatFrame');
    if (!frame) return;

    const parents = [];
    const h = location.hostname;

    if (h) parents.push(h);
    // ë¡œì»¬ ê°œë°œ ë³´ê°• (file:// ë¡œ ì—´ë©´ í˜¸ìŠ¤íŠ¸ê°€ ë¹„ì–´ CSPì— ê±¸ë¦½ë‹ˆë‹¤)
    parents.push('localhost', '127.0.0.1');

    const parentParams = parents
      .filter((v,i,a)=>v && a.indexOf(v)===i)
      .map(p => `parent=${encodeURIComponent(p)}`)
      .join('&');

    frame.src = `https://www.twitch.tv/embed/${encodeURIComponent(TWITCH_CHANNEL)}/chat?${parentParams}&darkpopout`;
  }


// ====== TWITCH CHAT HUD RESIZE (drag the corner) ======
(function enableChatResize(){
  const hud = document.getElementById('twChatHud');
  const handle = document.getElementById('twResizeHandle');
  if (!hud || !handle) return;

  const KEY_W = 'twChatHud_w';
  const KEY_H = 'twChatHud_h';

  const clamp = (v,a,b)=>Math.max(a, Math.min(b, v));

  function applySize(w, h){
    const maxW = Math.min(520, window.innerWidth - 24);
    const maxH = Math.min(820, window.innerHeight - 24);
    const minW = 160;
    const minH = 220;

    const ww = clamp(Math.round(w), minW, maxW);
    const hh = clamp(Math.round(h), minH, maxH);

    hud.style.width  = ww + 'px';
    hud.style.height = hh + 'px';

    try{
      localStorage.setItem(KEY_W, String(ww));
      localStorage.setItem(KEY_H, String(hh));
    }catch(_){}
  }

  // Load saved size (if any)
  try{
    const sw = parseInt(localStorage.getItem(KEY_W) || '', 10);
    const sh = parseInt(localStorage.getItem(KEY_H) || '', 10);
    if (Number.isFinite(sw) && Number.isFinite(sh)) applySize(sw, sh);
  }catch(_){}

  // Keep size valid on rotate/resize
  window.addEventListener('resize', () => {
    const rect = hud.getBoundingClientRect();
    applySize(rect.width, rect.height);
  }, {passive:true});

  let dragging = false;
  let pid = null;
  let startX = 0, startY = 0, startW = 0, startH = 0;

  handle.addEventListener('pointerdown', (e) => {
    if (e.button != null && e.button !== 0) return; // left click only
    dragging = true;
    pid = e.pointerId;
    startX = e.clientX;
    startY = e.clientY;
    const rect = hud.getBoundingClientRect();
    startW = rect.width;
    startH = rect.height;

    try{ handle.setPointerCapture(pid); }catch(_){}
    e.preventDefault();
    e.stopPropagation();
  }, {passive:false});

  handle.addEventListener('pointermove', (e) => {
    if (!dragging || e.pointerId !== pid) return;
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;
   applySize(startW + dx, startH - dy);
    e.preventDefault();
    e.stopPropagation();
  }, {passive:false});

  function end(e){
    if (!dragging) return;
    if (pid != null && e.pointerId !== pid) return;
    dragging = false;
    pid = null;
    e.preventDefault();
    e.stopPropagation();
  }
  window.addEventListener('pointerup', end, {passive:false});
  window.addEventListener('pointercancel', end, {passive:false});

  // Double click/tap handle to reset to default size
  handle.addEventListener('dblclick', (e) => {
    applySize(220, 360);
    e.preventDefault();
    e.stopPropagation();
  });


// ====== CHAT TOGGLE (fold/unfold with scale+fade) ======
(function enableChatToggle(){
  const hud = document.getElementById('twChatHud');
  const btn = document.getElementById('chatToggleBtn');
  if (!hud || !btn) return;

  const KEY = 'twChatHud_collapsed';

  function setCollapsed(collapsed){
    hud.classList.toggle('collapsed', !!collapsed);
    btn.setAttribute('aria-pressed', String(!collapsed));
    btn.textContent = collapsed ? 'ì±„íŒ… ì—´ê¸°' : 'ì±„íŒ… ì ‘ê¸°';
    try{ localStorage.setItem(KEY, collapsed ? '1' : '0'); }catch(_){}
  }

  // load saved state
  try{
    const saved = localStorage.getItem(KEY);
    if (saved === '1') setCollapsed(true);
  }catch(_){}

  // click toggles
  btn.addEventListener('click', (e) => {
    const nowCollapsed = !hud.classList.contains('collapsed');
    setCollapsed(nowCollapsed);
    e.preventDefault();
    e.stopPropagation(); // âœ… ì¡°ì´ìŠ¤í‹±/ìº”ë²„ìŠ¤ ì…ë ¥ìœ¼ë¡œ ì•ˆë„˜ê¹€
  }, {passive:false});

  // ensure button always above, even if fullscreen changes
  document.addEventListener('fullscreenchange', () => {
    btn.style.zIndex = '12000';
  }, {passive:true});
})();

})();

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initTwitchChat);
  } else {
    initTwitchChat();
  }


function updateHud(){
  const hpFill=document.getElementById('hpFill');
  const mpFill=document.getElementById('mpFill');
  const hpText=document.getElementById('hpText');
  const mpText=document.getElementById('mpText');
    const expFill=document.getElementById('expFill');
  const expText=document.getElementById('expText');
if(!hpFill||!mpFill||!hpText||!mpText||!window.player) return;
  const player = window.player;
  const hpR=player.hpMax?player.hp/player.hpMax:0;
  const mpR=player.mpMax?player.mp/player.mpMax:0;
  hpFill.style.transform=`scaleX(${Math.max(0,Math.min(1,hpR))})`;
  mpFill.style.transform=`scaleX(${Math.max(0,Math.min(1,mpR))})`;
  hpText.textContent=`${player.hp}/${player.hpMax}`;
  mpText.textContent=`${player.mp}/${player.mpMax}`;

  if(expFill && expText){
    const expR=player.expMax?player.exp/player.expMax:0;
    expFill.style.transform=`scaleX(${Math.max(0,Math.min(1,expR))})`;
    expText.textContent=`${player.exp}/${player.expMax}`;
  }}

</script>
  <audio id="statBtnSound" src="bb.ogg"></audio>
  <audio id="invBtnSound" src="ch.ogg"></audio>
  <audio id="equipSound" src="jangkuy.ogg"></audio>
  <audio id="statPlusSound" src="coh.ogg"></audio>
</body>
</html>
